<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒç ”æ•°å­¦ä¸€æ¨¡æ‹Ÿè¯•å·</title>

    <!-- è‡ªåŠ¨é‡å®šå‘åˆ°ä¸»é¡µé¢çš„æ¨¡æ‹Ÿè€ƒè¯•è§†å›¾ -->
    <script>
        window.location.href = 'è€ƒç ”æ•°å­¦å­¦ä¹ åŠ©æ‰‹.html#exam';
    </script>

    <!-- MathJaxé…ç½® -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

    <!-- å¤–éƒ¨æ ·å¼è¡¨ -->
    <link rel="stylesheet" href="css/exam.css">
</head>
<body class="exam-page">
    <div class="exam-header">
        <div>
            <h1>è€ƒç ”æ•°å­¦ä¸€æ¨¡æ‹Ÿè¯•å· <span class="mode-indicator" id="examModeIndicator">å³æ—¶æ‰¹æ”¹æ¨¡å¼</span></h1>
        </div>
        <div class="header-controls">
            <div class="timer" id="examTimer">00:00:00</div>
            <button class="batch-refresh-btn" id="examBatchRefreshBtn" title="ä¸€é”®æ›´æ¢æ‰€æœ‰é¢˜ç›®">
                ğŸ”„ æ¢ä¸€å¥—é¢˜
            </button>
            <button class="settings-btn" id="apiSettingsBtn">
                âš™ï¸ AIè®¾ç½®<span class="api-status inactive" id="apiStatus">æœªé…ç½®</span>
            </button>
            <button class="mode-switch" id="examModeSwitch">åˆ‡æ¢åˆ°æäº¤åæ‰¹æ”¹</button>
        </div>
    </div>

    <div class="exam-container">
        <div class="main-content" id="examQuestionsContainer">
            <!-- é¢˜ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="exam-sidebar">
            <h3>ç­”é¢˜å¡</h3>
            <div class="answer-card" id="examAnswerCard">
                <!-- ç­”é¢˜å¡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="stats">
                <div class="stat-item">
                    <span>å·²ç­”é¢˜æ•°ï¼š</span>
                    <span id="examAnsweredCount">0/23</span>
                </div>
                <div class="stat-item">
                    <span>æ€»åˆ†ï¼š</span>
                    <span>150åˆ†</span>
                </div>
                <div class="stat-item" id="examScoreItem" style="display: none;">
                    <span>å¾—åˆ†ï¼š</span>
                    <span id="examFinalScore" style="color: #4CAF50; font-weight: bold;">--</span>
                </div>
            </div>
        </div>
    </div>

    <div class="exam-footer">
        <button class="reset-btn" id="examResetBtn">é‡æ–°å¼€å§‹</button>
        <div class="score-display" id="examScoreDisplay"></div>
        <button class="submit-btn" id="examSubmitBtn">æäº¤è¯•å·</button>
    </div>

    <!-- APIé…ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <div class="modal-header">AIæ¨¡å‹é…ç½®ï¼ˆåªè¯»ï¼‰</div>

            <!-- æç¤ºä¿¡æ¯ -->
            <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
                <strong style="color: #e65100;">æç¤ºï¼š</strong>
                <span style="color: #666;">AIé…ç½®å·²é›†ä¸­åˆ°ä¸»é¡µé¢ç®¡ç†ï¼Œè¯·å‰å¾€ã€Œè€ƒç ”æ•°å­¦å­¦ä¹ åŠ©æ‰‹ã€çš„è®¾ç½®é¡µé¢è¿›è¡Œé…ç½®ã€‚</span>
            </div>

            <!-- å‚å•†é€‰æ‹© -->
            <div class="input-group">
                <label for="apiProvider">å½“å‰AIå‚å•†:</label>
                <select id="apiProvider" disabled style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px; background: #f5f5f5;">
                    <option value="claude">Claude (Anthropic)</option>
                    <option value="deepseek">Deepseek</option>
                    <option value="zhipu">æ™ºè°±AI (GLM)</option>
                    <option value="openai">å…¶ä»–OpenAIå…¼å®¹API</option>
                </select>
            </div>

            <!-- API Keyè¾“å…¥ -->
            <div class="input-group">
                <label for="apiKeyInput">API Key:</label>
                <input type="password" id="apiKeyInput" disabled placeholder="æœªé…ç½®" style="background: #f5f5f5;">
            </div>

            <!-- Base URLé…ç½® -->
            <div class="input-group">
                <label for="apiBaseUrl">API Base URL:</label>
                <input type="text" id="apiBaseUrl" disabled placeholder="æœªé…ç½®" style="background: #f5f5f5;">
            </div>

            <!-- æ¨¡å‹é€‰æ‹© -->
            <div class="input-group">
                <label for="apiModel">å½“å‰æ¨¡å‹:</label>
                <select id="apiModel" disabled style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px; background: #f5f5f5;">
                    <!-- åŠ¨æ€åŠ è½½æ¨¡å‹åˆ—è¡¨ -->
                </select>
            </div>

            <!-- è‡ªå®šä¹‰æ¨¡å‹ID (ä»…OpenAIå…¼å®¹æ—¶æ˜¾ç¤º) -->
            <div class="input-group" id="customModelGroup" style="display: none;">
                <label for="customModelId">è‡ªå®šä¹‰æ¨¡å‹ID:</label>
                <input type="text" id="customModelId" disabled placeholder="æœªé…ç½®" style="background: #f5f5f5;">
            </div>

            <!-- æµ‹è¯•è¿æ¥ -->
            <button class="test-connection-btn" id="testConnectionBtn">æµ‹è¯•è¿æ¥</button>
            <div id="connectionStatus"></div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancelApiBtn">å…³é—­</button>
                <button class="modal-btn modal-btn-primary" onclick="window.location.href='è€ƒç ”æ•°å­¦å­¦ä¹ åŠ©æ‰‹.html'">å‰å¾€ä¸»é¡µé…ç½®</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ¢é¢˜è¿›åº¦æ¨¡æ€æ¡† -->
    <div class="batch-progress-modal" id="batchProgressModal">
        <div class="batch-progress-content">
            <div class="batch-progress-header">
                <span>ğŸ”„</span>
                <span>ä¸€é”®æ¢é¢˜</span>
            </div>
            <div class="batch-progress-bar-container">
                <div class="batch-progress-bar" id="batchProgressBar"></div>
            </div>
            <div class="batch-progress-text" id="batchProgressText">æ­£åœ¨ç”Ÿæˆæ–°é¢˜ç›®...</div>
            <div class="batch-progress-status" id="batchProgressStatus">å‡†å¤‡ä¸­...</div>
            <div class="batch-progress-buttons">
                <button class="batch-cancel-btn" id="batchCancelBtn">å–æ¶ˆæ¢é¢˜</button>
                <button class="batch-close-btn" id="batchCloseBtn">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- å¤–éƒ¨JavaScriptæ¨¡å— -->
    <script src="js/ai-adapter.js"></script>
    <script src="js/exam-module.js"></script>

    <script>
        // é¡µé¢åˆå§‹åŒ–
        window.onload = function() {
            // åŠ è½½AIé…ç½®
            loadExamAPIConfig();

            // åˆå§‹åŒ–è€ƒè¯•æ¨¡å—
            initExamModule();

            // ç»‘å®šAPIè®¾ç½®ç›¸å…³äº‹ä»¶
            document.getElementById('apiSettingsBtn').addEventListener('click', () => {
                document.getElementById('apiModal').classList.add('show');
            });

            document.getElementById('cancelApiBtn').addEventListener('click', () => {
                document.getElementById('apiModal').classList.remove('show');
            });

            document.getElementById('testConnectionBtn').addEventListener('click', testExamAPIConnection);

            // æ‰¹é‡æ¢é¢˜æ¨¡æ€æ¡†äº‹ä»¶
            document.getElementById('batchCancelBtn').addEventListener('click', () => {
                examBatchRefreshCancelled = true;
            });

            document.getElementById('batchCloseBtn').addEventListener('click', () => {
                document.getElementById('batchProgressModal').classList.remove('show');
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('apiModal').addEventListener('click', (e) => {
                if (e.target.id === 'apiModal') {
                    document.getElementById('apiModal').classList.remove('show');
                }
            });
        };

        // åŠ è½½APIé…ç½®ï¼ˆä»ä¸»é¡µé¢ç»Ÿä¸€é…ç½®è¯»å–ï¼‰
        function loadExamAPIConfig() {
            let provider = null;
            let key = null;
            let baseUrl = null;
            let modelId = null;

            // ä¼˜å…ˆä»ä¸»é¡µé¢çš„ç»Ÿä¸€é…ç½®è¯»å–
            try {
                const globalConfig = localStorage.getItem('mathHelper_aiConfig');
                if (globalConfig) {
                    const config = JSON.parse(globalConfig);
                    provider = config.provider;
                    key = config.apiKey;
                    baseUrl = config.baseUrl;
                    modelId = config.modelId;
                }
            } catch (e) {
                console.warn('è¯»å–ä¸»é¡µé¢é…ç½®å¤±è´¥:', e);
            }

            // å›é€€åˆ°æ—§é…ç½®
            if (!provider) {
                provider = localStorage.getItem('aiProvider') || 'claude';
                key = localStorage.getItem('aiApiKey') || localStorage.getItem('claudeApiKey');
                baseUrl = localStorage.getItem('aiBaseUrl') || localStorage.getItem('claudeApiBaseUrl');
                modelId = localStorage.getItem('aiModel') || localStorage.getItem('claudeApiModel');
            }

            // æ›´æ–°UIæ˜¾ç¤º
            document.getElementById('apiProvider').value = provider || 'claude';
            if (key) {
                document.getElementById('apiKeyInput').value = key;
            }
            if (baseUrl) {
                document.getElementById('apiBaseUrl').value = baseUrl;
            }

            // æ›´æ–°APIçŠ¶æ€æŒ‡ç¤º
            updateExamAPIStatus(!!key);
        }

        // æ›´æ–°APIçŠ¶æ€æ˜¾ç¤º
        function updateExamAPIStatus(configured) {
            const statusSpan = document.getElementById('apiStatus');
            if (configured) {
                statusSpan.textContent = 'å·²é…ç½®';
                statusSpan.className = 'api-status active';
            } else {
                statusSpan.textContent = 'æœªé…ç½®';
                statusSpan.className = 'api-status inactive';
            }
        }

        // æµ‹è¯•APIè¿æ¥
        async function testExamAPIConnection() {
            const btn = document.getElementById('testConnectionBtn');
            const statusDiv = document.getElementById('connectionStatus');

            if (!isAIConfigured()) {
                statusDiv.innerHTML = '<div class="connection-status error">è¯·å…ˆåœ¨ä¸»é¡µé¢é…ç½®AI</div>';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';
            statusDiv.innerHTML = '';

            try {
                await callAI([{ role: 'user', content: 'æµ‹è¯•è¿æ¥' }], { maxTokens: 10 });
                statusDiv.innerHTML = '<div class="connection-status success">âœ“ è¿æ¥æˆåŠŸ!</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="connection-status error">âœ— è¿æ¥å¤±è´¥: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'æµ‹è¯•è¿æ¥';
            }
        }

        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', saveExamToStorage);
    </script>
</body>
</html>
