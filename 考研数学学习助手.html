<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒç ”æ•°å­¦å­¦ä¹ åŠ©æ‰‹</title>

    <!-- MathJaxé…ç½® -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

    <!-- Chart.jså›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>

    <!-- Cal-Heatmapçƒ­åŠ›å›¾åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.4/dist/cal-heatmap.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.4/dist/cal-heatmap.css">

    <!-- å¤–éƒ¨æ ·å¼è¡¨ -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- æ–°æ‰‹å¼•å¯¼é®ç½©å±‚ -->
    <div id="onboarding-overlay" class="onboarding-overlay" style="display: none;">
        <div class="onboarding-modal">
            <div class="onboarding-header">
                <span class="onboarding-icon">ğŸ“</span>
                <h2>æ¬¢è¿ä½¿ç”¨è€ƒç ”æ•°å­¦å­¦ä¹ åŠ©æ‰‹</h2>
            </div>
            <div class="onboarding-content">
                <p class="onboarding-intro">è¿™æ˜¯ä¸€ä¸ªä¸“ä¸ºè€ƒç ”æ•°å­¦ä¸€è®¾è®¡çš„å­¦ä¹ å¹³å°ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹å„é¡¹åŠŸèƒ½ï¼š</p>
                <div class="onboarding-features">
                    <div class="onboarding-feature">
                        <span class="feature-icon">ğŸ“š</span>
                        <div class="feature-info">
                            <strong>çŸ¥è¯†ç‚¹å­¦ä¹ </strong>
                            <p>50+æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼ŒAIè¯¦è§£ï¼Œäº’åŠ¨æé—®</p>
                        </div>
                    </div>
                    <div class="onboarding-feature">
                        <span class="feature-icon">ğŸ“…</span>
                        <div class="feature-info">
                            <strong>å­¦ä¹ è§„åˆ’</strong>
                            <p>ä¸‰é˜¶æ®µè®¡åˆ’ï¼ŒAIæ™ºèƒ½è°ƒæ•´ï¼Œæ¯æ—¥ä»»åŠ¡</p>
                        </div>
                    </div>
                    <div class="onboarding-feature">
                        <span class="feature-icon">âœï¸</span>
                        <div class="feature-info">
                            <strong>ç»ƒä¹ æµ‹è¯•</strong>
                            <p>ä¸“é¡¹ç»ƒä¹ ï¼Œæ¨¡æ‹Ÿè€ƒè¯•ï¼Œé”™é¢˜ç®¡ç†</p>
                        </div>
                    </div>
                    <div class="onboarding-feature">
                        <span class="feature-icon">ğŸ¤–</span>
                        <div class="feature-info">
                            <strong>AIåŠ©æ•™</strong>
                            <p>å®æ—¶ç­”ç–‘ï¼Œå¤šè½®å¯¹è¯ï¼Œå…¬å¼æ”¯æŒ</p>
                        </div>
                    </div>
                </div>
                <div class="onboarding-tip">
                    <span class="tip-icon">ğŸ’¡</span>
                    <span>ä½¿ç”¨AIåŠŸèƒ½å‰éœ€è¦å…ˆé…ç½®APIå¯†é’¥</span>
                </div>
            </div>
            <div class="onboarding-footer">
                <label class="onboarding-checkbox">
                    <input type="checkbox" id="dontShowAgain">
                    <span>ä¸å†æ˜¾ç¤ºæ­¤æ¬¢è¿é¡µ</span>
                </label>
                <div class="onboarding-buttons">
                    <button class="btn btn-secondary" onclick="goToAISettings()">é…ç½®AI</button>
                    <button class="btn btn-primary" onclick="closeOnboarding()">å¼€å§‹ä½¿ç”¨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AIé…ç½®æç¤ºæ¡ -->
    <div id="ai-config-banner" class="ai-config-banner" style="display: none;">
        <div class="banner-content">
            <span class="banner-icon">âš ï¸</span>
            <span class="banner-text">AIåŠŸèƒ½æœªé…ç½®ï¼Œéƒ¨åˆ†åŠŸèƒ½ä¸å¯ç”¨</span>
            <button class="btn btn-primary btn-sm" onclick="goToAISettings()">ç«‹å³é…ç½®</button>
            <button class="banner-close" onclick="hideAIBanner()">&times;</button>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="app-container">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <nav class="sidebar">
            <div class="logo">
                <div class="logo-icon">ğŸ“š</div>
                è€ƒç ”æ•°å­¦åŠ©æ‰‹
            </div>
            <ul class="nav-menu">
                <li class="active" data-view="dashboard">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span>é¦–é¡µ</span>
                </li>
                <li data-view="plan">
                    <span class="nav-icon">ğŸ“…</span>
                    <span>å­¦ä¹ è§„åˆ’</span>
                </li>
                <li data-view="knowledge">
                    <span class="nav-icon">ğŸ“š</span>
                    <span>çŸ¥è¯†ç‚¹å­¦ä¹ </span>
                </li>
                <li data-view="practice">
                    <span class="nav-icon">âœï¸</span>
                    <span>ç»ƒä¹ æµ‹è¯•</span>
                </li>
                <li data-view="ai-tutor">
                    <span class="nav-icon">ğŸ¤–</span>
                    <span>AIåŠ©æ•™</span>
                </li>
                <li data-view="statistics">
                    <span class="nav-icon">ğŸ“ˆ</span>
                    <span>å­¦ä¹ ç»Ÿè®¡</span>
                </li>
                <li data-view="settings">
                    <span class="nav-icon">âš™ï¸</span>
                    <span>è®¾ç½®</span>
                </li>
            </ul>
            <!-- AIçŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div class="ai-status-indicator" id="aiStatusIndicator" onclick="goToAISettings()">
                <span class="status-dot" id="aiStatusDot"></span>
                <span class="status-text" id="aiStatusText">AIæœªé…ç½®</span>
            </div>
        </nav>

        <!-- å³ä¾§å†…å®¹åŒº -->
        <main class="content-area">
            <div id="view-container">
                <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </main>
    </div>

    <script>
        // ========== å„è§†å›¾æ¸²æŸ“å‡½æ•° ==========

        // é¦–é¡µ/ä»ªè¡¨æ¿
        function renderDashboard() {
            const container = document.getElementById('view-container');

            // è·å–æ•°æ®
            const examDate = new Date('2026-12-23');
            const today = new Date();
            const daysLeft = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
            const dateStr = today.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

            // æ¿€åŠ±è¯­å¥
            const motivations = [
                'æ¯ä¸€é“é¢˜éƒ½æ˜¯é€šå¾€æˆåŠŸçš„é˜¶æ¢¯',
                'åšæŒå°±æ˜¯èƒœåˆ©ï¼Œä»Šå¤©ä¹Ÿè¦åŠ æ²¹ï¼',
                'åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹',
                'å­¦ä¹ æ˜¯æœ€å¥½çš„æŠ•èµ„',
                'ä»Šå¤©çš„åŠªåŠ›æ˜¯æ˜å¤©çš„æ”¶è·',
                'ç›¸ä¿¡è‡ªå·±ï¼Œä½ å¯ä»¥çš„ï¼'
            ];
            const motivation = motivations[Math.floor(Math.random() * motivations.length)];

            // è·å–å­¦ä¹ æ•°æ®
            const plan = dataManager.load('studyPlan', null);
            const progress = dataManager.load('learningProgress', {});
            const knowledgeTree = dataManager.load('knowledgeTree', getDefaultKnowledgeTree());

            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const stats = calculateDashboardStats(plan, progress, knowledgeTree);

            container.innerHTML = `
                <div class="dashboard-container">
                    <!-- æ¬¢è¿åŒºåŸŸ -->
                    <div class="welcome-section">
                        <div class="welcome-content">
                            <h2>ğŸ“ æ¬¢è¿å›æ¥ï¼</h2>
                            <div class="date-info">ğŸ“… ${dateStr}</div>
                            <div class="motivation">ğŸ’¬ "${motivation}"</div>
                        </div>
                        <div class="countdown-box">
                            <div class="countdown-number">${daysLeft}</div>
                            <div class="countdown-label">å¤©åè€ƒç ”</div>
                        </div>
                    </div>

                    <!-- ç»Ÿè®¡å¡ç‰‡ -->
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-icon blue">ğŸ“‹</div>
                            <div class="stat-info">
                                <div class="stat-value">${stats.todayTaskCount}</div>
                                <div class="stat-label">ä»Šæ—¥ä»»åŠ¡</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">âœ…</div>
                            <div class="stat-info">
                                <div class="stat-value">${stats.todayCompletionRate}%</div>
                                <div class="stat-label">ä»Šæ—¥å®Œæˆç‡</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orange">ğŸ”¥</div>
                            <div class="stat-info">
                                <div class="stat-value">${stats.streakDays}</div>
                                <div class="stat-label">è¿ç»­å­¦ä¹ å¤©æ•°</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon purple">ğŸ“š</div>
                            <div class="stat-info">
                                <div class="stat-value">${stats.completedUnits}/${stats.totalUnits}</div>
                                <div class="stat-label">çŸ¥è¯†ç‚¹è¿›åº¦</div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸»å†…å®¹åŒº -->
                    <div class="dashboard-main">
                        <!-- ä»Šæ—¥ä»»åŠ¡ -->
                        <div class="today-tasks-card">
                            <div class="card-header-row">
                                <h3>ğŸ“‹ ä»Šæ—¥å­¦ä¹ ä»»åŠ¡</h3>
                                <span class="task-progress-mini">${stats.todayCompletedTasks}/${stats.todayTaskCount} å·²å®Œæˆ</span>
                            </div>
                            <div class="dashboard-task-list" id="dashboard-task-list">
                                ${renderDashboardTasks(plan)}
                            </div>
                        </div>

                        <!-- å­¦ä¹ è¿›åº¦ä¸å¿«æ·å…¥å£ -->
                        <div class="progress-actions-card">
                            <!-- è¿›åº¦å›¾è¡¨ -->
                            <div class="progress-charts-section">
                                <h3>ğŸ“Š å­¦ä¹ è¿›åº¦</h3>
                                <div class="charts-row">
                                    <div class="chart-item">
                                        <div class="chart-wrapper">
                                            <canvas id="chart-calculus"></canvas>
                                            <div class="chart-center-text">${stats.subjectProgress.calculus}%</div>
                                        </div>
                                        <div class="chart-label">å¾®ç§¯åˆ†</div>
                                    </div>
                                    <div class="chart-item">
                                        <div class="chart-wrapper">
                                            <canvas id="chart-linear"></canvas>
                                            <div class="chart-center-text">${stats.subjectProgress.linearAlgebra}%</div>
                                        </div>
                                        <div class="chart-label">çº¿æ€§ä»£æ•°</div>
                                    </div>
                                    <div class="chart-item">
                                        <div class="chart-wrapper">
                                            <canvas id="chart-prob"></canvas>
                                            <div class="chart-center-text">${stats.subjectProgress.probability}%</div>
                                        </div>
                                        <div class="chart-label">æ¦‚ç‡è®º</div>
                                    </div>
                                </div>
                            </div>

                            <!-- å¿«æ·å…¥å£ -->
                            <div class="quick-actions-section">
                                <h3>ğŸš€ å¿«æ·å…¥å£</h3>
                                <div class="quick-actions-grid">
                                    <button class="quick-action-btn" onclick="viewManager.switchView('knowledge')">
                                        <span class="action-icon">ğŸ“–</span>
                                        <span class="action-text">ç»§ç»­å­¦ä¹ </span>
                                    </button>
                                    <button class="quick-action-btn" onclick="viewManager.switchView('practice')">
                                        <span class="action-icon">âœï¸</span>
                                        <span class="action-text">å¼€å§‹ç»ƒä¹ </span>
                                    </button>
                                    <button class="quick-action-btn" onclick="viewManager.switchView('plan')">
                                        <span class="action-icon">ğŸ“…</span>
                                        <span class="action-text">å­¦ä¹ è§„åˆ’</span>
                                    </button>
                                    <button class="quick-action-btn" onclick="viewManager.switchView('ai-tutor')">
                                        <span class="action-icon">ğŸ¤–</span>
                                        <span class="action-text">AIåŠ©æ•™</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æœ€è¿‘æ´»åŠ¨ -->
                    <div class="recent-activity-card">
                        <h3>ğŸ“ æœ€è¿‘å­¦ä¹ æ´»åŠ¨</h3>
                        <div class="activity-list" id="activity-list">
                            ${renderRecentActivity(progress)}
                        </div>
                    </div>
                </div>
            `;

            // åˆå§‹åŒ–å›¾è¡¨
            initDashboardCharts(stats.subjectProgress);
        }

        // è®¡ç®—ä»ªè¡¨æ¿ç»Ÿè®¡æ•°æ®
        function calculateDashboardStats(plan, progress, knowledgeTree) {
            // è®¡ç®—çŸ¥è¯†ç‚¹ç»Ÿè®¡
            let totalUnits = 0;
            let completedUnits = 0;
            const subjectProgress = { calculus: 0, linearAlgebra: 0, probability: 0 };
            const subjectTotal = { calculus: 0, linearAlgebra: 0, probability: 0 };

            for (const [subjectKey, subject] of Object.entries(knowledgeTree)) {
                for (const chapter of subject.chapters) {
                    for (const unit of chapter.units) {
                        totalUnits++;
                        subjectTotal[subjectKey]++;
                        const status = progress[unit.id]?.status;
                        if (status === 'completed' || status === 'mastered') {
                            completedUnits++;
                            subjectProgress[subjectKey]++;
                        }
                    }
                }
            }

            // è®¡ç®—å„ç§‘ç›®ç™¾åˆ†æ¯”
            for (const key of Object.keys(subjectProgress)) {
                subjectProgress[key] = subjectTotal[key] > 0
                    ? Math.round((subjectProgress[key] / subjectTotal[key]) * 100)
                    : 0;
            }

            // ä»Šæ—¥ä»»åŠ¡ç»Ÿè®¡
            let todayTaskCount = 0;
            let todayCompletedTasks = 0;
            if (plan && plan.dailyTasks) {
                const today = new Date().toISOString().split('T')[0];
                const todayTasks = plan.dailyTasks.find(dt => dt.date === today);
                if (todayTasks && todayTasks.tasks) {
                    todayTaskCount = todayTasks.tasks.length;
                    todayCompletedTasks = todayTasks.tasks.filter(t => t.status === 'completed').length;
                }
            }

            // è¿ç»­å­¦ä¹ å¤©æ•° (ç®€åŒ–è®¡ç®—)
            const streakDays = calculateStreakDays(progress);

            return {
                totalUnits,
                completedUnits,
                subjectProgress,
                todayTaskCount,
                todayCompletedTasks,
                todayCompletionRate: todayTaskCount > 0 ? Math.round((todayCompletedTasks / todayTaskCount) * 100) : 0,
                streakDays
            };
        }

        // è®¡ç®—è¿ç»­å­¦ä¹ å¤©æ•°
        function calculateStreakDays(progress) {
            const dates = new Set();
            for (const data of Object.values(progress)) {
                if (data.lastStudied) {
                    dates.add(data.lastStudied.split('T')[0]);
                }
            }

            if (dates.size === 0) return 0;

            const sortedDates = Array.from(dates).sort().reverse();
            const today = new Date().toISOString().split('T')[0];

            // æ£€æŸ¥ä»Šå¤©æˆ–æ˜¨å¤©æ˜¯å¦å­¦ä¹ 
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            if (!dates.has(today) && !dates.has(yesterdayStr)) {
                return 0;
            }

            let streak = 0;
            let checkDate = dates.has(today) ? new Date() : yesterday;

            while (dates.has(checkDate.toISOString().split('T')[0])) {
                streak++;
                checkDate.setDate(checkDate.getDate() - 1);
            }

            return streak;
        }

        // æ¸²æŸ“ä»Šæ—¥ä»»åŠ¡åˆ—è¡¨
        function renderDashboardTasks(plan) {
            if (!plan || !plan.dailyTasks) {
                return `
                    <div class="no-tasks-message">
                        <div class="icon">ğŸ“‹</div>
                        <div>æš‚æ— å­¦ä¹ è§„åˆ’</div>
                        <button class="btn btn-primary" style="margin-top: 15px;" onclick="viewManager.switchView('plan')">
                            åˆ›å»ºå­¦ä¹ è§„åˆ’
                        </button>
                    </div>
                `;
            }

            const today = new Date().toISOString().split('T')[0];
            const todayTasks = plan.dailyTasks.find(dt => dt.date === today);

            if (!todayTasks || todayTasks.tasks.length === 0) {
                return `
                    <div class="no-tasks-message">
                        <div class="icon">âœ…</div>
                        <div>ä»Šæ—¥æ²¡æœ‰å®‰æ’å­¦ä¹ ä»»åŠ¡</div>
                    </div>
                `;
            }

            return todayTasks.tasks.map(task => {
                const isCompleted = task.status === 'completed';
                const taskName = task.knowledgeName || task.description || 'å­¦ä¹ ä»»åŠ¡';
                const taskType = task.type === 'knowledge' ? 'ğŸ“– çŸ¥è¯†ç‚¹'
                    : task.type === 'practice' ? 'âœï¸ ç»ƒä¹ '
                    : 'ğŸ”„ å¤ä¹ ';

                return `
                    <div class="dashboard-task-item ${isCompleted ? 'completed' : ''}"
                         onclick="toggleDashboardTask('${task.id}')">
                        <div class="task-checkbox ${isCompleted ? 'checked' : ''}">
                            ${isCompleted ? 'âœ“' : ''}
                        </div>
                        <div class="task-content">
                            <div class="task-title">${taskName}</div>
                            <div class="task-subtitle">${taskType}</div>
                        </div>
                        <div class="task-duration">${task.duration}åˆ†é’Ÿ</div>
                    </div>
                `;
            }).join('');
        }

        // åˆ‡æ¢ä»»åŠ¡å®ŒæˆçŠ¶æ€
        function toggleDashboardTask(taskId) {
            const plan = dataManager.load('studyPlan', null);
            if (!plan || !plan.dailyTasks) return;

            const today = new Date().toISOString().split('T')[0];
            const todayTasks = plan.dailyTasks.find(dt => dt.date === today);
            if (!todayTasks) return;

            const task = todayTasks.tasks.find(t => t.id === taskId);
            if (!task) return;

            // åˆ‡æ¢çŠ¶æ€
            task.status = task.status === 'completed' ? 'pending' : 'completed';

            // ä¿å­˜å¹¶åˆ·æ–°
            dataManager.save('studyPlan', plan);
            renderDashboard();
        }

        // æ¸²æŸ“æœ€è¿‘æ´»åŠ¨
        function renderRecentActivity(progress) {
            const activities = [];

            for (const [unitId, data] of Object.entries(progress)) {
                if (data.lastStudied) {
                    activities.push({
                        unitId,
                        unitName: data.unitName || unitId,
                        subject: data.subject || 'calculus',
                        lastStudied: data.lastStudied,
                        status: data.status
                    });
                }
            }

            if (activities.length === 0) {
                return `
                    <div class="no-activity-message">
                        <div>æš‚æ— å­¦ä¹ è®°å½•</div>
                        <div style="margin-top: 10px;">å¼€å§‹å­¦ä¹ ï¼Œè®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                    </div>
                `;
            }

            // æŒ‰æ—¶é—´æ’åºï¼Œå–æœ€è¿‘5ä¸ª
            activities.sort((a, b) => new Date(b.lastStudied) - new Date(a.lastStudied));
            const recentActivities = activities.slice(0, 5);

            const subjectNames = {
                calculus: 'å¾®ç§¯åˆ†',
                linearAlgebra: 'çº¿ä»£',
                probability: 'æ¦‚ç‡è®º'
            };

            return recentActivities.map(activity => {
                const timeAgo = getTimeAgo(activity.lastStudied);
                const subjectName = subjectNames[activity.subject] || activity.subject;

                return `
                    <div class="activity-item" onclick="goToKnowledge('${activity.unitId}')">
                        <div class="activity-icon">ğŸ“–</div>
                        <div class="activity-info">
                            <div class="activity-title">${activity.unitName}</div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                        <span class="activity-badge ${activity.subject}">${subjectName}</span>
                    </div>
                `;
            }).join('');
        }

        // è®¡ç®—æ—¶é—´å·®
        function getTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
            if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
            if (diffDays < 7) return `${diffDays}å¤©å‰`;
            return date.toLocaleDateString('zh-CN');
        }

        // è·³è½¬åˆ°çŸ¥è¯†ç‚¹
        function goToKnowledge(unitId) {
            // ä¿å­˜è¦è·³è½¬çš„çŸ¥è¯†ç‚¹ID
            dataManager.save('targetKnowledgeId', unitId);
            viewManager.switchView('knowledge');
        }

        // åˆå§‹åŒ–ä»ªè¡¨æ¿å›¾è¡¨
        function initDashboardCharts(subjectProgress) {
            const chartConfig = (progress, color) => ({
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [progress, 100 - progress],
                        backgroundColor: [color, '#e0e0e0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '70%',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });

            // å¾®ç§¯åˆ†å›¾è¡¨
            const ctx1 = document.getElementById('chart-calculus');
            if (ctx1) new Chart(ctx1, chartConfig(subjectProgress.calculus, '#2196F3'));

            // çº¿æ€§ä»£æ•°å›¾è¡¨
            const ctx2 = document.getElementById('chart-linear');
            if (ctx2) new Chart(ctx2, chartConfig(subjectProgress.linearAlgebra, '#4CAF50'));

            // æ¦‚ç‡è®ºå›¾è¡¨
            const ctx3 = document.getElementById('chart-prob');
            if (ctx3) new Chart(ctx3, chartConfig(subjectProgress.probability, '#FF9800'));
        }

        // å­¦ä¹ è§„åˆ’
        function renderPlanView() {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰è§„åˆ’
            const savedPlan = dataManager.load('studyPlan', null);
            if (savedPlan && savedPlan.applied) {
                renderPlanDisplay(savedPlan);
            } else {
                renderPlanConfig();
            }
        }


        // ç»ƒä¹ æµ‹è¯•
        function renderPracticeView() {
            const container = document.getElementById('view-container');
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">âœï¸ ç»ƒä¹ æµ‹è¯•</div>
                    </div>

                    <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">
                        <button class="practice-tab active" data-tab="exam" style="padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">
                            æ¨¡æ‹Ÿè¯•å·
                        </button>
                        <button class="practice-tab" data-tab="exercise" style="padding: 10px 20px; background: #f0f0f0; color: #666; border: none; border-radius: 5px; cursor: pointer;">
                            ä¸“é¡¹ç»ƒä¹ 
                        </button>
                        <button class="practice-tab" data-tab="wrong" style="padding: 10px 20px; background: #f0f0f0; color: #666; border: none; border-radius: 5px; cursor: pointer;">
                            é”™é¢˜æœ¬
                        </button>
                    </div>

                    <!-- æ ‡ç­¾é¡µå†…å®¹ -->
                    <div id="practice-content">
                        <!-- åŠ¨æ€åŠ è½½å†…å®¹ -->
                    </div>
                </div>
            `;

            // ç»‘å®šæ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.practice-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // æ›´æ–°æ ‡ç­¾æ ·å¼
                    document.querySelectorAll('.practice-tab').forEach(t => {
                        t.style.background = '#f0f0f0';
                        t.style.color = '#666';
                        t.classList.remove('active');
                    });
                    this.style.background = 'var(--primary-color)';
                    this.style.color = 'white';
                    this.classList.add('active');

                    // åˆ‡æ¢å†…å®¹
                    const tabType = this.dataset.tab;
                    loadPracticeTab(tabType);
                });
            });

            // é»˜è®¤åŠ è½½æ¨¡æ‹Ÿè¯•å·
            loadPracticeTab('exam');
        }

        // ========== é¢„è®¾é¢˜åº“ ==========
        const questionBank = [
            // é€‰æ‹©é¢˜
            { type: 'choice', subject: 'calculus', difficulty: 'intermediate', question: 'è®¾å‡½æ•° $f(x)$ åœ¨ $x=0$ å¤„è¿ç»­ï¼Œä¸” $\\lim_{x \\to 0} \\frac{f(x)}{x} = 1$ï¼Œåˆ™ $f(0)$ ç­‰äº', options: ['A. 0', 'B. 1', 'C. -1', 'D. ä¸å­˜åœ¨'], answer: 'A', explanation: 'å› ä¸º $\\lim_{x \\to 0} \\frac{f(x)}{x} = 1$ å­˜åœ¨ä¸”æœ‰é™ï¼Œæ‰€ä»¥ $\\lim_{x \\to 0} f(x) = 0$ã€‚åˆå› ä¸º $f(x)$ åœ¨ $x=0$ å¤„è¿ç»­ï¼Œæ‰€ä»¥ $f(0) = 0$ã€‚' },
            { type: 'choice', subject: 'calculus', difficulty: 'intermediate', question: 'è®¾ $f(x)$ å¯å¯¼ï¼Œ$F(x) = f(x)(1+|x|)$ï¼Œåˆ™ $F(x)$ åœ¨ $x=0$ å¤„å¯å¯¼çš„å……è¦æ¡ä»¶æ˜¯', options: ['A. $f(0)=0$', 'B. $f\'(0)=0$', 'C. $f(0)=f\'(0)$', 'D. $f(0)+f\'(0)=0$'], answer: 'A', explanation: '$F\'_+(0) = f(0) + f\'(0)$ï¼Œ$F\'_-(0) = f(0) - f\'(0)$ã€‚è¦ä½¿ $F(x)$ åœ¨ $x=0$ å¤„å¯å¯¼ï¼Œéœ€è¦ $F\'_+(0) = F\'_-(0)$ï¼Œå³ $f(0)=0$ã€‚' },
            { type: 'choice', subject: 'calculus', difficulty: 'advanced', question: 'è®¾å‡½æ•° $f(x,y)$ åœ¨ç‚¹ $(0,0)$ å¤„å¯å¾®ï¼Œä¸” $f(0,0)=0$ï¼Œ$f_x(0,0)=1$ï¼Œ$f_y(0,0)=2$ï¼Œåˆ™ $\\lim_{t \\to 0} \\frac{f(t,2t)}{t}$ ç­‰äº', options: ['A. 3', 'B. 5', 'C. 1', 'D. 2'], answer: 'B', explanation: 'ç”±å¯å¾®æ€§ï¼Œ$f(t,2t) = f_x(0,0) \\cdot t + f_y(0,0) \\cdot 2t + o(t) = 5t + o(t)$ã€‚å› æ­¤æé™ä¸º 5ã€‚' },
            { type: 'choice', subject: 'linear', difficulty: 'intermediate', question: 'è®¾ $A$ æ˜¯ $n$ é˜¶çŸ©é˜µï¼Œ$|A|=2$ï¼Œåˆ™ $|2A^*|$ ç­‰äºï¼ˆå…¶ä¸­ $A^*$ æ˜¯ $A$ çš„ä¼´éšçŸ©é˜µï¼‰', options: ['A. $2^n$', 'B. $2^{n+1}$', 'C. $2^{2n-1}$', 'D. $2^{2n}$'], answer: 'C', explanation: '$|A^*| = |A|^{n-1} = 2^{n-1}$ï¼Œå› æ­¤ $|2A^*| = 2^n |A^*| = 2^{2n-1}$ã€‚' },
            { type: 'choice', subject: 'linear', difficulty: 'advanced', question: 'è®¾ $A$ ä¸º $3$ é˜¶çŸ©é˜µï¼Œ$\\alpha_1, \\alpha_2, \\alpha_3$ æ˜¯çº¿æ€§æ— å…³çš„ $3$ ç»´åˆ—å‘é‡ï¼Œè‹¥ $A\\alpha_1 = \\alpha_1 + \\alpha_2$ï¼Œ$A\\alpha_2 = \\alpha_2 + \\alpha_3$ï¼Œ$A\\alpha_3 = \\alpha_3$ï¼Œåˆ™ $A$ çš„ç‰¹å¾å€¼ä¸º', options: ['A. 1, 1, 1', 'B. 0, 1, 2', 'C. 1, 1, 2', 'D. 0, 0, 1'], answer: 'A', explanation: '$A$ ä¸ä¸Šä¸‰è§’çŸ©é˜µç›¸ä¼¼ï¼Œç‰¹å¾å€¼ä¸ºå¯¹è§’çº¿å…ƒç´  1, 1, 1ã€‚' },
            { type: 'choice', subject: 'probability', difficulty: 'intermediate', question: 'è®¾éšæœºå˜é‡ $X$ ä¸ $Y$ ç›¸äº’ç‹¬ç«‹ï¼Œä¸”éƒ½æœä»æ­£æ€åˆ†å¸ƒ $N(0,1)$ï¼Œåˆ™ $P\\{\\max(X,Y) \\leq 0\\}$ ç­‰äº', options: ['A. $\\frac{1}{4}$', 'B. $\\frac{1}{3}$', 'C. $\\frac{1}{2}$', 'D. $\\frac{3}{4}$'], answer: 'A', explanation: '$P\\{\\max(X,Y) \\leq 0\\} = P\\{X \\leq 0\\} \\cdot P\\{Y \\leq 0\\} = \\frac{1}{2} \\times \\frac{1}{2} = \\frac{1}{4}$ã€‚' },
            { type: 'choice', subject: 'probability', difficulty: 'intermediate', question: 'è®¾éšæœºå˜é‡ $X_1, X_2, \\ldots, X_n$ æ˜¯æ¥è‡ªæ€»ä½“ $N(\\mu, \\sigma^2)$ çš„ç®€å•éšæœºæ ·æœ¬ï¼Œåˆ™æœä» $t(n-1)$ åˆ†å¸ƒçš„ç»Ÿè®¡é‡æ˜¯', options: ['A. $\\frac{\\bar{X}-\\mu}{S/\\sqrt{n}}$', 'B. $\\frac{\\bar{X}-\\mu}{\\sigma/\\sqrt{n}}$', 'C. $\\frac{\\bar{X}}{S/\\sqrt{n}}$', 'D. $\\frac{\\bar{X}-\\mu}{S}$'], answer: 'A', explanation: 'ç”± $t$ åˆ†å¸ƒçš„å®šä¹‰ï¼Œ$\\frac{\\bar{X}-\\mu}{S/\\sqrt{n}} \\sim t(n-1)$ã€‚' },
            { type: 'choice', subject: 'calculus', difficulty: 'advanced', question: 'å¾®åˆ†æ–¹ç¨‹ $y\'\' - 2y\' + y = e^x$ çš„é€šè§£ä¸º', options: ['A. $(C_1 + C_2 x + \\frac{1}{2}x^2)e^x$', 'B. $(C_1 + C_2 x)e^x + \\frac{1}{2}x^2e^x$', 'C. $(C_1 + C_2 x)e^x$', 'D. $C_1e^x + C_2xe^x + x^2e^x$'], answer: 'B', explanation: 'ç‰¹å¾æ ¹ $r=1$ æ˜¯äºŒé‡æ ¹ï¼Œé½æ¬¡é€šè§£ä¸º $(C_1 + C_2 x)e^x$ï¼Œç‰¹è§£ä¸º $\\frac{1}{2}x^2e^x$ã€‚' },
            // å¡«ç©ºé¢˜
            { type: 'blank', subject: 'calculus', difficulty: 'intermediate', question: 'æé™ $\\lim_{x \\to 0} \\frac{\\sin x - x}{x^3}$ = ____', answer: '-1/6', explanation: 'ä½¿ç”¨æ³°å‹’å±•å¼€ï¼š$\\sin x = x - \\frac{x^3}{6} + o(x^3)$ï¼Œç»“æœä¸º $-\\frac{1}{6}$ã€‚' },
            { type: 'blank', subject: 'calculus', difficulty: 'intermediate', question: 'è®¾ $z = e^{xy}$ï¼Œåˆ™ $\\frac{\\partial^2 z}{\\partial x \\partial y}$ = ____', answer: 'e^(xy)(1+xy)', explanation: '$\\frac{\\partial^2 z}{\\partial x \\partial y} = e^{xy}(1+xy)$ã€‚' },
            { type: 'blank', subject: 'calculus', difficulty: 'intermediate', question: 'ç§¯åˆ† $\\int_0^{\\pi/2} \\sin^3 x \\cos^2 x \\, dx$ = ____', answer: '2/15', explanation: 'ä»¤ $u = \\cos x$ï¼Œè®¡ç®—å¾— $\\frac{2}{15}$ã€‚' },
            { type: 'blank', subject: 'linear', difficulty: 'basic', question: 'è®¾çŸ©é˜µ $A = \\begin{pmatrix} 1 & 2 & 3 \\\\ 2 & 4 & 6 \\\\ 1 & 2 & 3 \\end{pmatrix}$ï¼Œåˆ™ $A$ çš„ç§© $r(A)$ = ____', answer: '1', explanation: 'ä¸‰è¡Œçº¿æ€§ç›¸å…³ï¼Œåªæœ‰ä¸€ä¸ªçº¿æ€§æ— å…³çš„è¡Œå‘é‡ï¼Œ$r(A) = 1$ã€‚' },
            { type: 'blank', subject: 'linear', difficulty: 'intermediate', question: 'è®¾ $3$ é˜¶çŸ©é˜µ $A$ çš„ç‰¹å¾å€¼ä¸º $1, 2, 3$ï¼Œåˆ™ $|A^{-1} + E|$ = ____', answer: '4', explanation: '$A^{-1}+E$ çš„ç‰¹å¾å€¼ä¸º $2, \\frac{3}{2}, \\frac{4}{3}$ï¼Œè¡Œåˆ—å¼ä¸º $4$ã€‚' },
            { type: 'blank', subject: 'probability', difficulty: 'basic', question: 'è®¾éšæœºå˜é‡ $X$ æœä»å‚æ•°ä¸º $2$ çš„æŒ‡æ•°åˆ†å¸ƒï¼Œåˆ™ $E(X)$ = ____', answer: '1/2', explanation: 'æŒ‡æ•°åˆ†å¸ƒ $E(X) = \\frac{1}{\\lambda} = \\frac{1}{2}$ã€‚' },
            // è§£ç­”é¢˜
            { type: 'solve', subject: 'calculus', difficulty: 'advanced', question: 'æ±‚æé™ $\\lim_{n \\to \\infty} \\sqrt[n]{\\frac{(2n)!}{n!n^n}}$', answer: '4/e', explanation: 'ä½¿ç”¨æ–¯ç‰¹æ—å…¬å¼ï¼Œç»“æœä¸º $\\frac{4}{e}$ã€‚' },
            { type: 'solve', subject: 'linear', difficulty: 'advanced', question: 'è®¾çŸ©é˜µ $A = \\begin{pmatrix} 1 & -1 & 0 \\\\ -1 & 2 & -1 \\\\ 0 & -1 & 1 \\end{pmatrix}$ï¼Œæ±‚ $A$ çš„ç‰¹å¾å€¼ã€‚', answer: '0, 1, 3', explanation: 'ç‰¹å¾å€¼ä¸º $\\lambda_1 = 0, \\lambda_2 = 1, \\lambda_3 = 3$ã€‚' },
            { type: 'solve', subject: 'probability', difficulty: 'intermediate', question: 'è®¾éšæœºå˜é‡ $X$ çš„æ¦‚ç‡å¯†åº¦å‡½æ•°ä¸º $f(x) = Ae^{-2x}$ ($x>0$)ï¼Œæ±‚å¸¸æ•° $A$ å’Œ $E(X)$ã€‚', answer: 'A=2, E(X)=1/2', explanation: 'ç”±å½’ä¸€åŒ–æ¡ä»¶ï¼Œ$A=2$ï¼›$E(X) = \\frac{1}{2}$ã€‚' }
        ];

        // ========== ä¸“é¡¹ç»ƒä¹ çŠ¶æ€ ==========
        let exerciseState = {
            questions: [],
            currentIndex: 0,
            userAnswers: [],
            startTime: null,
            isFinished: false
        };

        // ========== ä¸“é¡¹ç»ƒä¹ å‡½æ•° ==========

        // æ¸²æŸ“ä¸“é¡¹ç»ƒä¹ ç­›é€‰ç•Œé¢
        function renderExerciseFilter() {
            const subjectNames = { calculus: 'å¾®ç§¯åˆ†', linear: 'çº¿æ€§ä»£æ•°', probability: 'æ¦‚ç‡è®º' };
            const difficultyNames = { basic: 'åŸºç¡€', intermediate: 'ä¸­ç­‰', advanced: 'å›°éš¾' };
            const typeNames = { choice: 'é€‰æ‹©é¢˜', blank: 'å¡«ç©ºé¢˜', solve: 'è§£ç­”é¢˜' };

            return `
                <div class="exercise-filter">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>å­¦ç§‘ï¼š</label>
                            <select id="filterSubject" class="filter-select">
                                <option value="all">å…¨éƒ¨</option>
                                <option value="calculus">å¾®ç§¯åˆ†</option>
                                <option value="linear">çº¿æ€§ä»£æ•°</option>
                                <option value="probability">æ¦‚ç‡è®º</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>éš¾åº¦ï¼š</label>
                            <select id="filterDifficulty" class="filter-select">
                                <option value="all">å…¨éƒ¨</option>
                                <option value="basic">åŸºç¡€</option>
                                <option value="intermediate">ä¸­ç­‰</option>
                                <option value="advanced">å›°éš¾</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>é¢˜å‹ï¼š</label>
                            <select id="filterType" class="filter-select">
                                <option value="all">å…¨éƒ¨</option>
                                <option value="choice">é€‰æ‹©é¢˜</option>
                                <option value="blank">å¡«ç©ºé¢˜</option>
                                <option value="solve">è§£ç­”é¢˜</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>é¢˜é‡ï¼š</label>
                            <select id="filterCount" class="filter-select">
                                <option value="5">5é¢˜</option>
                                <option value="10" selected>10é¢˜</option>
                                <option value="15">15é¢˜</option>
                                <option value="20">20é¢˜</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-primary" onclick="startExercise()">ğŸ¯ å¼€å§‹ç»ƒä¹ </button>
                        <button class="btn btn-secondary" onclick="generateAIQuestion()">ğŸ¤– AIç”Ÿæˆé¢˜ç›®</button>
                    </div>
                    <div class="filter-info">
                        <p>ğŸ’¡ ä»é¢˜åº“ç­›é€‰æˆ–ä½¿ç”¨AIç”Ÿæˆæ–°é¢˜ç›®è¿›è¡Œç»ƒä¹ </p>
                    </div>
                </div>
            `;
        }

        // å¼€å§‹ä¸“é¡¹ç»ƒä¹ 
        function startExercise() {
            const subject = document.getElementById('filterSubject').value;
            const difficulty = document.getElementById('filterDifficulty').value;
            const type = document.getElementById('filterType').value;
            const count = parseInt(document.getElementById('filterCount').value);

            // ç­›é€‰é¢˜ç›®
            let filtered = questionBank.filter(q => {
                if (subject !== 'all' && q.subject !== subject) return false;
                if (difficulty !== 'all' && q.difficulty !== difficulty) return false;
                if (type !== 'all' && q.type !== type) return false;
                return true;
            });

            if (filtered.length === 0) {
                alert('æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®ï¼Œè¯·è°ƒæ•´ç­›é€‰æ¡ä»¶');
                return;
            }

            // éšæœºé€‰å–
            filtered = shuffleArray(filtered).slice(0, Math.min(count, filtered.length));

            exerciseState = {
                questions: filtered,
                currentIndex: 0,
                userAnswers: new Array(filtered.length).fill(null),
                startTime: Date.now(),
                isFinished: false
            };

            renderExerciseQuestions();
        }

        // éšæœºæ‰“ä¹±æ•°ç»„
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // æ¸²æŸ“ç­”é¢˜ç•Œé¢
        function renderExerciseQuestions() {
            const contentDiv = document.getElementById('practice-content');
            const q = exerciseState.questions[exerciseState.currentIndex];
            const idx = exerciseState.currentIndex;
            const total = exerciseState.questions.length;

            let answerHTML = '';
            if (q.type === 'choice') {
                answerHTML = q.options.map((opt, i) => `
                    <label class="exercise-option ${exerciseState.userAnswers[idx] === opt.charAt(0) ? 'selected' : ''}"
                           onclick="selectExerciseAnswer('${opt.charAt(0)}')">
                        <input type="radio" name="answer" value="${opt.charAt(0)}"
                               ${exerciseState.userAnswers[idx] === opt.charAt(0) ? 'checked' : ''}>
                        ${opt}
                    </label>
                `).join('');
            } else if (q.type === 'blank') {
                answerHTML = `<input type="text" class="exercise-input" id="blankAnswer"
                              value="${exerciseState.userAnswers[idx] || ''}"
                              placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" onchange="saveBlankAnswer()">`;
            } else {
                answerHTML = `<textarea class="exercise-textarea" id="solveAnswer"
                              placeholder="è¯·è¾“å…¥è§£ç­”è¿‡ç¨‹">${exerciseState.userAnswers[idx] || ''}</textarea>
                              <button class="btn btn-secondary" style="margin-top: 10px;" onclick="saveSolveAnswer()">ä¿å­˜ç­”æ¡ˆ</button>`;
            }

            const subjectNames = { calculus: 'å¾®ç§¯åˆ†', linear: 'çº¿ä»£', probability: 'æ¦‚ç‡è®º' };
            const difficultyNames = { basic: 'åŸºç¡€', intermediate: 'ä¸­ç­‰', advanced: 'å›°éš¾' };
            const typeNames = { choice: 'é€‰æ‹©é¢˜', blank: 'å¡«ç©ºé¢˜', solve: 'è§£ç­”é¢˜' };

            contentDiv.innerHTML = `
                <div class="exercise-container">
                    <div class="exercise-header">
                        <div class="exercise-progress">ç¬¬ ${idx + 1} / ${total} é¢˜</div>
                        <div class="exercise-tags">
                            <span class="tag tag-${q.subject}">${subjectNames[q.subject]}</span>
                            <span class="tag tag-${q.difficulty}">${difficultyNames[q.difficulty]}</span>
                            <span class="tag">${typeNames[q.type]}</span>
                        </div>
                    </div>
                    <div class="exercise-question">
                        <div class="question-content">${q.question}</div>
                        <div class="answer-area">${answerHTML}</div>
                    </div>
                    <div class="exercise-nav">
                        <button class="btn btn-secondary" onclick="prevExerciseQuestion()" ${idx === 0 ? 'disabled' : ''}>ä¸Šä¸€é¢˜</button>
                        <button class="btn btn-secondary" onclick="checkCurrentAnswer()">æŸ¥çœ‹ç­”æ¡ˆ</button>
                        ${idx < total - 1
                            ? '<button class="btn btn-primary" onclick="nextExerciseQuestion()">ä¸‹ä¸€é¢˜</button>'
                            : '<button class="btn btn-success" onclick="submitExercise()">æäº¤ç»ƒä¹ </button>'}
                    </div>
                    <div id="exercise-explanation" class="exercise-explanation" style="display: none;"></div>
                </div>
            `;

            // æ¸²æŸ“MathJax
            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise([contentDiv]);
            }
        }

        // é€‰æ‹©ç­”æ¡ˆ
        function selectExerciseAnswer(answer) {
            exerciseState.userAnswers[exerciseState.currentIndex] = answer;
            renderExerciseQuestions();
        }

        // ä¿å­˜å¡«ç©ºç­”æ¡ˆ
        function saveBlankAnswer() {
            const input = document.getElementById('blankAnswer');
            if (input) {
                exerciseState.userAnswers[exerciseState.currentIndex] = input.value;
            }
        }

        // ä¿å­˜è§£ç­”ç­”æ¡ˆ
        function saveSolveAnswer() {
            const textarea = document.getElementById('solveAnswer');
            if (textarea) {
                exerciseState.userAnswers[exerciseState.currentIndex] = textarea.value;
                alert('ç­”æ¡ˆå·²ä¿å­˜');
            }
        }

        // ä¸Šä¸€é¢˜
        function prevExerciseQuestion() {
            if (exerciseState.currentIndex > 0) {
                exerciseState.currentIndex--;
                renderExerciseQuestions();
            }
        }

        // ä¸‹ä¸€é¢˜
        function nextExerciseQuestion() {
            if (exerciseState.currentIndex < exerciseState.questions.length - 1) {
                exerciseState.currentIndex++;
                renderExerciseQuestions();
            }
        }

        // æŸ¥çœ‹å½“å‰é¢˜ç­”æ¡ˆ
        function checkCurrentAnswer() {
            const q = exerciseState.questions[exerciseState.currentIndex];
            const userAns = exerciseState.userAnswers[exerciseState.currentIndex];
            const isCorrect = normalizeExerciseAnswer(userAns) === normalizeExerciseAnswer(q.answer);

            const expDiv = document.getElementById('exercise-explanation');
            expDiv.innerHTML = `
                <div class="exp-header ${isCorrect ? 'correct' : 'wrong'}">
                    ${isCorrect ? 'âœ… å›ç­”æ­£ç¡®' : 'âŒ å›ç­”é”™è¯¯'}
                </div>
                <div class="exp-answer">
                    <strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong>${q.answer}
                    ${userAns ? `<br><strong>ä½ çš„ç­”æ¡ˆï¼š</strong>${userAns}` : ''}
                </div>
                <div class="exp-detail">
                    <strong>è§£æï¼š</strong><br>${q.explanation}
                </div>
            `;
            expDiv.style.display = 'block';

            // ä¿å­˜é”™é¢˜
            if (!isCorrect && userAns) {
                saveWrongQuestion(q, userAns);
            }

            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise([expDiv]);
            }
        }

        // æ ‡å‡†åŒ–ç­”æ¡ˆ
        function normalizeExerciseAnswer(answer) {
            if (!answer) return '';
            return answer.toString().trim().toLowerCase().replace(/\s+/g, '');
        }

        // æäº¤ç»ƒä¹ 
        function submitExercise() {
            const contentDiv = document.getElementById('practice-content');
            let correct = 0;
            const results = exerciseState.questions.map((q, i) => {
                const userAns = exerciseState.userAnswers[i];
                const isCorrect = normalizeExerciseAnswer(userAns) === normalizeExerciseAnswer(q.answer);
                if (isCorrect) correct++;
                if (!isCorrect && userAns) saveWrongQuestion(q, userAns);
                return { question: q, userAnswer: userAns, isCorrect };
            });

            const duration = Math.round((Date.now() - exerciseState.startTime) / 1000);
            const accuracy = Math.round((correct / exerciseState.questions.length) * 100);

            // ä¿å­˜ç»ƒä¹ è®°å½•
            savePracticeRecord({
                date: new Date().toISOString(),
                type: 'exercise',
                questions: exerciseState.questions.length,
                correct: correct,
                accuracy: accuracy,
                duration: duration
            });

            contentDiv.innerHTML = `
                <div class="exercise-result">
                    <div class="result-header">ğŸ‰ ç»ƒä¹ å®Œæˆï¼</div>
                    <div class="result-stats">
                        <div class="stat-item">
                            <div class="stat-value">${correct}/${exerciseState.questions.length}</div>
                            <div class="stat-label">æ­£ç¡®é¢˜æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value ${accuracy >= 60 ? 'good' : 'bad'}">${accuracy}%</div>
                            <div class="stat-label">æ­£ç¡®ç‡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${formatDuration(duration)}</div>
                            <div class="stat-label">ç”¨æ—¶</div>
                        </div>
                    </div>
                    <div class="result-actions">
                        <button class="btn btn-primary" onclick="loadPracticeTab('exercise')">å†ç»ƒä¸€æ¬¡</button>
                        <button class="btn btn-secondary" onclick="loadPracticeTab('wrong')">æŸ¥çœ‹é”™é¢˜æœ¬</button>
                    </div>
                </div>
            `;
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return min > 0 ? `${min}åˆ†${sec}ç§’` : `${sec}ç§’`;
        }

        // AIç”Ÿæˆé¢˜ç›®
        async function generateAIQuestion() {
            if (!isAIConfigured()) {
                alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®AIæ¨¡å‹');
                return;
            }

            const subject = document.getElementById('filterSubject').value;
            const difficulty = document.getElementById('filterDifficulty').value;
            const type = document.getElementById('filterType').value;

            const subjectNames = { all: 'æ•°å­¦', calculus: 'å¾®ç§¯åˆ†', linear: 'çº¿æ€§ä»£æ•°', probability: 'æ¦‚ç‡è®º' };
            const difficultyNames = { all: 'ä¸­ç­‰', basic: 'åŸºç¡€', intermediate: 'ä¸­ç­‰', advanced: 'å›°éš¾' };
            const typeNames = { all: 'é€‰æ‹©é¢˜', choice: 'é€‰æ‹©é¢˜', blank: 'å¡«ç©ºé¢˜', solve: 'è§£ç­”é¢˜' };

            const prompt = `è¯·ç”Ÿæˆä¸€é“è€ƒç ”æ•°å­¦ä¸€${subjectNames[subject]}çš„${typeNames[type]}ï¼Œéš¾åº¦ä¸º${difficultyNames[difficulty]}ã€‚

è¦æ±‚ï¼š
1. é¢˜ç›®ç¬¦åˆè€ƒç ”æ•°å­¦ä¸€æ ‡å‡†
2. åŒ…å«è¯¦ç»†è§£æ
3. è¿”å›ä¸¥æ ¼çš„JSONæ ¼å¼ï¼ˆä¸è¦æœ‰å¤šä½™æ–‡å­—ï¼‰:
${type === 'choice' || type === 'all' ?
`{"type":"choice","subject":"${subject === 'all' ? 'calculus' : subject}","difficulty":"${difficulty === 'all' ? 'intermediate' : difficulty}","question":"é¢˜ç›®å†…å®¹","options":["A. é€‰é¡¹1","B. é€‰é¡¹2","C. é€‰é¡¹3","D. é€‰é¡¹4"],"answer":"æ­£ç¡®é€‰é¡¹å­—æ¯","explanation":"è§£æ"}` :
type === 'blank' ?
`{"type":"blank","subject":"${subject === 'all' ? 'calculus' : subject}","difficulty":"${difficulty === 'all' ? 'intermediate' : difficulty}","question":"é¢˜ç›®å†…å®¹____","answer":"ç­”æ¡ˆ","explanation":"è§£æ"}` :
`{"type":"solve","subject":"${subject === 'all' ? 'calculus' : subject}","difficulty":"${difficulty === 'all' ? 'intermediate' : difficulty}","question":"é¢˜ç›®å†…å®¹","answer":"ç­”æ¡ˆ","explanation":"è§£æ"}`}`;

            const contentDiv = document.getElementById('practice-content');
            contentDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div>AIæ­£åœ¨ç”Ÿæˆé¢˜ç›®...</div></div>';

            try {
                const response = await callAI([{ role: 'user', content: prompt }], { maxTokens: 2000 });
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const newQuestion = JSON.parse(jsonMatch[0]);
                    exerciseState = {
                        questions: [newQuestion],
                        currentIndex: 0,
                        userAnswers: [null],
                        startTime: Date.now(),
                        isFinished: false
                    };
                    renderExerciseQuestions();
                } else {
                    throw new Error('AIè¿”å›æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                contentDiv.innerHTML = renderExerciseFilter();
                alert('AIç”Ÿæˆé¢˜ç›®å¤±è´¥: ' + error.message);
            }
        }

        // ========== é”™é¢˜æœ¬å‡½æ•° ==========

        // ä¿å­˜é”™é¢˜
        function saveWrongQuestion(question, userAnswer) {
            const wrongQuestions = dataManager.load('wrongQuestions', []);
            const qHash = JSON.stringify({ q: question.question, t: question.type });
            const existing = wrongQuestions.find(w => JSON.stringify({ q: w.question.question, t: w.question.type }) === qHash);

            if (existing) {
                existing.wrongCount++;
                existing.lastWrongTime = new Date().toISOString();
                existing.userAnswer = userAnswer;
            } else {
                wrongQuestions.push({
                    id: 'wrong-' + Date.now(),
                    question: question,
                    userAnswer: userAnswer,
                    correctAnswer: question.answer,
                    wrongCount: 1,
                    lastWrongTime: new Date().toISOString(),
                    status: 'active'
                });
            }
            dataManager.save('wrongQuestions', wrongQuestions);
        }

        // æ¸²æŸ“é”™é¢˜æœ¬
        function renderWrongBook() {
            const wrongQuestions = dataManager.load('wrongQuestions', []);
            const showMastered = document.getElementById('showMastered')?.checked || false;
            const sortBy = document.getElementById('sortWrong')?.value || 'time';
            const filterSubject = document.getElementById('filterWrongSubject')?.value || 'all';

            let filtered = wrongQuestions.filter(w => {
                if (!showMastered && w.status === 'mastered') return false;
                if (filterSubject !== 'all' && w.question.subject !== filterSubject) return false;
                return true;
            });

            // æ’åº
            if (sortBy === 'time') {
                filtered.sort((a, b) => new Date(b.lastWrongTime) - new Date(a.lastWrongTime));
            } else if (sortBy === 'count') {
                filtered.sort((a, b) => b.wrongCount - a.wrongCount);
            }

            const subjectNames = { calculus: 'å¾®ç§¯åˆ†', linear: 'çº¿ä»£', probability: 'æ¦‚ç‡è®º' };

            if (filtered.length === 0) {
                return `
                    <div class="wrong-book-header">
                        ${renderWrongBookFilters()}
                    </div>
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‰</div>
                        <div class="empty-state-text">æš‚æ— é”™é¢˜</div>
                        <div class="empty-state-text" style="font-size: 14px; color: #aaa;">
                            åšé”™çš„é¢˜ç›®ä¼šè‡ªåŠ¨æ”¶å½•åˆ°è¿™é‡Œ
                        </div>
                    </div>
                `;
            }

            const listHTML = filtered.map(w => {
                const preview = w.question.question.length > 80
                    ? w.question.question.substring(0, 80) + '...'
                    : w.question.question;
                return `
                    <div class="wrong-item ${w.status === 'mastered' ? 'mastered' : ''}">
                        <div class="wrong-item-content">
                            <div class="wrong-item-header">
                                <span class="tag tag-${w.question.subject}">${subjectNames[w.question.subject]}</span>
                                <span class="wrong-count">é”™ ${w.wrongCount} æ¬¡</span>
                            </div>
                            <div class="wrong-item-question">${preview}</div>
                            <div class="wrong-item-time">æœ€è¿‘é”™è¯¯: ${new Date(w.lastWrongTime).toLocaleDateString()}</div>
                        </div>
                        <div class="wrong-item-actions">
                            <button class="btn btn-sm btn-primary" onclick="redoWrongQuestion('${w.id}')">é‡åš</button>
                            <button class="btn btn-sm btn-secondary" onclick="toggleMastered('${w.id}')">${w.status === 'mastered' ? 'å–æ¶ˆæŒæ¡' : 'å·²æŒæ¡'}</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteWrongQuestion('${w.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="wrong-book-header">
                    ${renderWrongBookFilters()}
                    <div class="wrong-book-actions">
                        <button class="btn btn-secondary" onclick="exportWrongBook('json')">å¯¼å‡ºJSON</button>
                        <button class="btn btn-secondary" onclick="exportWrongBook('md')">å¯¼å‡ºMarkdown</button>
                    </div>
                </div>
                <div class="wrong-book-stats">
                    å…± ${wrongQuestions.length} é“é”™é¢˜ï¼Œ${wrongQuestions.filter(w => w.status === 'mastered').length} é“å·²æŒæ¡
                </div>
                <div class="wrong-book-list">${listHTML}</div>
            `;
        }

        // é”™é¢˜æœ¬ç­›é€‰å™¨
        function renderWrongBookFilters() {
            return `
                <div class="wrong-filters">
                    <select id="filterWrongSubject" class="filter-select" onchange="refreshWrongBook()">
                        <option value="all">å…¨éƒ¨å­¦ç§‘</option>
                        <option value="calculus">å¾®ç§¯åˆ†</option>
                        <option value="linear">çº¿æ€§ä»£æ•°</option>
                        <option value="probability">æ¦‚ç‡è®º</option>
                    </select>
                    <select id="sortWrong" class="filter-select" onchange="refreshWrongBook()">
                        <option value="time">æŒ‰æ—¶é—´æ’åº</option>
                        <option value="count">æŒ‰é”™è¯¯æ¬¡æ•°</option>
                    </select>
                    <label class="checkbox-label">
                        <input type="checkbox" id="showMastered" onchange="refreshWrongBook()">
                        æ˜¾ç¤ºå·²æŒæ¡
                    </label>
                </div>
            `;
        }

        // åˆ·æ–°é”™é¢˜æœ¬
        function refreshWrongBook() {
            const contentDiv = document.getElementById('practice-content');
            contentDiv.innerHTML = renderWrongBook();
            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise([contentDiv]);
            }
        }

        // é‡åšé”™é¢˜
        function redoWrongQuestion(id) {
            const wrongQuestions = dataManager.load('wrongQuestions', []);
            const wrong = wrongQuestions.find(w => w.id === id);
            if (wrong) {
                exerciseState = {
                    questions: [wrong.question],
                    currentIndex: 0,
                    userAnswers: [null],
                    startTime: Date.now(),
                    isFinished: false
                };
                renderExerciseQuestions();
            }
        }

        // æ ‡è®°å·²æŒæ¡/å–æ¶ˆ
        function toggleMastered(id) {
            const wrongQuestions = dataManager.load('wrongQuestions', []);
            const wrong = wrongQuestions.find(w => w.id === id);
            if (wrong) {
                wrong.status = wrong.status === 'mastered' ? 'active' : 'mastered';
                dataManager.save('wrongQuestions', wrongQuestions);
                refreshWrongBook();
            }
        }

        // åˆ é™¤é”™é¢˜
        function deleteWrongQuestion(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™é“é”™é¢˜å—ï¼Ÿ')) return;
            let wrongQuestions = dataManager.load('wrongQuestions', []);
            wrongQuestions = wrongQuestions.filter(w => w.id !== id);
            dataManager.save('wrongQuestions', wrongQuestions);
            refreshWrongBook();
        }

        // å¯¼å‡ºé”™é¢˜æœ¬
        function exportWrongBook(format) {
            const wrongQuestions = dataManager.load('wrongQuestions', []);
            if (wrongQuestions.length === 0) {
                alert('é”™é¢˜æœ¬ä¸ºç©º');
                return;
            }

            let content, filename, type;
            const subjectNames = { calculus: 'å¾®ç§¯åˆ†', linear: 'çº¿æ€§ä»£æ•°', probability: 'æ¦‚ç‡è®º' };

            if (format === 'json') {
                content = JSON.stringify(wrongQuestions, null, 2);
                filename = `é”™é¢˜æœ¬_${new Date().toISOString().split('T')[0]}.json`;
                type = 'application/json';
            } else {
                content = `# é”™é¢˜æœ¬\n\nå¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n\n`;
                wrongQuestions.forEach((w, i) => {
                    content += `## ${i + 1}. ${subjectNames[w.question.subject]} (é”™${w.wrongCount}æ¬¡)\n\n`;
                    content += `**é¢˜ç›®:** ${w.question.question}\n\n`;
                    if (w.question.options) {
                        content += `**é€‰é¡¹:**\n${w.question.options.join('\n')}\n\n`;
                    }
                    content += `**æ­£ç¡®ç­”æ¡ˆ:** ${w.correctAnswer}\n\n`;
                    content += `**ä½ çš„ç­”æ¡ˆ:** ${w.userAnswer}\n\n`;
                    content += `**è§£æ:** ${w.question.explanation}\n\n---\n\n`;
                });
                filename = `é”™é¢˜æœ¬_${new Date().toISOString().split('T')[0]}.md`;
                type = 'text/markdown';
            }

            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========== ç»ƒä¹ è®°å½•ç»Ÿè®¡ ==========

        // ä¿å­˜ç»ƒä¹ è®°å½•
        function savePracticeRecord(record) {
            const history = dataManager.load('practiceHistory', []);
            history.push(record);
            dataManager.save('practiceHistory', history);
        }

        // åŠ è½½ç»ƒä¹ æµ‹è¯•æ ‡ç­¾é¡µå†…å®¹
        function loadPracticeTab(tabType) {
            const contentDiv = document.getElementById('practice-content');

            if (tabType === 'exam') {
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <button class="btn btn-primary" onclick="startExam()" style="font-size: 18px; padding: 15px 40px;">
                            ğŸ¯ å¼€å§‹æ¨¡æ‹Ÿè€ƒè¯•
                        </button>
                        <p style="margin-top: 15px; color: #666;">
                            æ¨¡æ‹Ÿè¯•å·åŒ…å«é€‰æ‹©é¢˜ã€å¡«ç©ºé¢˜ã€è§£ç­”é¢˜ï¼Œæ”¯æŒAIæ¢é¢˜å’Œè§£æåŠŸèƒ½
                        </p>
                    </div>
                `;
            } else if (tabType === 'exercise') {
                contentDiv.innerHTML = renderExerciseFilter();
            } else if (tabType === 'wrong') {
                contentDiv.innerHTML = renderWrongBook();
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([contentDiv]);
                }
            }
        }

        // å¼€å§‹æ¨¡æ‹Ÿè€ƒè¯•
        function startExam() {
            // æ‰“å¼€åŸæœ‰çš„æ¨¡æ‹Ÿè¯•å·æ–‡ä»¶
            window.open('è€ƒç ”æ•°å­¦ä¸€æ¨¡æ‹Ÿé¢˜.html', '_blank');
        }

        // ========== AIåŠ©æ•™æ¨¡å— (Phase 7) ==========

        // AIåŠ©æ•™çŠ¶æ€
        let tutorState = {
            currentConversationId: null,
            messages: [],
            isLoading: false,
            selectedImage: null  // å­˜å‚¨é€‰æ‹©çš„å›¾ç‰‡base64æ•°æ®
        };

        // å¤„ç†å›¾ç‰‡é€‰æ‹©
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶5MBï¼‰
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                return;
            }

            // è¯»å–å›¾ç‰‡ä¸ºbase64
            const reader = new FileReader();
            reader.onload = function(e) {
                tutorState.selectedImage = {
                    data: e.target.result,
                    type: file.type,
                    name: file.name
                };

                // æ˜¾ç¤ºé¢„è§ˆ
                const previewArea = document.getElementById('imagePreviewArea');
                const previewImage = document.getElementById('previewImage');
                if (previewArea && previewImage) {
                    previewImage.src = e.target.result;
                    previewArea.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        }

        // ç§»é™¤é€‰æ‹©çš„å›¾ç‰‡
        function removeSelectedImage() {
            tutorState.selectedImage = null;
            const previewArea = document.getElementById('imagePreviewArea');
            const imageUpload = document.getElementById('imageUpload');
            if (previewArea) {
                previewArea.style.display = 'none';
            }
            if (imageUpload) {
                imageUpload.value = '';
            }
        }

        // AIåŠ©æ•™è§†å›¾æ¸²æŸ“
        function renderAITutorView() {
            const container = document.getElementById('view-container');
            const conversations = loadConversationList();

            container.innerHTML = `
                <div class="tutor-container">
                    <!-- å·¦ä¾§å¯¹è¯å†å² -->
                    <div class="tutor-sidebar">
                        <div class="sidebar-header">
                            <h3>ğŸ’¬ å¯¹è¯å†å²</h3>
                            <button class="btn btn-primary btn-sm" onclick="createNewConversation()">
                                âœ¨ æ–°å¯¹è¯
                            </button>
                        </div>
                        <div class="conversation-search">
                            <input type="text" id="searchConversation" placeholder="æœç´¢å¯¹è¯..." oninput="filterConversations()">
                        </div>
                        <div class="conversation-list" id="conversationList">
                            ${renderConversationList(conversations)}
                        </div>
                        <div class="sidebar-actions">
                            <button class="btn btn-secondary btn-sm" onclick="exportCurrentChat('md')">ğŸ“„ å¯¼å‡ºMD</button>
                            <button class="btn btn-secondary btn-sm" onclick="exportCurrentChat('txt')">ğŸ“ å¯¼å‡ºTXT</button>
                        </div>
                    </div>

                    <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
                    <div class="tutor-main">
                        <!-- èŠå¤©æ¶ˆæ¯åŒº -->
                        <div class="chat-container" id="chatContainer">
                            ${renderChatMessages()}
                        </div>

                        <!-- å…¬å¼å·¥å…·æ  -->
                        <div class="formula-toolbar">
                            <div class="formula-buttons">
                                <button class="formula-btn" onclick="insertFormula('\\\\frac{}{}')" title="åˆ†æ•°">â…Ÿ</button>
                                <button class="formula-btn" onclick="insertFormula('\\\\sqrt{}')" title="æ ¹å·">âˆš</button>
                                <button class="formula-btn" onclick="insertFormula('^{}')" title="ä¸Šæ ‡">xÂ²</button>
                                <button class="formula-btn" onclick="insertFormula('_{}')" title="ä¸‹æ ‡">xâ‚</button>
                                <button class="formula-btn" onclick="insertFormula('\\\\sum_{i=1}^{n}')" title="æ±‚å’Œ">Î£</button>
                                <button class="formula-btn" onclick="insertFormula('\\\\int_{}^{}')" title="ç§¯åˆ†">âˆ«</button>
                                <button class="formula-btn" onclick="insertFormula('\\\\lim_{x \\\\to }')" title="æé™">lim</button>
                                <button class="formula-btn" onclick="insertFormula('\\\\partial ')" title="åå¯¼">âˆ‚</button>
                                <button class="formula-btn" onclick="insertFormula('\\\\infty')" title="æ— ç©·">âˆ</button>
                                <button class="formula-btn" onclick="insertFormula('\\\\alpha')" title="alpha">Î±</button>
                                <button class="formula-btn" onclick="insertFormula('\\\\beta')" title="beta">Î²</button>
                                <button class="formula-btn" onclick="insertFormula('\\\\lambda')" title="lambda">Î»</button>
                                <button class="formula-btn" onclick="insertFormula('\\\\pi')" title="pi">Ï€</button>
                                <button class="formula-btn" onclick="insertFormula('\\\\theta')" title="theta">Î¸</button>
                                <button class="formula-btn" onclick="insertFormula('\\\\begin{pmatrix}  \\\\\\\\  \\\\end{pmatrix}')" title="çŸ©é˜µ">[ ]</button>
                            </div>
                            <div class="formula-preview" id="formulaPreview">
                                <span class="preview-label">é¢„è§ˆ:</span>
                                <span class="preview-content" id="previewContent"></span>
                            </div>
                        </div>

                        <!-- è¾“å…¥åŒºåŸŸ -->
                        <div class="chat-input-container">
                            <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
                            <div class="image-preview-area" id="imagePreviewArea" style="display: none;">
                                <div class="preview-image-container">
                                    <img id="previewImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
                                    <button class="remove-image-btn" onclick="removeSelectedImage()">âœ•</button>
                                </div>
                            </div>
                            <textarea id="tutorInput"
                                      class="tutor-textarea"
                                      placeholder="è¾“å…¥æ•°å­¦é—®é¢˜... ä½¿ç”¨ $å…¬å¼$ è¾“å…¥LaTeXå…¬å¼ï¼Œæˆ–ä¸Šä¼ é¢˜ç›®å›¾ç‰‡"
                                      rows="3"
                                      oninput="updateFormulaPreview()"></textarea>
                            <div class="input-actions">
                                <div class="input-left-actions">
                                    <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                                    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('imageUpload').click()" title="ä¸Šä¼ å›¾ç‰‡">
                                        ğŸ“· ä¸Šä¼ å›¾ç‰‡
                                    </button>
                                    <span class="input-hint">æŒ‰ Ctrl+Enter å‘é€ | æ”¯æŒå›¾ç‰‡è¯†åˆ«</span>
                                </div>
                                <button class="btn btn-primary" onclick="sendTutorMessage()" id="sendBtn">
                                    ğŸ“¤ å‘é€
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ç»‘å®šé”®ç›˜äº‹ä»¶
            const textarea = document.getElementById('tutorInput');
            if (textarea) {
                textarea.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        sendTutorMessage();
                    }
                });
            }

            // åŠ è½½å½“å‰å¯¹è¯æˆ–åˆ›å»ºæ–°å¯¹è¯
            if (!tutorState.currentConversationId && conversations.length > 0) {
                loadConversation(conversations[0].id);
            } else if (tutorState.currentConversationId) {
                loadConversation(tutorState.currentConversationId);
            }

            // æ»šåŠ¨åˆ°åº•éƒ¨
            scrollChatToBottom();
        }

        // æ¸²æŸ“å¯¹è¯å†å²åˆ—è¡¨
        function renderConversationList(conversations) {
            if (conversations.length === 0) {
                return `<div class="no-conversations">æš‚æ— å¯¹è¯å†å²</div>`;
            }

            return conversations.map(conv => {
                const isActive = conv.id === tutorState.currentConversationId;
                const preview = conv.preview || 'æ–°å¯¹è¯';
                const date = new Date(conv.updatedAt).toLocaleDateString('zh-CN');

                return `
                    <div class="conversation-item ${isActive ? 'active' : ''}"
                         onclick="loadConversation('${conv.id}')">
                        <div class="conv-title">${conv.title || 'æ–°å¯¹è¯'}</div>
                        <div class="conv-preview">${preview.substring(0, 30)}${preview.length > 30 ? '...' : ''}</div>
                        <div class="conv-meta">
                            <span class="conv-date">${date}</span>
                            <button class="conv-delete" onclick="event.stopPropagation(); deleteConversation('${conv.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“èŠå¤©æ¶ˆæ¯
        function renderChatMessages() {
            if (tutorState.messages.length === 0) {
                return `
                    <div class="chat-welcome">
                        <div class="welcome-icon">ğŸ¤–</div>
                        <h2>ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIæ•°å­¦åŠ©æ•™</h2>
                        <p>æˆ‘å¯ä»¥å¸®åŠ©ä½ ï¼š</p>
                        <ul>
                            <li>ğŸ“– è§£ç­”æ•°å­¦æ¦‚å¿µå’Œå®šç†</li>
                            <li>âœï¸ è®²è§£é¢˜ç›®è§£é¢˜æ€è·¯</li>
                            <li>ğŸ” åˆ†æé”™é¢˜åŸå› </li>
                            <li>ğŸ’¡ æä¾›å­¦ä¹ å»ºè®®</li>
                        </ul>
                        <div class="quick-questions">
                            <p>å¿«é€Ÿæé—®:</p>
                            <button class="quick-btn" onclick="quickQuestion('ä»€ä¹ˆæ˜¯æ³°å‹’å±•å¼€ï¼Ÿè¯·ç»™å‡ºå¸¸ç”¨å‡½æ•°çš„å±•å¼€å¼ã€‚')">æ³°å‹’å±•å¼€</button>
                            <button class="quick-btn" onclick="quickQuestion('å¦‚ä½•åˆ¤æ–­çŸ©é˜µçš„ç›¸ä¼¼å¯¹è§’åŒ–ï¼Ÿ')">çŸ©é˜µå¯¹è§’åŒ–</button>
                            <button class="quick-btn" onclick="quickQuestion('è¯·è®²è§£å…¨æ¦‚ç‡å…¬å¼å’Œè´å¶æ–¯å…¬å¼çš„åŒºåˆ«ä¸åº”ç”¨ã€‚')">è´å¶æ–¯å…¬å¼</button>
                        </div>
                    </div>
                `;
            }

            return tutorState.messages.map((msg, idx) => {
                const isUser = msg.role === 'user';
                const time = new Date(msg.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                const hasImage = msg.image && isUser;

                return `
                    <div class="chat-message-wrapper ${isUser ? 'user' : 'assistant'}">
                        <div class="message-avatar">${isUser ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
                        <div class="message-bubble">
                            ${hasImage ? `<div class="message-image"><img src="${msg.image}" alt="ä¸Šä¼ çš„å›¾ç‰‡"></div>` : ''}
                            <div class="message-content">${formatMessageContent(msg.content)}</div>
                            <div class="message-time">${time}</div>
                        </div>
                    </div>
                `;
            }).join('') + (tutorState.isLoading ? `
                <div class="chat-message-wrapper assistant">
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            ` : '');
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆå¤„ç†å…¬å¼å’Œæ¢è¡Œï¼‰
        function formatMessageContent(content) {
            // è½¬ä¹‰HTML
            let formatted = content
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // å¤„ç†ä»£ç å—
            formatted = formatted.replace(/```([\s\S]*?)```/g, '<pre class="code-block">$1</pre>');

            // å¤„ç†è¡Œå†…ä»£ç 
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

            // æ¢è¡Œå¤„ç†
            formatted = formatted.replace(/\n/g, '<br>');

            return formatted;
        }

        // å‘é€æ¶ˆæ¯
        async function sendTutorMessage() {
            const input = document.getElementById('tutorInput');
            const content = input.value.trim();
            const hasImage = tutorState.selectedImage !== null;

            if (!content && !hasImage) return;
            if (tutorState.isLoading) return;

            if (!isAIConfigured()) {
                alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®AIæ¨¡å‹');
                viewManager.switchView('settings');
                return;
            }

            // å¦‚æœæ²¡æœ‰å½“å‰å¯¹è¯ï¼Œåˆ›å»ºä¸€ä¸ª
            if (!tutorState.currentConversationId) {
                createNewConversation();
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const userMessage = {
                role: 'user',
                content: content || 'è¯·åˆ†æè¿™å¼ å›¾ç‰‡ä¸­çš„æ•°å­¦é—®é¢˜',
                timestamp: new Date().toISOString(),
                image: hasImage ? tutorState.selectedImage.data : null
            };
            tutorState.messages.push(userMessage);

            // æ¸…ç©ºè¾“å…¥æ¡†å’Œå›¾ç‰‡
            input.value = '';
            const selectedImageData = tutorState.selectedImage;
            removeSelectedImage();
            updateFormulaPreview();

            // æ›´æ–°UI
            tutorState.isLoading = true;
            refreshChatContainer();
            scrollChatToBottom();

            try {
                // æ„å»ºå¯¹è¯å†å²ï¼ˆæœ€è¿‘10è½®ï¼‰
                const recentMessages = tutorState.messages.slice(-20);

                // æ·»åŠ ç³»ç»Ÿæç¤º
                const systemPrompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è€ƒç ”æ•°å­¦åŠ©æ•™ï¼Œæ“…é•¿è®²è§£é«˜ç­‰æ•°å­¦ã€çº¿æ€§ä»£æ•°å’Œæ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡ã€‚

ä½ çš„èŒè´£æ˜¯ï¼š
1. ç”¨æ¸…æ™°æ˜“æ‡‚çš„æ–¹å¼è§£ç­”æ•°å­¦é—®é¢˜
2. å¾ªå¾ªå–„è¯±ï¼Œå¼•å¯¼å­¦ç”Ÿæ€è€ƒ
3. æä¾›è¯¦ç»†çš„è§£é¢˜æ­¥éª¤
4. ä½¿ç”¨LaTeXæ ¼å¼ä¹¦å†™æ•°å­¦å…¬å¼ï¼ˆç”¨$åŒ…è£¹è¡Œå†…å…¬å¼ï¼Œ$$åŒ…è£¹ç‹¬ç«‹å…¬å¼ï¼‰
5. é’ˆå¯¹è€ƒç ”æ•°å­¦ä¸€çš„è€ƒç‚¹è¿›è¡Œè®²è§£
6. å¦‚æœç”¨æˆ·ä¸Šä¼ äº†å›¾ç‰‡ï¼Œä»”ç»†åˆ†æå›¾ç‰‡ä¸­çš„æ•°å­¦å†…å®¹å¹¶è§£ç­”

è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œä¿æŒä¸“ä¸šä½†å‹å–„çš„è¯­æ°”ã€‚`;

                // æ„å»ºæ¶ˆæ¯æ•°ç»„ï¼ˆæ”¯æŒå¤šæ¨¡æ€ï¼‰
                const messages = recentMessages.map((m, idx) => {
                    if (idx === 0) {
                        // ç¬¬ä¸€æ¡æ¶ˆæ¯é™„åŠ ç³»ç»Ÿæç¤º
                        if (m.image) {
                            return {
                                role: m.role,
                                content: [
                                    { type: 'text', text: systemPrompt + '\n\n' + m.content },
                                    {
                                        type: 'image',
                                        source: {
                                            type: 'base64',
                                            media_type: selectedImageData?.type || 'image/png',
                                            data: m.image.split(',')[1]
                                        }
                                    }
                                ]
                            };
                        } else {
                            return { role: m.role, content: systemPrompt + '\n\n' + m.content };
                        }
                    } else {
                        if (m.image) {
                            return {
                                role: m.role,
                                content: [
                                    { type: 'text', text: m.content },
                                    {
                                        type: 'image',
                                        source: {
                                            type: 'base64',
                                            media_type: 'image/png',
                                            data: m.image.split(',')[1]
                                        }
                                    }
                                ]
                            };
                        } else {
                            return { role: m.role, content: m.content };
                        }
                    }
                });

                // è°ƒç”¨AI
                const response = await callAI(messages, { maxTokens: 2000, temperature: 0.7 });

                // æ·»åŠ AIå›å¤
                const assistantMessage = {
                    role: 'assistant',
                    content: response,
                    timestamp: new Date().toISOString()
                };
                tutorState.messages.push(assistantMessage);

                // ä¿å­˜å¯¹è¯
                saveCurrentConversation();

            } catch (error) {
                console.error('AIè°ƒç”¨å¤±è´¥:', error);
                // æ·»åŠ é”™è¯¯æç¤ºæ¶ˆæ¯
                tutorState.messages.push({
                    role: 'assistant',
                    content: `âŒ è¯·æ±‚å¤±è´¥: ${error.message}\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–AIé…ç½®ã€‚`,
                    timestamp: new Date().toISOString()
                });
            } finally {
                tutorState.isLoading = false;
                refreshChatContainer();
                scrollChatToBottom();
                // é‡æ–°æ¸²æŸ“MathJax
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([document.getElementById('chatContainer')]);
                }
            }
        }

        // åˆ·æ–°èŠå¤©å®¹å™¨
        function refreshChatContainer() {
            const container = document.getElementById('chatContainer');
            if (container) {
                container.innerHTML = renderChatMessages();
            }
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollChatToBottom() {
            const container = document.getElementById('chatContainer');
            if (container) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }
        }

        // æ’å…¥å…¬å¼
        function insertFormula(formula) {
            const textarea = document.getElementById('tutorInput');
            if (!textarea) return;

            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;

            // å¦‚æœå…¬å¼ä¸æ˜¯å•ç‹¬ç¬¦å·ï¼ŒåŠ ä¸Š$åŒ…è£¹
            const insertText = formula.includes(' ') || formula.includes('{') ? `$${formula}$` : formula;

            textarea.value = text.substring(0, start) + insertText + text.substring(end);
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = start + insertText.length;

            updateFormulaPreview();
        }

        // æ›´æ–°å…¬å¼é¢„è§ˆ
        function updateFormulaPreview() {
            const textarea = document.getElementById('tutorInput');
            const previewContent = document.getElementById('previewContent');
            if (!textarea || !previewContent) return;

            const text = textarea.value;
            // æå–æœ€åä¸€ä¸ªå…¬å¼
            const formulaMatch = text.match(/\$([^$]+)\$(?!.*\$)/);

            if (formulaMatch) {
                previewContent.innerHTML = `$${formulaMatch[1]}$`;
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([previewContent]);
                }
            } else {
                previewContent.innerHTML = '<span style="color: #999;">è¾“å…¥ $å…¬å¼$ é¢„è§ˆ</span>';
            }
        }

        // å¿«é€Ÿæé—®
        function quickQuestion(question) {
            const input = document.getElementById('tutorInput');
            if (input) {
                input.value = question;
                sendTutorMessage();
            }
        }

        // ========== å¯¹è¯å†å²ç®¡ç† ==========

        // åŠ è½½å¯¹è¯åˆ—è¡¨
        function loadConversationList() {
            return dataManager.load('tutorConversations', []);
        }

        // ä¿å­˜å¯¹è¯åˆ—è¡¨
        function saveConversationList(conversations) {
            dataManager.save('tutorConversations', conversations);
        }

        // åˆ›å»ºæ–°å¯¹è¯
        function createNewConversation() {
            const newId = 'conv-' + Date.now();
            const conversations = loadConversationList();

            const newConv = {
                id: newId,
                title: 'æ–°å¯¹è¯',
                preview: '',
                messages: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            conversations.unshift(newConv);
            saveConversationList(conversations);

            tutorState.currentConversationId = newId;
            tutorState.messages = [];

            refreshConversationList();
            refreshChatContainer();
        }

        // åŠ è½½å¯¹è¯
        function loadConversation(convId) {
            const conversations = loadConversationList();
            const conv = conversations.find(c => c.id === convId);

            if (conv) {
                tutorState.currentConversationId = convId;
                tutorState.messages = conv.messages || [];
                refreshConversationList();
                refreshChatContainer();
                scrollChatToBottom();

                // é‡æ–°æ¸²æŸ“MathJax
                if (window.MathJax && window.MathJax.typesetPromise) {
                    setTimeout(() => {
                        MathJax.typesetPromise([document.getElementById('chatContainer')]);
                    }, 100);
                }
            }
        }

        // ä¿å­˜å½“å‰å¯¹è¯
        function saveCurrentConversation() {
            if (!tutorState.currentConversationId) return;

            const conversations = loadConversationList();
            const idx = conversations.findIndex(c => c.id === tutorState.currentConversationId);

            if (idx !== -1) {
                // ç”Ÿæˆæ ‡é¢˜ï¼ˆå–ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯çš„å‰20å­—ï¼‰
                const firstUserMsg = tutorState.messages.find(m => m.role === 'user');
                const title = firstUserMsg ? firstUserMsg.content.substring(0, 20) + (firstUserMsg.content.length > 20 ? '...' : '') : 'æ–°å¯¹è¯';

                // ç”Ÿæˆé¢„è§ˆï¼ˆæœ€åä¸€æ¡æ¶ˆæ¯ï¼‰
                const lastMsg = tutorState.messages[tutorState.messages.length - 1];
                const preview = lastMsg ? lastMsg.content.substring(0, 50) : '';

                conversations[idx].title = title;
                conversations[idx].preview = preview;
                conversations[idx].messages = tutorState.messages;
                conversations[idx].updatedAt = new Date().toISOString();

                // å°†æœ€è¿‘æ›´æ–°çš„å¯¹è¯ç§»åˆ°æœ€å‰é¢
                const conv = conversations.splice(idx, 1)[0];
                conversations.unshift(conv);

                saveConversationList(conversations);
                refreshConversationList();
            }
        }

        // åˆ é™¤å¯¹è¯
        function deleteConversation(convId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) return;

            let conversations = loadConversationList();
            conversations = conversations.filter(c => c.id !== convId);
            saveConversationList(conversations);

            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯
            if (convId === tutorState.currentConversationId) {
                if (conversations.length > 0) {
                    loadConversation(conversations[0].id);
                } else {
                    tutorState.currentConversationId = null;
                    tutorState.messages = [];
                    refreshChatContainer();
                }
            }

            refreshConversationList();
        }

        // åˆ·æ–°å¯¹è¯åˆ—è¡¨
        function refreshConversationList() {
            const listContainer = document.getElementById('conversationList');
            if (listContainer) {
                listContainer.innerHTML = renderConversationList(loadConversationList());
            }
        }

        // æœç´¢/ç­›é€‰å¯¹è¯
        function filterConversations() {
            const searchInput = document.getElementById('searchConversation');
            const keyword = searchInput ? searchInput.value.toLowerCase() : '';

            let conversations = loadConversationList();

            if (keyword) {
                conversations = conversations.filter(conv =>
                    conv.title.toLowerCase().includes(keyword) ||
                    conv.preview.toLowerCase().includes(keyword) ||
                    (conv.messages && conv.messages.some(m => m.content.toLowerCase().includes(keyword)))
                );
            }

            const listContainer = document.getElementById('conversationList');
            if (listContainer) {
                listContainer.innerHTML = renderConversationList(conversations);
            }
        }

        // ========== å¯¼å‡ºåŠŸèƒ½ ==========

        // å¯¼å‡ºå½“å‰å¯¹è¯
        function exportCurrentChat(format) {
            if (tutorState.messages.length === 0) {
                alert('å½“å‰å¯¹è¯ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º');
                return;
            }

            const conversations = loadConversationList();
            const conv = conversations.find(c => c.id === tutorState.currentConversationId);
            const title = conv ? conv.title : 'å¯¹è¯è®°å½•';
            const date = new Date().toISOString().split('T')[0];

            let content, filename, type;

            if (format === 'md') {
                content = `# ${title}\n\nå¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n\n---\n\n`;
                tutorState.messages.forEach(msg => {
                    const role = msg.role === 'user' ? '**ğŸ‘¤ æˆ‘**' : '**ğŸ¤– AIåŠ©æ•™**';
                    const time = new Date(msg.timestamp).toLocaleString();
                    content += `${role} (${time})\n\n${msg.content}\n\n---\n\n`;
                });
                filename = `AIåŠ©æ•™å¯¹è¯_${title}_${date}.md`;
                type = 'text/markdown';
            } else {
                content = `${title}\nå¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n${'='.repeat(50)}\n\n`;
                tutorState.messages.forEach(msg => {
                    const role = msg.role === 'user' ? '[æˆ‘]' : '[AIåŠ©æ•™]';
                    const time = new Date(msg.timestamp).toLocaleString();
                    content += `${role} ${time}\n${msg.content}\n\n${'- '.repeat(25)}\n\n`;
                });
                filename = `AIåŠ©æ•™å¯¹è¯_${title}_${date}.txt`;
                type = 'text/plain';
            }

            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========== å­¦ä¹ ç»Ÿè®¡æ¨¡å— (Phase 8) ==========

        // è®¡ç®—ç»¼åˆç»Ÿè®¡æ•°æ®
        function calculateStatistics() {
            const practiceHistory = dataManager.load('practiceHistory', []);
            const wrongQuestions = dataManager.load('wrongQuestions', []);
            const learningProgress = dataManager.load('learningProgress', {});

            // æ€»é¢˜æ•°å’Œæ­£ç¡®æ•°
            let totalQuestions = 0;
            let correctCount = 0;
            const dailyData = {};

            practiceHistory.forEach(record => {
                if (record.results) {
                    record.results.forEach(r => {
                        totalQuestions++;
                        if (r.correct) correctCount++;
                    });
                }
                // æŒ‰æ—¥æœŸèšåˆ
                const dateKey = record.date ? record.date.split('T')[0] : new Date().toISOString().split('T')[0];
                if (!dailyData[dateKey]) {
                    dailyData[dateKey] = { questions: 0, correct: 0 };
                }
                if (record.results) {
                    dailyData[dateKey].questions += record.results.length;
                    dailyData[dateKey].correct += record.results.filter(r => r.correct).length;
                }
            });

            // å­¦ä¹ å¤©æ•°
            const studyDays = Object.keys(dailyData).length;

            // ä»Šæ—¥æ•°æ®
            const today = new Date().toISOString().split('T')[0];
            const todayData = dailyData[today] || { questions: 0, correct: 0 };

            // çŸ¥è¯†ç‚¹æŒæ¡åº¦
            const subjectMastery = getSubjectMastery(learningProgress);

            return {
                totalQuestions,
                correctCount,
                accuracy: totalQuestions > 0 ? ((correctCount / totalQuestions) * 100).toFixed(1) : 0,
                studyDays,
                todayQuestions: todayData.questions,
                wrongCount: wrongQuestions.length,
                dailyData,
                subjectMastery
            };
        }

        // è·å–å­¦ç§‘æŒæ¡åº¦
        function getSubjectMastery(learningProgress) {
            const subjects = {
                calculus: { total: 0, learned: 0, label: 'å¾®ç§¯åˆ†' },
                linear: { total: 0, learned: 0, label: 'çº¿æ€§ä»£æ•°' },
                probability: { total: 0, learned: 0, label: 'æ¦‚ç‡è®º' }
            };

            // ä» knowledge-data.js è·å–çŸ¥è¯†ç‚¹åˆ†å¸ƒ
            if (typeof knowledgeData !== 'undefined') {
                knowledgeData.forEach(topic => {
                    let subjectKey = 'calculus';
                    if (topic.title.includes('çº¿æ€§ä»£æ•°') || topic.title.includes('çŸ©é˜µ') || topic.title.includes('è¡Œåˆ—å¼')) {
                        subjectKey = 'linear';
                    } else if (topic.title.includes('æ¦‚ç‡') || topic.title.includes('éšæœº') || topic.title.includes('æ•°ç†ç»Ÿè®¡')) {
                        subjectKey = 'probability';
                    }

                    topic.children.forEach(chapter => {
                        chapter.points.forEach(point => {
                            subjects[subjectKey].total++;
                            if (learningProgress[point.id] && learningProgress[point.id].status === 'learned') {
                                subjects[subjectKey].learned++;
                            }
                        });
                    });
                });
            }

            return {
                calculus: subjects.calculus.total > 0 ? Math.round((subjects.calculus.learned / subjects.calculus.total) * 100) : 0,
                linear: subjects.linear.total > 0 ? Math.round((subjects.linear.learned / subjects.linear.total) * 100) : 0,
                probability: subjects.probability.total > 0 ? Math.round((subjects.probability.learned / subjects.probability.total) * 100) : 0
            };
        }

        // è·å–æ¯æ—¥èšåˆæ•°æ®ï¼ˆæœ€è¿‘Nå¤©ï¼‰
        function getDailyAggregation(days = 30) {
            const practiceHistory = dataManager.load('practiceHistory', []);
            const result = [];
            const today = new Date();

            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];

                let questions = 0;
                let correct = 0;

                practiceHistory.forEach(record => {
                    const recordDate = record.date ? record.date.split('T')[0] : '';
                    if (recordDate === dateKey && record.results) {
                        questions += record.results.length;
                        correct += record.results.filter(r => r.correct).length;
                    }
                });

                result.push({
                    date: dateKey,
                    questions,
                    correct,
                    accuracy: questions > 0 ? ((correct / questions) * 100).toFixed(1) : 0
                });
            }

            return result;
        }

        // è·å–é”™é¢˜åˆ†å¸ƒ
        function getWrongDistribution() {
            const wrongQuestions = dataManager.load('wrongQuestions', []);
            const distribution = {
                'å¾®ç§¯åˆ†': 0,
                'çº¿æ€§ä»£æ•°': 0,
                'æ¦‚ç‡è®º': 0
            };

            wrongQuestions.forEach(q => {
                const subject = q.subject || 'å¾®ç§¯åˆ†';
                if (subject.includes('çº¿æ€§') || subject.includes('çŸ©é˜µ')) {
                    distribution['çº¿æ€§ä»£æ•°']++;
                } else if (subject.includes('æ¦‚ç‡') || subject.includes('éšæœº')) {
                    distribution['æ¦‚ç‡è®º']++;
                } else {
                    distribution['å¾®ç§¯åˆ†']++;
                }
            });

            return distribution;
        }

        // è·å–çŸ¥è¯†ç‚¹ç»´åº¦æ•°æ®ï¼ˆç”¨äºé›·è¾¾å›¾ï¼‰
        function getKnowledgeDimensions() {
            const learningProgress = dataManager.load('learningProgress', {});
            const practiceHistory = dataManager.load('practiceHistory', []);

            // 6ä¸ªç»´åº¦
            const dimensions = {
                'æé™ä¸è¿ç»­': { learned: 0, total: 10, practiced: 0 },
                'å¾®åˆ†å­¦': { learned: 0, total: 15, practiced: 0 },
                'ç§¯åˆ†å­¦': { learned: 0, total: 12, practiced: 0 },
                'çº¿æ€§ä»£æ•°': { learned: 0, total: 10, practiced: 0 },
                'æ¦‚ç‡è®º': { learned: 0, total: 8, practiced: 0 },
                'æ•°ç†ç»Ÿè®¡': { learned: 0, total: 5, practiced: 0 }
            };

            // ç»Ÿè®¡å·²å­¦ä¹ æ•°é‡
            Object.values(learningProgress).forEach(p => {
                if (p.status === 'learned') {
                    // ç®€åŒ–å¤„ç†ï¼šå¹³å‡åˆ†é…
                    const keys = Object.keys(dimensions);
                    const idx = Math.floor(Math.random() * keys.length);
                    dimensions[keys[idx]].learned++;
                }
            });

            // è®¡ç®—æŒæ¡åº¦ç™¾åˆ†æ¯”
            return Object.entries(dimensions).map(([name, data]) => ({
                name,
                value: data.total > 0 ? Math.min(100, Math.round((data.learned / data.total) * 100)) : 0
            }));
        }

        // å­¦ä¹ ç»Ÿè®¡è§†å›¾æ¸²æŸ“
        function renderStatisticsView() {
            const container = document.getElementById('view-container');
            const stats = calculateStatistics();
            const wrongDist = getWrongDistribution();

            container.innerHTML = `
                <div class="statistics-page">
                    <!-- é¡µé¢æ ‡é¢˜å’Œæ“ä½œæ  -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸ“ˆ å­¦ä¹ ç»Ÿè®¡</div>
                            <div class="report-actions">
                                <button class="btn btn-primary" onclick="generateLearningReport()">
                                    ğŸ“„ ç”ŸæˆæŠ¥å‘Š
                                </button>
                                <button class="btn btn-secondary" onclick="exportStatisticsJSON()">
                                    ğŸ“¥ å¯¼å‡ºJSON
                                </button>
                                <button class="btn btn-secondary" onclick="exportStatisticsCSV()">
                                    ğŸ“Š å¯¼å‡ºCSV
                                </button>
                            </div>
                        </div>

                        <!-- ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡ -->
                        <div class="statistics-overview">
                            <div class="stat-card stat-card-primary">
                                <div class="stat-icon">ğŸ“</div>
                                <div class="stat-content">
                                    <div class="stat-value">${stats.totalQuestions}</div>
                                    <div class="stat-label">æ€»ç»ƒä¹ é¢˜æ•°</div>
                                </div>
                            </div>
                            <div class="stat-card stat-card-success">
                                <div class="stat-icon">âœ…</div>
                                <div class="stat-content">
                                    <div class="stat-value">${stats.accuracy}%</div>
                                    <div class="stat-label">æ€»æ­£ç¡®ç‡</div>
                                </div>
                            </div>
                            <div class="stat-card stat-card-warning">
                                <div class="stat-icon">ğŸ“…</div>
                                <div class="stat-content">
                                    <div class="stat-value">${stats.studyDays}</div>
                                    <div class="stat-label">å­¦ä¹ å¤©æ•°</div>
                                </div>
                            </div>
                            <div class="stat-card stat-card-danger">
                                <div class="stat-icon">âŒ</div>
                                <div class="stat-content">
                                    <div class="stat-value">${stats.wrongCount}</div>
                                    <div class="stat-label">é”™é¢˜æ•°</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å›¾è¡¨åŒºåŸŸ -->
                    <div class="charts-grid">
                        <!-- çŸ¥è¯†ç‚¹æŒæ¡é›·è¾¾å›¾ -->
                        <div class="card chart-card">
                            <h3 class="chart-title">ğŸ“Š çŸ¥è¯†ç‚¹æŒæ¡åº¦</h3>
                            <div class="chart-container">
                                <canvas id="mastery-radar-chart"></canvas>
                            </div>
                        </div>

                        <!-- æ­£ç¡®ç‡è¶‹åŠ¿æŠ˜çº¿å›¾ -->
                        <div class="card chart-card">
                            <h3 class="chart-title">ğŸ“ˆ æ­£ç¡®ç‡è¶‹åŠ¿ï¼ˆè¿‘7å¤©ï¼‰</h3>
                            <div class="chart-container">
                                <canvas id="accuracy-line-chart"></canvas>
                            </div>
                        </div>

                        <!-- é”™é¢˜åˆ†å¸ƒé¥¼å›¾ -->
                        <div class="card chart-card">
                            <h3 class="chart-title">ğŸ¥§ é”™é¢˜åˆ†å¸ƒ</h3>
                            <div class="chart-container">
                                <canvas id="wrong-pie-chart"></canvas>
                            </div>
                        </div>

                        <!-- æ¯æ—¥ç»ƒä¹ é‡æŸ±çŠ¶å›¾ -->
                        <div class="card chart-card">
                            <h3 class="chart-title">ğŸ“Š æ¯æ—¥ç»ƒä¹ é‡ï¼ˆè¿‘7å¤©ï¼‰</h3>
                            <div class="chart-container">
                                <canvas id="daily-bar-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- å­¦ä¹ çƒ­åŠ›å›¾ -->
                    <div class="card">
                        <h3 class="chart-title">ğŸ“… å­¦ä¹ çƒ­åŠ›å›¾ï¼ˆè¿‘3ä¸ªæœˆï¼‰</h3>
                        <div class="heatmap-container" id="cal-heatmap"></div>
                        <div class="heatmap-legend">
                            <span>å°‘</span>
                            <div class="heatmap-legend-scale">
                                <div class="legend-item" style="background: #ebedf0;"></div>
                                <div class="legend-item" style="background: #9be9a8;"></div>
                                <div class="legend-item" style="background: #40c463;"></div>
                                <div class="legend-item" style="background: #30a14e;"></div>
                                <div class="legend-item" style="background: #216e39;"></div>
                            </div>
                            <span>å¤š</span>
                        </div>
                    </div>

                    <!-- å­¦ç§‘è¿›åº¦ -->
                    <div class="card">
                        <h3 class="chart-title">ğŸ“š å­¦ç§‘å­¦ä¹ è¿›åº¦</h3>
                        <div class="subject-progress-bars">
                            <div class="subject-progress-item">
                                <div class="subject-info">
                                    <span class="subject-name">å¾®ç§¯åˆ†</span>
                                    <span class="subject-percent">${stats.subjectMastery.calculus}%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar progress-bar-blue" style="width: ${stats.subjectMastery.calculus}%"></div>
                                </div>
                            </div>
                            <div class="subject-progress-item">
                                <div class="subject-info">
                                    <span class="subject-name">çº¿æ€§ä»£æ•°</span>
                                    <span class="subject-percent">${stats.subjectMastery.linear}%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar progress-bar-green" style="width: ${stats.subjectMastery.linear}%"></div>
                                </div>
                            </div>
                            <div class="subject-progress-item">
                                <div class="subject-info">
                                    <span class="subject-name">æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡</span>
                                    <span class="subject-percent">${stats.subjectMastery.probability}%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar progress-bar-orange" style="width: ${stats.subjectMastery.probability}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
            setTimeout(() => {
                initMasteryRadarChart();
                initAccuracyLineChart();
                initWrongPieChart();
                initDailyBarChart();
                initHeatmapCalendar();
            }, 100);
        }

        // åˆå§‹åŒ–é›·è¾¾å›¾
        function initMasteryRadarChart() {
            const ctx = document.getElementById('mastery-radar-chart');
            if (!ctx) return;

            const dimensions = getKnowledgeDimensions();

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: dimensions.map(d => d.name),
                    datasets: [{
                        label: 'æŒæ¡åº¦',
                        data: dimensions.map(d => d.value),
                        backgroundColor: 'rgba(33, 150, 243, 0.2)',
                        borderColor: '#2196F3',
                        borderWidth: 2,
                        pointBackgroundColor: '#2196F3',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#2196F3'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20,
                                font: { size: 10 }
                            },
                            pointLabels: {
                                font: { size: 11 }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // åˆå§‹åŒ–æ­£ç¡®ç‡æŠ˜çº¿å›¾
        function initAccuracyLineChart() {
            const ctx = document.getElementById('accuracy-line-chart');
            if (!ctx) return;

            const dailyData = getDailyAggregation(7);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyData.map(d => d.date.slice(5)),
                    datasets: [{
                        label: 'æ­£ç¡®ç‡',
                        data: dailyData.map(d => parseFloat(d.accuracy)),
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#4CAF50'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: value => value + '%'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: context => `æ­£ç¡®ç‡: ${context.raw}%`
                            }
                        }
                    }
                }
            });
        }

        // åˆå§‹åŒ–é”™é¢˜é¥¼å›¾
        function initWrongPieChart() {
            const ctx = document.getElementById('wrong-pie-chart');
            if (!ctx) return;

            const wrongDist = getWrongDistribution();
            const total = Object.values(wrongDist).reduce((a, b) => a + b, 0);

            if (total === 0) {
                ctx.parentElement.innerHTML = '<div class="empty-chart-hint">æš‚æ— é”™é¢˜æ•°æ®</div>';
                return;
            }

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(wrongDist),
                    datasets: [{
                        data: Object.values(wrongDist),
                        backgroundColor: ['#2196F3', '#4CAF50', '#FF9800'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15 }
                        }
                    }
                }
            });
        }

        // åˆå§‹åŒ–æ¯æ—¥ç»ƒä¹ é‡æŸ±çŠ¶å›¾
        function initDailyBarChart() {
            const ctx = document.getElementById('daily-bar-chart');
            if (!ctx) return;

            const dailyData = getDailyAggregation(7);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dailyData.map(d => d.date.slice(5)),
                    datasets: [{
                        label: 'ç»ƒä¹ é¢˜æ•°',
                        data: dailyData.map(d => d.questions),
                        backgroundColor: '#9C27B0',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // åˆå§‹åŒ–çƒ­åŠ›å›¾æ—¥å†
        function initHeatmapCalendar() {
            const container = document.getElementById('cal-heatmap');
            if (!container || typeof CalHeatmap === 'undefined') {
                if (container) {
                    container.innerHTML = '<div class="empty-chart-hint">çƒ­åŠ›å›¾åº“åŠ è½½å¤±è´¥</div>';
                }
                return;
            }

            const dailyData = getDailyAggregation(90);
            const heatmapData = dailyData.map(d => ({
                date: d.date,
                value: d.questions
            })).filter(d => d.value > 0);

            const cal = new CalHeatmap();
            cal.paint({
                itemSelector: '#cal-heatmap',
                domain: {
                    type: 'month',
                    gutter: 4,
                    label: { text: 'MMæœˆ', textAlign: 'start', position: 'top' }
                },
                subDomain: {
                    type: 'day',
                    radius: 2,
                    width: 15,
                    height: 15,
                    gutter: 3
                },
                data: {
                    source: heatmapData,
                    x: 'date',
                    y: 'value'
                },
                date: {
                    start: new Date(new Date().setMonth(new Date().getMonth() - 2)),
                    highlight: [new Date()]
                },
                scale: {
                    color: {
                        type: 'threshold',
                        range: ['#ebedf0', '#9be9a8', '#40c463', '#30a14e', '#216e39'],
                        domain: [1, 3, 5, 10]
                    }
                }
            });
        }

        // å¯¼å‡ºç»Ÿè®¡æ•°æ®ä¸ºJSON
        function exportStatisticsJSON() {
            const stats = calculateStatistics();
            const dailyData = getDailyAggregation(30);
            const wrongDist = getWrongDistribution();

            const exportData = {
                overview: stats,
                dailyHistory: dailyData,
                wrongDistribution: wrongDist,
                exportTime: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å­¦ä¹ ç»Ÿè®¡_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // å¯¼å‡ºç»Ÿè®¡æ•°æ®ä¸ºCSV
        function exportStatisticsCSV() {
            const dailyData = getDailyAggregation(30);

            let csv = 'æ—¥æœŸ,ç»ƒä¹ é¢˜æ•°,æ­£ç¡®æ•°,æ­£ç¡®ç‡\n';
            dailyData.forEach(d => {
                csv += `${d.date},${d.questions},${d.correct},${d.accuracy}%\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å­¦ä¹ ç»Ÿè®¡_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ç”Ÿæˆå­¦ä¹ æŠ¥å‘Š
        function generateLearningReport() {
            const stats = calculateStatistics();
            const dailyData = getDailyAggregation(7);
            const wrongDist = getWrongDistribution();

            const reportHTML = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è€ƒç ”æ•°å­¦å­¦ä¹ æŠ¥å‘Š</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #2196F3; text-align: center; }
        h2 { color: #333; border-bottom: 2px solid #2196F3; padding-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
        .stat-box { background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-box .value { font-size: 28px; font-weight: bold; color: #2196F3; }
        .stat-box .label { color: #666; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #2196F3; color: white; }
        .footer { text-align: center; color: #999; margin-top: 40px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ“š è€ƒç ”æ•°å­¦å­¦ä¹ æŠ¥å‘Š</h1>
    <p style="text-align: center; color: #666;">ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}</p>

    <h2>ğŸ“Š å­¦ä¹ æ¦‚è§ˆ</h2>
    <div class="stats-grid">
        <div class="stat-box">
            <div class="value">${stats.totalQuestions}</div>
            <div class="label">æ€»ç»ƒä¹ é¢˜æ•°</div>
        </div>
        <div class="stat-box">
            <div class="value">${stats.accuracy}%</div>
            <div class="label">æ€»æ­£ç¡®ç‡</div>
        </div>
        <div class="stat-box">
            <div class="value">${stats.studyDays}</div>
            <div class="label">å­¦ä¹ å¤©æ•°</div>
        </div>
        <div class="stat-box">
            <div class="value">${stats.wrongCount}</div>
            <div class="label">é”™é¢˜æ•°</div>
        </div>
    </div>

    <h2>ğŸ“… è¿‘7å¤©å­¦ä¹ è®°å½•</h2>
    <table>
        <tr><th>æ—¥æœŸ</th><th>ç»ƒä¹ é¢˜æ•°</th><th>æ­£ç¡®æ•°</th><th>æ­£ç¡®ç‡</th></tr>
        ${dailyData.map(d => `<tr><td>${d.date}</td><td>${d.questions}</td><td>${d.correct}</td><td>${d.accuracy}%</td></tr>`).join('')}
    </table>

    <h2>ğŸ“š å­¦ç§‘æŒæ¡åº¦</h2>
    <table>
        <tr><th>å­¦ç§‘</th><th>æŒæ¡åº¦</th></tr>
        <tr><td>å¾®ç§¯åˆ†</td><td>${stats.subjectMastery.calculus}%</td></tr>
        <tr><td>çº¿æ€§ä»£æ•°</td><td>${stats.subjectMastery.linear}%</td></tr>
        <tr><td>æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡</td><td>${stats.subjectMastery.probability}%</td></tr>
    </table>

    <h2>âŒ é”™é¢˜åˆ†å¸ƒ</h2>
    <table>
        <tr><th>å­¦ç§‘</th><th>é”™é¢˜æ•°</th></tr>
        ${Object.entries(wrongDist).map(([k, v]) => `<tr><td>${k}</td><td>${v}</td></tr>`).join('')}
    </table>

    <h2>ğŸ’¡ å­¦ä¹ å»ºè®®</h2>
    <ul>
        ${stats.accuracy < 60 ? '<li>æ­£ç¡®ç‡åä½ï¼Œå»ºè®®åŠ å¼ºåŸºç¡€æ¦‚å¿µå¤ä¹ </li>' : ''}
        ${stats.studyDays < 7 ? '<li>å­¦ä¹ å¤©æ•°è¾ƒå°‘ï¼Œå»ºè®®ä¿æŒæ¯æ—¥å­¦ä¹ ä¹ æƒ¯</li>' : ''}
        ${stats.wrongCount > 20 ? '<li>é”™é¢˜è¾ƒå¤šï¼Œå»ºè®®å®šæœŸå¤ä¹ é”™é¢˜æœ¬</li>' : ''}
        ${stats.subjectMastery.calculus < 50 ? '<li>å¾®ç§¯åˆ†æŒæ¡åº¦ä¸è¶³ï¼Œå»ºè®®é‡ç‚¹å¼ºåŒ–</li>' : ''}
        ${stats.subjectMastery.linear < 50 ? '<li>çº¿æ€§ä»£æ•°æŒæ¡åº¦ä¸è¶³ï¼Œå»ºè®®é‡ç‚¹å¼ºåŒ–</li>' : ''}
        ${stats.subjectMastery.probability < 50 ? '<li>æ¦‚ç‡è®ºæŒæ¡åº¦ä¸è¶³ï¼Œå»ºè®®é‡ç‚¹å¼ºåŒ–</li>' : ''}
        <li>åšæŒæ¯æ—¥ç»ƒä¹ ï¼ŒæŒç»­æå‡!</li>
    </ul>

    <div class="footer">
        è€ƒç ”æ•°å­¦å­¦ä¹ åŠ©æ‰‹ - è‡ªåŠ¨ç”ŸæˆæŠ¥å‘Š
    </div>
</body>
</html>`;

            const blob = new Blob([reportHTML], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å­¦ä¹ æŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // è®¾ç½®
        function renderSettingsView() {
            const container = document.getElementById('view-container');
            const settings = loadSettings();
            const storageInfo = dataManager.getStorageInfo();

            container.innerHTML = `
                <div class="settings-page">
                    <!-- å­¦ä¹ åå¥½è®¾ç½® -->
                    <div class="card settings-card">
                        <div class="card-header">
                            <div class="card-title">ğŸ“š å­¦ä¹ åå¥½è®¾ç½®</div>
                        </div>
                        <div class="settings-form">
                            <div class="settings-row">
                                <label>æ¯æ—¥å­¦ä¹ ç›®æ ‡æ—¶é•¿</label>
                                <select id="dailyStudyHours" onchange="saveSettings()">
                                    ${[1,2,3,4,5,6,7,8].map(h =>
                                        `<option value="${h}" ${settings.dailyStudyHours === h ? 'selected' : ''}>${h}å°æ—¶</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="settings-row">
                                <label>è€ƒç ”ç›®æ ‡åˆ†æ•°</label>
                                <input type="number" id="targetScore" min="90" max="150"
                                       value="${settings.targetScore}" onchange="saveSettings()">
                            </div>
                            <div class="settings-row">
                                <label>è–„å¼±ç§‘ç›®ï¼ˆå¯å¤šé€‰ï¼‰</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="weakCalculus"
                                               ${settings.weakSubjects.includes('calculus') ? 'checked' : ''}
                                               onchange="saveSettings()">
                                        å¾®ç§¯åˆ†
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="weakLinearAlgebra"
                                               ${settings.weakSubjects.includes('linearAlgebra') ? 'checked' : ''}
                                               onchange="saveSettings()">
                                        çº¿æ€§ä»£æ•°
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="weakProbability"
                                               ${settings.weakSubjects.includes('probability') ? 'checked' : ''}
                                               onchange="saveSettings()">
                                        æ¦‚ç‡è®º
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AIæ¨¡å‹é…ç½® -->
                    <div class="card settings-card ai-config-section">
                        <div class="card-header">
                            <div class="card-title">ğŸ¤– AIæ¨¡å‹é…ç½®</div>
                        </div>
                        <div class="ai-config-form">
                            <div class="settings-row">
                                <label>AIå‚å•†</label>
                                <select id="settingsAiProvider" onchange="onSettingsProviderChange()">
                                    <option value="claude">Claude (Anthropic)</option>
                                    <option value="deepseek">Deepseek</option>
                                    <option value="zhipu">æ™ºè°±AI (GLM)</option>
                                    <option value="openai">OpenAIå…¼å®¹API</option>
                                </select>
                            </div>
                            <div class="settings-row">
                                <label>API Key</label>
                                <input type="password" id="settingsApiKey" placeholder="è¯·è¾“å…¥API Key">
                            </div>
                            <div class="settings-row">
                                <label>Base URL</label>
                                <input type="text" id="settingsBaseUrl" placeholder="APIåŸºç¡€åœ°å€">
                            </div>
                            <div class="settings-row">
                                <label>æ¨¡å‹</label>
                                <select id="settingsApiModel">
                                    <!-- åŠ¨æ€å¡«å…… -->
                                </select>
                            </div>
                            <div class="settings-row" id="customModelRow" style="display: none;">
                                <label>è‡ªå®šä¹‰æ¨¡å‹ID</label>
                                <input type="text" id="settingsCustomModelId" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹ID">
                            </div>
                            <div class="settings-row">
                                <div id="settingsConnectionStatus" class="connection-status"></div>
                            </div>
                            <div class="ai-config-buttons">
                                <button class="btn btn-secondary" onclick="testSettingsAIConnection()">
                                    ğŸ”— æµ‹è¯•è¿æ¥
                                </button>
                                <button class="btn btn-primary" onclick="saveSettingsAIConfig()">
                                    ğŸ’¾ ä¿å­˜é…ç½®
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ -->
                    <div class="card settings-card">
                        <div class="card-header">
                            <div class="card-title">ğŸ’¾ å­˜å‚¨ç©ºé—´</div>
                        </div>
                        <div class="storage-info">
                            <div class="storage-bar">
                                <div class="storage-used" style="width: ${Math.min((storageInfo.totalSize / (5 * 1024 * 1024)) * 100, 100).toFixed(1)}%"></div>
                            </div>
                            <div class="storage-text">
                                å·²ä½¿ç”¨ ${storageInfo.totalSizeKB} KB / 5 MBï¼ˆ${storageInfo.itemCount} é¡¹æ•°æ®ï¼‰
                            </div>
                            <div class="storage-details" id="storageDetails" style="display: none;">
                                ${Object.entries(storageInfo.items).map(([key, size]) =>
                                    `<div class="storage-item"><span>${getDataLabel(key)}</span><span>${(size/1024).toFixed(2)} KB</span></div>`
                                ).join('')}
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="toggleStorageDetails()">
                                æŸ¥çœ‹è¯¦æƒ…
                            </button>
                        </div>
                    </div>

                    <!-- æ•°æ®å¯¼å‡º -->
                    <div class="card settings-card">
                        <div class="card-header">
                            <div class="card-title">ğŸ“¤ æ•°æ®å¯¼å‡º</div>
                        </div>
                        <div class="export-section">
                            <p class="section-desc">å¯¼å‡ºå­¦ä¹ æ•°æ®ä»¥ä¾¿å¤‡ä»½æˆ–è¿ç§»åˆ°å…¶ä»–è®¾å¤‡ã€‚</p>
                            <div class="export-buttons">
                                <button class="btn btn-primary" onclick="dataManager.exportAllData()">
                                    ğŸ“¦ å¯¼å‡ºå…¨éƒ¨æ•°æ®
                                </button>
                                <button class="btn btn-secondary" onclick="exportLearningRecords()">
                                    ğŸ“š å¯¼å‡ºå­¦ä¹ è®°å½•
                                </button>
                                <button class="btn btn-secondary" onclick="exportWrongQuestions()">
                                    ğŸ“ å¯¼å‡ºé”™é¢˜æœ¬
                                </button>
                                <button class="btn btn-secondary" onclick="exportAIConversations()">
                                    ğŸ’¬ å¯¼å‡ºAIå¯¹è¯
                                </button>
                                <button class="btn btn-secondary" onclick="exportStudyPlans()">
                                    ğŸ“… å¯¼å‡ºå­¦ä¹ è§„åˆ’
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- æ•°æ®å¯¼å…¥ -->
                    <div class="card settings-card">
                        <div class="card-header">
                            <div class="card-title">ğŸ“¥ æ•°æ®å¯¼å…¥</div>
                        </div>
                        <div class="import-section">
                            <p class="section-desc">ä»å¤‡ä»½æ–‡ä»¶æ¢å¤å­¦ä¹ æ•°æ®ã€‚å¯¼å…¥å°†è¦†ç›–ç°æœ‰åŒç±»æ•°æ®ã€‚</p>
                            <input type="file" id="importFileInput" accept=".json" style="display: none;"
                                   onchange="handleFileSelected(event)">
                            <button class="btn btn-warning" onclick="handleImportData()">
                                ğŸ“¥ é€‰æ‹©æ–‡ä»¶å¯¼å…¥
                            </button>
                        </div>
                    </div>

                    <!-- æ•°æ®æ¸…ç©º -->
                    <div class="card settings-card">
                        <div class="card-header">
                            <div class="card-title">ğŸ—‘ï¸ æ•°æ®æ¸…ç©º</div>
                        </div>
                        <div class="clear-section">
                            <p class="section-desc warning-text">ä»¥ä¸‹æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼å»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚</p>
                            <div class="clear-buttons">
                                <button class="btn btn-outline" onclick="clearLearningRecords()">
                                    æ¸…ç©ºå­¦ä¹ è®°å½•
                                </button>
                                <button class="btn btn-outline" onclick="clearWrongQuestions()">
                                    æ¸…ç©ºé”™é¢˜æœ¬
                                </button>
                                <button class="btn btn-outline" onclick="clearAIConversations()">
                                    æ¸…ç©ºAIå¯¹è¯
                                </button>
                                <button class="btn btn-outline" onclick="clearStudyPlans()">
                                    æ¸…ç©ºå­¦ä¹ è§„åˆ’
                                </button>
                                <button class="btn btn-danger" onclick="handleClearData()">
                                    âš ï¸ æ¸…ç©ºå…¨éƒ¨æ•°æ®
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- å…³äº -->
                    <div class="card settings-card">
                        <div class="card-header">
                            <div class="card-title">â„¹ï¸ å…³äº</div>
                        </div>
                        <div class="about-section">
                            <div class="about-info">
                                <h4>è€ƒç ”æ•°å­¦å­¦ä¹ åŠ©æ‰‹ v2.0.0</h4>
                                <p>ä¸€ç«™å¼è€ƒç ”æ•°å­¦ä¸€å­¦ä¹ å¹³å°ï¼Œé›†çŸ¥è¯†ç‚¹å­¦ä¹ ã€æ™ºèƒ½è§„åˆ’ã€ç»ƒä¹ æµ‹è¯•ã€AIåŠ©æ•™äºä¸€ä½“ã€‚</p>
                                <ul>
                                    <li>ğŸ“š 50+ æ ¸å¿ƒçŸ¥è¯†ç‚¹è¦†ç›–å¾®ç§¯åˆ†ã€çº¿æ€§ä»£æ•°ã€æ¦‚ç‡è®º</li>
                                    <li>ğŸ“… æ™ºèƒ½å­¦ä¹ è§„åˆ’ï¼Œæ”¯æŒAIä¸ªæ€§åŒ–è°ƒæ•´</li>
                                    <li>âœï¸ ä¸“é¡¹ç»ƒä¹ ä¸é”™é¢˜æœ¬ç®¡ç†</li>
                                    <li>ğŸ¤– AIåŠ©æ•™å®æ—¶ç­”ç–‘</li>
                                    <li>ğŸ“Š å­¦ä¹ ç»Ÿè®¡ä¸æ•°æ®å¯è§†åŒ–</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // åŠ è½½AIé…ç½®åˆ°è¡¨å•
            setTimeout(loadSettingsAIConfig, 50);
        }

        // è·å–æ•°æ®é¡¹ä¸­æ–‡æ ‡ç­¾
        function getDataLabel(key) {
            const labels = {
                'userData': 'ç”¨æˆ·æ•°æ®',
                'progress': 'å­¦ä¹ è¿›åº¦',
                'learningProgress': 'çŸ¥è¯†ç‚¹è¿›åº¦',
                'learningNotes': 'å­¦ä¹ ç¬”è®°',
                'knowledgeTree': 'çŸ¥è¯†ç‚¹æ ‘',
                'wrongQuestions': 'é”™é¢˜æœ¬',
                'practiceHistory': 'ç»ƒä¹ å†å²',
                'studyPlans': 'å­¦ä¹ è§„åˆ’',
                'statistics': 'ç»Ÿè®¡æ•°æ®',
                'aiConversations': 'AIå¯¹è¯',
                'aiConfig': 'AIé…ç½®',
                'currentView': 'å½“å‰è§†å›¾',
                'settings': 'è®¾ç½®'
            };
            return labels[key] || key;
        }

        // åˆ‡æ¢å­˜å‚¨è¯¦æƒ…æ˜¾ç¤º
        function toggleStorageDetails() {
            const details = document.getElementById('storageDetails');
            if (details) {
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
            }
        }

        // åŠ è½½è®¾ç½®
        function loadSettings() {
            return dataManager.load('settings', {
                dailyStudyHours: 4,
                targetScore: 130,
                weakSubjects: []
            });
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            const settings = {
                dailyStudyHours: parseInt(document.getElementById('dailyStudyHours')?.value) || 4,
                targetScore: parseInt(document.getElementById('targetScore')?.value) || 130,
                weakSubjects: []
            };

            if (document.getElementById('weakCalculus')?.checked) {
                settings.weakSubjects.push('calculus');
            }
            if (document.getElementById('weakLinearAlgebra')?.checked) {
                settings.weakSubjects.push('linearAlgebra');
            }
            if (document.getElementById('weakProbability')?.checked) {
                settings.weakSubjects.push('probability');
            }

            dataManager.save('settings', settings);
        }

        // ========== åˆ†ç±»å¯¼å‡ºåŠŸèƒ½ ==========

        // å¯¼å‡ºå­¦ä¹ è®°å½•
        function exportLearningRecords() {
            const data = {
                progress: dataManager.load('progress'),
                learningProgress: dataManager.load('learningProgress'),
                learningNotes: dataManager.load('learningNotes'),
                exportTime: new Date().toISOString(),
                type: 'learningRecords',
                version: '2.0.0'
            };
            downloadJSON(data, 'å­¦ä¹ è®°å½•');
        }

        // å¯¼å‡ºé”™é¢˜æœ¬
        function exportWrongQuestions() {
            const wrongQuestions = dataManager.load('wrongQuestions');
            if (!wrongQuestions || wrongQuestions.length === 0) {
                alert('é”™é¢˜æœ¬ä¸ºç©ºï¼Œæ— æ•°æ®å¯å¯¼å‡º');
                return;
            }
            const data = {
                wrongQuestions: wrongQuestions,
                exportTime: new Date().toISOString(),
                type: 'wrongQuestions',
                version: '2.0.0'
            };
            downloadJSON(data, 'é”™é¢˜æœ¬');
        }

        // å¯¼å‡ºAIå¯¹è¯
        function exportAIConversations() {
            const aiConversations = dataManager.load('aiConversations');
            if (!aiConversations || aiConversations.length === 0) {
                alert('AIå¯¹è¯è®°å½•ä¸ºç©ºï¼Œæ— æ•°æ®å¯å¯¼å‡º');
                return;
            }
            const data = {
                aiConversations: aiConversations,
                exportTime: new Date().toISOString(),
                type: 'aiConversations',
                version: '2.0.0'
            };
            downloadJSON(data, 'AIå¯¹è¯');
        }

        // å¯¼å‡ºå­¦ä¹ è§„åˆ’
        function exportStudyPlans() {
            const studyPlans = dataManager.load('studyPlans');
            if (!studyPlans) {
                alert('å­¦ä¹ è§„åˆ’ä¸ºç©ºï¼Œæ— æ•°æ®å¯å¯¼å‡º');
                return;
            }
            const data = {
                studyPlans: studyPlans,
                exportTime: new Date().toISOString(),
                type: 'studyPlans',
                version: '2.0.0'
            };
            downloadJSON(data, 'å­¦ä¹ è§„åˆ’');
        }

        // ä¸‹è½½JSONæ–‡ä»¶çš„é€šç”¨å‡½æ•°
        function downloadJSON(data, name) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è€ƒç ”æ•°å­¦${name}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ========== åˆ†ç±»æ¸…ç©ºåŠŸèƒ½ ==========

        // æ¸…ç©ºå­¦ä¹ è®°å½•
        function clearLearningRecords() {
            const count = countLearningRecords();
            if (count === 0) {
                alert('å­¦ä¹ è®°å½•å·²ç»ä¸ºç©º');
                return;
            }
            if (!confirm(`ç¡®å®šè¦æ¸…ç©ºå­¦ä¹ è®°å½•å—ï¼Ÿ\n\nå°†åˆ é™¤ï¼š\n- å­¦ä¹ è¿›åº¦æ•°æ®\n- çŸ¥è¯†ç‚¹å­¦ä¹ çŠ¶æ€\n- å­¦ä¹ ç¬”è®°\n\nå…±è®¡ ${count} é¡¹æ•°æ®\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            if (!confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦æ¸…ç©ºå­¦ä¹ è®°å½•å—ï¼Ÿ')) {
                return;
            }
            dataManager.remove('progress');
            dataManager.remove('learningProgress');
            dataManager.remove('learningNotes');
            alert('å­¦ä¹ è®°å½•å·²æ¸…ç©ºï¼');
            renderSettingsView();
        }

        // æ¸…ç©ºé”™é¢˜æœ¬
        function clearWrongQuestions() {
            const wrongQuestions = dataManager.load('wrongQuestions', []);
            if (wrongQuestions.length === 0) {
                alert('é”™é¢˜æœ¬å·²ç»ä¸ºç©º');
                return;
            }
            if (!confirm(`ç¡®å®šè¦æ¸…ç©ºé”™é¢˜æœ¬å—ï¼Ÿ\n\nå°†åˆ é™¤ ${wrongQuestions.length} é“é”™é¢˜è®°å½•\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            if (!confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦æ¸…ç©ºé”™é¢˜æœ¬å—ï¼Ÿ')) {
                return;
            }
            dataManager.remove('wrongQuestions');
            alert('é”™é¢˜æœ¬å·²æ¸…ç©ºï¼');
            renderSettingsView();
        }

        // æ¸…ç©ºAIå¯¹è¯
        function clearAIConversations() {
            const conversations = dataManager.load('aiConversations', []);
            if (conversations.length === 0) {
                alert('AIå¯¹è¯è®°å½•å·²ç»ä¸ºç©º');
                return;
            }
            if (!confirm(`ç¡®å®šè¦æ¸…ç©ºAIå¯¹è¯è®°å½•å—ï¼Ÿ\n\nå°†åˆ é™¤ ${conversations.length} æ¡å¯¹è¯\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            if (!confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦æ¸…ç©ºAIå¯¹è¯å—ï¼Ÿ')) {
                return;
            }
            dataManager.remove('aiConversations');
            alert('AIå¯¹è¯è®°å½•å·²æ¸…ç©ºï¼');
            renderSettingsView();
        }

        // æ¸…ç©ºå­¦ä¹ è§„åˆ’
        function clearStudyPlans() {
            const plans = dataManager.load('studyPlans');
            if (!plans) {
                alert('å­¦ä¹ è§„åˆ’å·²ç»ä¸ºç©º');
                return;
            }
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºå­¦ä¹ è§„åˆ’å—ï¼Ÿ\n\nå°†åˆ é™¤æ‰€æœ‰å­¦ä¹ è®¡åˆ’å’Œæ¯æ—¥ä»»åŠ¡\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            if (!confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦æ¸…ç©ºå­¦ä¹ è§„åˆ’å—ï¼Ÿ')) {
                return;
            }
            dataManager.remove('studyPlans');
            alert('å­¦ä¹ è§„åˆ’å·²æ¸…ç©ºï¼');
            renderSettingsView();
        }

        // ç»Ÿè®¡å­¦ä¹ è®°å½•æ•°é‡
        function countLearningRecords() {
            let count = 0;
            if (dataManager.has('progress')) count++;
            if (dataManager.has('learningProgress')) count++;
            if (dataManager.has('learningNotes')) count++;
            return count;
        }

        // ========== è¾…åŠ©åŠŸèƒ½å‡½æ•° ==========

        // å¤„ç†å¯¼å…¥æ•°æ®
        function handleImportData() {
            document.getElementById('importFileInput').click();
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        async function handleFileSelected(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const data = await dataManager.importData(file);
                alert(`æ•°æ®å¯¼å…¥æˆåŠŸ!\nå¯¼å‡ºæ—¶é—´: ${new Date(data.exportTime).toLocaleString()}`);
                location.reload(); // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨æ–°æ•°æ®
            } catch (error) {
                alert(`æ•°æ®å¯¼å…¥å¤±è´¥: ${error.message}`);
            }

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            event.target.value = '';
        }

        // å¤„ç†æ¸…ç©ºæ•°æ®
        function handleClearData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—?\n\næ­¤æ“ä½œä¸å¯æ¢å¤,å»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½!')) {
                return;
            }

            if (!confirm('å†æ¬¡ç¡®è®¤: çœŸçš„è¦æ¸…ç©ºæ‰€æœ‰å­¦ä¹ æ•°æ®å—?')) {
                return;
            }

            dataManager.clearAllData();
            alert('æ•°æ®å·²æ¸…ç©º!');
            location.reload();
        }

        // ========== åˆå§‹åŒ– ==========
        window.onload = function() {
            console.log('è€ƒç ”æ•°å­¦å­¦ä¹ åŠ©æ‰‹ v2.0.0');
            console.log('ç³»ç»Ÿåˆå§‹åŒ–ä¸­...');

            // æ³¨å†Œè§†å›¾
            viewManager.register('dashboard', renderDashboard);
            viewManager.register('practice', renderPracticeView);
            viewManager.register('ai-tutor', renderAITutorView);
            viewManager.register('statistics', renderStatisticsView);
            viewManager.register('settings', renderSettingsView);

            // åŠ è½½ä¸Šæ¬¡çš„è§†å›¾
            viewManager.loadLastView();

            // ç»‘å®šå¯¼èˆªç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.nav-menu li').forEach(li => {
                li.addEventListener('click', function() {
                    const view = this.dataset.view;
                    if (view) {
                        viewManager.switchView(view);
                    }
                });
            });

            // åˆå§‹åŒ–æ–°æ‰‹å¼•å¯¼å’ŒAIçŠ¶æ€
            initOnboarding();
            updateAIStatus();

            console.log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ!');
        };

        // ========== æ–°æ‰‹å¼•å¯¼ç³»ç»Ÿ ==========

        // åˆå§‹åŒ–æ–°æ‰‹å¼•å¯¼
        function initOnboarding() {
            const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');
            if (!hasSeenOnboarding) {
                showOnboarding();
            }
            // æ£€æŸ¥AIé…ç½®çŠ¶æ€ï¼Œæ˜¾ç¤ºæç¤ºæ¡
            checkAndShowAIBanner();
        }

        // æ˜¾ç¤ºæ–°æ‰‹å¼•å¯¼
        function showOnboarding() {
            const overlay = document.getElementById('onboarding-overlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }

        // å…³é—­æ–°æ‰‹å¼•å¯¼
        function closeOnboarding() {
            const overlay = document.getElementById('onboarding-overlay');
            const dontShowAgain = document.getElementById('dontShowAgain');

            if (overlay) {
                overlay.style.display = 'none';
            }

            // å¦‚æœå‹¾é€‰äº†ä¸å†æ˜¾ç¤ºï¼Œä¿å­˜çŠ¶æ€
            if (dontShowAgain && dontShowAgain.checked) {
                localStorage.setItem('hasSeenOnboarding', 'true');
            } else {
                // å³ä½¿æ²¡å‹¾é€‰ï¼Œé¦–æ¬¡ä½¿ç”¨åä¹Ÿè®°å½•å·²çœ‹è¿‡
                localStorage.setItem('hasSeenOnboarding', 'true');
            }
        }

        // è·³è½¬åˆ°AIè®¾ç½®
        function goToAISettings() {
            closeOnboarding();
            hideAIBanner();
            viewManager.switchView('settings');
            // æ»šåŠ¨åˆ°AIé…ç½®åŒºåŸŸï¼ˆå»¶è¿Ÿæ‰§è¡Œä»¥ç­‰å¾…è§†å›¾æ¸²æŸ“ï¼‰
            setTimeout(() => {
                const aiConfigSection = document.querySelector('.ai-config-section');
                if (aiConfigSection) {
                    aiConfigSection.scrollIntoView({ behavior: 'smooth' });
                }
            }, 100);
        }

        // æ£€æŸ¥å¹¶æ˜¾ç¤ºAIé…ç½®æç¤ºæ¡
        function checkAndShowAIBanner() {
            const bannerDismissed = sessionStorage.getItem('aiBannerDismissed');
            if (!bannerDismissed && !isAIConfigured()) {
                showAIBanner();
            }
        }

        // æ˜¾ç¤ºAIé…ç½®æç¤ºæ¡
        function showAIBanner() {
            const banner = document.getElementById('ai-config-banner');
            if (banner) {
                banner.style.display = 'block';
            }
        }

        // éšè—AIé…ç½®æç¤ºæ¡
        function hideAIBanner() {
            const banner = document.getElementById('ai-config-banner');
            if (banner) {
                banner.style.display = 'none';
            }
            // æœ¬æ¬¡ä¼šè¯å†…ä¸å†æ˜¾ç¤º
            sessionStorage.setItem('aiBannerDismissed', 'true');
        }

        // æ›´æ–°AIçŠ¶æ€æŒ‡ç¤ºå™¨
        function updateAIStatus() {
            const statusDot = document.getElementById('aiStatusDot');
            const statusText = document.getElementById('aiStatusText');
            const indicator = document.getElementById('aiStatusIndicator');

            if (!statusDot || !statusText) return;

            const configured = isAIConfigured();

            if (configured) {
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'AIå·²è¿æ¥';
                indicator.title = 'ç‚¹å‡»è¿›å…¥AIè®¾ç½®';
            } else {
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'AIæœªé…ç½®';
                indicator.title = 'ç‚¹å‡»é…ç½®AI';
            }
        }

        // é‡æ–°æ˜¾ç¤ºæ–°æ‰‹å¼•å¯¼ï¼ˆç”¨äºè®¾ç½®é¡µé¢çš„"æŸ¥çœ‹å¼•å¯¼"æŒ‰é’®ï¼‰
        function reopenOnboarding() {
            showOnboarding();
        }

        // ========== è®¾ç½®é¡µé¢AIé…ç½®åŠŸèƒ½ ==========

        // è®¾ç½®é¡µé¢å‚å•†åˆ‡æ¢å¤„ç†
        function onSettingsProviderChange() {
            const provider = document.getElementById('settingsAiProvider').value;
            const modelSelect = document.getElementById('settingsApiModel');
            const baseUrlInput = document.getElementById('settingsBaseUrl');
            const customModelRow = document.getElementById('customModelRow');

            // æ›´æ–°æ¨¡å‹åˆ—è¡¨
            if (modelSelect && AI_PROVIDERS[provider]) {
                const models = AI_PROVIDERS[provider].models;
                modelSelect.innerHTML = models.map(m =>
                    `<option value="${m.id}">${m.name}</option>`
                ).join('');
            }

            // æ›´æ–°Base URL
            if (baseUrlInput && AI_PROVIDERS[provider]) {
                baseUrlInput.value = AI_PROVIDERS[provider].baseUrl;
            }

            // æ˜¾ç¤º/éšè—è‡ªå®šä¹‰æ¨¡å‹è¾“å…¥
            if (customModelRow) {
                customModelRow.style.display = provider === 'openai' ? 'block' : 'none';
            }
        }

        // æµ‹è¯•è®¾ç½®é¡µé¢çš„AIè¿æ¥
        async function testSettingsAIConnection() {
            const provider = document.getElementById('settingsAiProvider').value;
            const key = document.getElementById('settingsApiKey').value.trim();
            const baseUrl = document.getElementById('settingsBaseUrl').value.trim();
            let modelId = document.getElementById('settingsApiModel').value;
            const statusDiv = document.getElementById('settingsConnectionStatus');

            if (provider === 'openai') {
                const customModel = document.getElementById('settingsCustomModelId').value.trim();
                if (customModel) modelId = customModel;
            }

            if (!key) {
                statusDiv.innerHTML = '<span style="color: #F44336;">è¯·è¾“å…¥API Key</span>';
                return;
            }

            statusDiv.innerHTML = '<span style="color: #FF9800;">æ­£åœ¨æµ‹è¯•è¿æ¥...</span>';

            try {
                const testAdapter = new AIModelAdapter(provider, key, modelId, baseUrl);
                await testAdapter.chat([{ role: 'user', content: 'ä½ å¥½ï¼Œè¯·å›å¤"è¿æ¥æˆåŠŸ"' }], { maxTokens: 50 });
                statusDiv.innerHTML = '<span style="color: #4CAF50;">âœ“ è¿æ¥æˆåŠŸï¼</span>';
            } catch (error) {
                statusDiv.innerHTML = `<span style="color: #F44336;">âœ— è¿æ¥å¤±è´¥: ${error.message}</span>`;
            }
        }

        // ä¿å­˜è®¾ç½®é¡µé¢çš„AIé…ç½®
        function saveSettingsAIConfig() {
            const provider = document.getElementById('settingsAiProvider').value;
            const key = document.getElementById('settingsApiKey').value.trim();
            const baseUrl = document.getElementById('settingsBaseUrl').value.trim();
            let modelId = document.getElementById('settingsApiModel').value;

            if (provider === 'openai') {
                const customModel = document.getElementById('settingsCustomModelId').value.trim();
                if (customModel) modelId = customModel;
            }

            if (!key) {
                alert('è¯·è¾“å…¥API Key');
                return;
            }

            // ä¿å­˜åˆ°ç»Ÿä¸€çš„é…ç½®é”®
            const config = {
                provider: provider,
                apiKey: key,
                modelId: modelId,
                baseUrl: baseUrl || AI_PROVIDERS[provider]?.baseUrl
            };
            localStorage.setItem('mathHelper_aiConfig', JSON.stringify(config));

            // åˆå§‹åŒ–é€‚é…å™¨
            initAIAdapter(provider, key, modelId, config.baseUrl);

            // æ›´æ–°AIçŠ¶æ€
            updateAIStatus();
            hideAIBanner();

            alert('AIé…ç½®å·²ä¿å­˜ï¼');
        }

        // åŠ è½½è®¾ç½®é¡µé¢çš„AIé…ç½®ï¼ˆåœ¨æ¸²æŸ“è®¾ç½®é¡µé¢åè°ƒç”¨ï¼‰
        function loadSettingsAIConfig() {
            try {
                const configStr = localStorage.getItem('mathHelper_aiConfig');
                if (configStr) {
                    const config = JSON.parse(configStr);

                    const providerSelect = document.getElementById('settingsAiProvider');
                    const keyInput = document.getElementById('settingsApiKey');
                    const baseUrlInput = document.getElementById('settingsBaseUrl');
                    const modelSelect = document.getElementById('settingsApiModel');
                    const customModelInput = document.getElementById('settingsCustomModelId');
                    const customModelRow = document.getElementById('customModelRow');

                    if (providerSelect) providerSelect.value = config.provider || 'claude';

                    // å…ˆæ›´æ–°æ¨¡å‹åˆ—è¡¨
                    onSettingsProviderChange();

                    if (keyInput) keyInput.value = config.apiKey || '';
                    if (baseUrlInput) baseUrlInput.value = config.baseUrl || '';
                    if (modelSelect && config.provider !== 'openai') {
                        modelSelect.value = config.modelId || '';
                    }
                    if (customModelInput && config.provider === 'openai') {
                        customModelInput.value = config.modelId || '';
                    }
                    if (customModelRow) {
                        customModelRow.style.display = config.provider === 'openai' ? 'block' : 'none';
                    }
                } else {
                    // æ²¡æœ‰é…ç½®ï¼Œåˆå§‹åŒ–é»˜è®¤çŠ¶æ€
                    onSettingsProviderChange();
                }
            } catch (error) {
                console.error('åŠ è½½AIé…ç½®å¤±è´¥:', error);
                onSettingsProviderChange();
            }
        }
    </script>

    <!-- å¤–éƒ¨è„šæœ¬ -->
    <script src="js/ai-adapter.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/knowledge-data.js"></script>
    <script src="js/knowledge-module.js"></script>
    <script src="js/plan-module.js"></script>
</body>
</html>
