<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒç ”æ•°å­¦ä¸€æ¨¡æ‹Ÿè¯•å·</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
        }

        /* å¤´éƒ¨æ ·å¼ */
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2196F3;
            font-size: 28px;
        }

        .header-controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .timer {
            font-size: 24px;
            color: #333;
            font-weight: bold;
        }

        .mode-switch {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .mode-switch:hover {
            background: #1976D2;
        }

        /* ä¸»ä½“åŒºåŸŸ */
        .main-content {
            flex: 1;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 280px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar h3 {
            color: #2196F3;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .answer-card {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .card-item {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .card-item:hover {
            border-color: #2196F3;
        }

        .card-item.answered {
            background: #E3F2FD;
            border-color: #2196F3;
        }

        .card-item.correct {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .card-item.wrong {
            background: #F44336;
            color: white;
            border-color: #F44336;
        }

        /* é¢˜ç›®æ ·å¼ */
        .question {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .question-score {
            color: #F44336;
            font-weight: bold;
        }

        .question-content {
            margin: 15px 0;
            line-height: 1.8;
            font-size: 15px;
        }

        /* é€‰æ‹©é¢˜é€‰é¡¹ */
        .options {
            margin: 15px 0;
        }

        .option {
            display: block;
            padding: 12px 15px;
            margin: 8px 0;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .option:hover {
            border-color: #2196F3;
            background: #E3F2FD;
        }

        .option input[type="radio"] {
            margin-right: 10px;
        }

        .option.selected {
            border-color: #2196F3;
            background: #E3F2FD;
        }

        .option.correct {
            border-color: #4CAF50;
            background: #E8F5E9;
        }

        .option.wrong {
            border-color: #F44336;
            background: #FFEBEE;
        }

        /* å¡«ç©ºé¢˜è¾“å…¥æ¡† */
        .blank-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .blank-input:focus {
            outline: none;
            border-color: #2196F3;
        }

        .blank-input.correct {
            border-color: #4CAF50;
            background: #E8F5E9;
        }

        .blank-input.wrong {
            border-color: #F44336;
            background: #FFEBEE;
        }

        /* è§£ç­”é¢˜æ–‡æœ¬æ¡† */
        .solve-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 15px;
            resize: vertical;
            font-family: inherit;
        }

        .solve-textarea:focus {
            outline: none;
            border-color: #2196F3;
        }

        /* ç­”æ¡ˆè§£æ */
        .explanation {
            margin-top: 15px;
            padding: 15px;
            background: #FFF9C4;
            border-left: 4px solid #FBC02D;
            border-radius: 5px;
            display: none;
        }

        .explanation.show {
            display: block;
        }

        .explanation-title {
            font-weight: bold;
            color: #F57C00;
            margin-bottom: 8px;
        }

        .view-answer-btn {
            background: #FF9800;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .view-answer-btn:hover {
            background: #F57C00;
        }

        /* åº•éƒ¨æŒ‰é’® */
        .footer {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .submit-btn, .reset-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn {
            background: #4CAF50;
            color: white;
        }

        .submit-btn:hover {
            background: #45a049;
        }

        .reset-btn {
            background: #f44336;
            color: white;
        }

        .reset-btn:hover {
            background: #da190b;
        }

        /* æˆç»©æ˜¾ç¤º */
        .score-display {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }

        .score-display.show {
            display: block;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e0e0e0;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: static;
            }

            .answer-card {
                grid-template-columns: repeat(10, 1fr);
            }
        }

        /* åˆ†èŠ‚æ ‡é¢˜ */
        .section-title {
            background: #2196F3;
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            margin: 30px 0 20px 0;
            font-size: 18px;
            font-weight: bold;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        /* æ¨¡å¼æŒ‡ç¤ºå™¨ */
        .mode-indicator {
            display: inline-block;
            padding: 5px 12px;
            background: #4CAF50;
            color: white;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }

        /* AIæ¢é¢˜åŠŸèƒ½æ ·å¼ */
        .refresh-btn {
            background: #9C27B0;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #7B1FA2;
        }

        .refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .refresh-btn.loading {
            position: relative;
        }

        .refresh-btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* APIé…ç½®æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #2196F3;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .modal-btn-primary {
            background: #2196F3;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #1976D2;
        }

        .modal-btn-secondary {
            background: #ccc;
            color: #333;
        }

        .modal-btn-secondary:hover {
            background: #bbb;
        }

        .api-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }

        .api-status.active {
            background: #4CAF50;
            color: white;
        }

        .api-status.inactive {
            background: #f44336;
            color: white;
        }

        .settings-btn {
            background: #FF9800;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        .settings-btn:hover {
            background: #F57C00;
        }

        /* å•é¢˜æ¢é¢˜æŒ‰é’®æ ·å¼ */
        .question-refresh-btn {
            background: #9C27B0;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .question-refresh-btn:hover {
            background: #7B1FA2;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .question-refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .question-refresh-btn.loading::before {
            content: 'âŸ³';
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        /* AIè§£ææŒ‰é’®æ ·å¼ */
        .ai-explanation-btn {
            background: linear-gradient(135deg, #FF9800, #FF5722);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            margin-left: 10px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .ai-explanation-btn:hover {
            background: linear-gradient(135deg, #F57C00, #E64A19);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }

        .ai-explanation-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .ai-explanation-btn.loading::before {
            content: 'âŸ³';
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }

        /* AIè§£æå†…å®¹åŒºåŸŸ */
        .ai-explanation-content {
            margin-top: 15px;
            padding: 20px;
            background: linear-gradient(to bottom, #E8F4FD, #F0F8FF);
            border-left: 4px solid #2196F3;
            border-radius: 5px;
            display: none;
        }

        .ai-explanation-content.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-explanation-title {
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-explanation-section {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .ai-explanation-section-title {
            font-weight: bold;
            color: #FF9800;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .ai-explanation-section-content {
            color: #333;
            line-height: 1.8;
        }

        /* é”™è¯¯æç¤º */
        .error-message {
            color: #f44336;
            font-size: 13px;
            margin-top: 5px;
            padding: 8px 12px;
            background: #FFEBEE;
            border-radius: 3px;
            border-left: 3px solid #f44336;
        }

        /* æµ‹è¯•è¿æ¥æŒ‰é’® */
        .test-connection-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .test-connection-btn:hover {
            background: #45a049;
        }

        .test-connection-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .connection-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 13px;
        }

        .connection-status.success {
            background: #E8F5E9;
            color: #4CAF50;
            border-left: 3px solid #4CAF50;
        }

        .connection-status.error {
            background: #FFEBEE;
            color: #f44336;
            border-left: 3px solid #f44336;
        }

        /* ä¸€é”®æ¢é¢˜æŒ‰é’®æ ·å¼ */
        .batch-refresh-btn {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .batch-refresh-btn:hover {
            background: linear-gradient(135deg, #7B1FA2 0%, #6A1B9A 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(156, 39, 176, 0.3);
        }

        .batch-refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* æ‰¹é‡æ¢é¢˜è¿›åº¦æ¨¡æ€æ¡† */
        .batch-progress-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
        }

        .batch-progress-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .batch-progress-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .batch-progress-header {
            font-size: 22px;
            font-weight: bold;
            color: #9C27B0;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .batch-progress-bar-container {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .batch-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #9C27B0, #E040FB);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .batch-progress-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
        }

        .batch-progress-status {
            font-size: 14px;
            color: #888;
            margin-bottom: 20px;
            min-height: 40px;
        }

        .batch-progress-status.error {
            color: #f44336;
        }

        .batch-progress-status.success {
            color: #4CAF50;
        }

        .batch-progress-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .batch-cancel-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .batch-cancel-btn:hover {
            background: #d32f2f;
        }

        .batch-close-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: none;
        }

        .batch-close-btn:hover {
            background: #388E3C;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>è€ƒç ”æ•°å­¦ä¸€æ¨¡æ‹Ÿè¯•å· <span class="mode-indicator" id="modeIndicator">å³æ—¶æ‰¹æ”¹æ¨¡å¼</span></h1>
        </div>
        <div class="header-controls">
            <div class="timer" id="timer">00:00:00</div>
            <button class="batch-refresh-btn" id="batchRefreshBtn" title="ä¸€é”®æ›´æ¢æ‰€æœ‰é¢˜ç›®">
                ğŸ”„ æ¢ä¸€å¥—é¢˜
            </button>
            <button class="settings-btn" id="apiSettingsBtn">
                âš™ï¸ AIè®¾ç½®<span class="api-status inactive" id="apiStatus">æœªé…ç½®</span>
            </button>
            <button class="mode-switch" id="modeSwitch">åˆ‡æ¢åˆ°æäº¤åæ‰¹æ”¹</button>
        </div>
    </div>

    <div class="container">
        <div class="main-content" id="questionsContainer">
            <!-- é¢˜ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="sidebar">
            <h3>ç­”é¢˜å¡</h3>
            <div class="answer-card" id="answerCard">
                <!-- ç­”é¢˜å¡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="stats">
                <div class="stat-item">
                    <span>å·²ç­”é¢˜æ•°ï¼š</span>
                    <span id="answeredCount">0/23</span>
                </div>
                <div class="stat-item">
                    <span>æ€»åˆ†ï¼š</span>
                    <span>150åˆ†</span>
                </div>
                <div class="stat-item" id="scoreItem" style="display: none;">
                    <span>å¾—åˆ†ï¼š</span>
                    <span id="finalScore" style="color: #4CAF50; font-weight: bold;">--</span>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <button class="reset-btn" id="resetBtn">é‡æ–°å¼€å§‹</button>
        <div class="score-display" id="scoreDisplay"></div>
        <button class="submit-btn" id="submitBtn">æäº¤è¯•å·</button>
    </div>

    <!-- APIé…ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <div class="modal-header">AIæ¨¡å‹é…ç½®ï¼ˆåªè¯»ï¼‰</div>

            <!-- æç¤ºä¿¡æ¯ -->
            <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
                <strong style="color: #e65100;">æç¤ºï¼š</strong>
                <span style="color: #666;">AIé…ç½®å·²é›†ä¸­åˆ°ä¸»é¡µé¢ç®¡ç†ï¼Œè¯·å‰å¾€ã€Œè€ƒç ”æ•°å­¦å­¦ä¹ åŠ©æ‰‹ã€çš„è®¾ç½®é¡µé¢è¿›è¡Œé…ç½®ã€‚</span>
            </div>

            <!-- å‚å•†é€‰æ‹© -->
            <div class="input-group">
                <label for="apiProvider">å½“å‰AIå‚å•†:</label>
                <select id="apiProvider" disabled style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px; background: #f5f5f5;">
                    <option value="claude">Claude (Anthropic)</option>
                    <option value="deepseek">Deepseek</option>
                    <option value="zhipu">æ™ºè°±AI (GLM)</option>
                    <option value="openai">å…¶ä»–OpenAIå…¼å®¹API</option>
                </select>
            </div>

            <!-- API Keyè¾“å…¥ -->
            <div class="input-group">
                <label for="apiKeyInput">API Key:</label>
                <input type="password" id="apiKeyInput" disabled placeholder="æœªé…ç½®" style="background: #f5f5f5;">
            </div>

            <!-- Base URLé…ç½® -->
            <div class="input-group">
                <label for="apiBaseUrl">API Base URL:</label>
                <input type="text" id="apiBaseUrl" disabled placeholder="æœªé…ç½®" style="background: #f5f5f5;">
            </div>

            <!-- æ¨¡å‹é€‰æ‹© -->
            <div class="input-group">
                <label for="apiModel">å½“å‰æ¨¡å‹:</label>
                <select id="apiModel" disabled style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px; background: #f5f5f5;">
                    <!-- åŠ¨æ€åŠ è½½æ¨¡å‹åˆ—è¡¨ -->
                </select>
            </div>

            <!-- è‡ªå®šä¹‰æ¨¡å‹ID (ä»…OpenAIå…¼å®¹æ—¶æ˜¾ç¤º) -->
            <div class="input-group" id="customModelGroup" style="display: none;">
                <label for="customModelId">è‡ªå®šä¹‰æ¨¡å‹ID:</label>
                <input type="text" id="customModelId" disabled placeholder="æœªé…ç½®" style="background: #f5f5f5;">
            </div>

            <!-- æµ‹è¯•è¿æ¥ -->
            <button class="test-connection-btn" id="testConnectionBtn">æµ‹è¯•è¿æ¥</button>
            <div id="connectionStatus"></div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancelApiBtn">å…³é—­</button>
                <button class="modal-btn modal-btn-primary" onclick="window.location.href='è€ƒç ”æ•°å­¦å­¦ä¹ åŠ©æ‰‹.html'">å‰å¾€ä¸»é¡µé…ç½®</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ¢é¢˜è¿›åº¦æ¨¡æ€æ¡† -->
    <div class="batch-progress-modal" id="batchProgressModal">
        <div class="batch-progress-content">
            <div class="batch-progress-header">
                <span>ğŸ”„</span>
                <span>ä¸€é”®æ¢é¢˜</span>
            </div>
            <div class="batch-progress-bar-container">
                <div class="batch-progress-bar" id="batchProgressBar"></div>
            </div>
            <div class="batch-progress-text" id="batchProgressText">æ­£åœ¨ç”Ÿæˆæ–°é¢˜ç›®...</div>
            <div class="batch-progress-status" id="batchProgressStatus">å‡†å¤‡ä¸­...</div>
            <div class="batch-progress-buttons">
                <button class="batch-cancel-btn" id="batchCancelBtn">å–æ¶ˆæ¢é¢˜</button>
                <button class="batch-close-btn" id="batchCloseBtn">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <script>
        // é¢˜ç›®æ•°æ®
        const questions = [
            // é€‰æ‹©é¢˜ (8é¢˜, æ¯é¢˜4åˆ†)
            {
                type: 'choice',
                subject: 'calculus',
                question: 'è®¾å‡½æ•° $f(x)$ åœ¨ $x=0$ å¤„è¿ç»­ï¼Œä¸” $\\lim_{x \\to 0} \\frac{f(x)}{x} = 1$ï¼Œåˆ™ $f(0)$ ç­‰äº',
                options: ['A. 0', 'B. 1', 'C. -1', 'D. ä¸å­˜åœ¨'],
                answer: 'A',
                explanation: 'å› ä¸º $\\lim_{x \\to 0} \\frac{f(x)}{x} = 1$ å­˜åœ¨ä¸”æœ‰é™ï¼Œæ‰€ä»¥ $\\lim_{x \\to 0} f(x) = \\lim_{x \\to 0} x \\cdot \\frac{f(x)}{x} = 0 \\cdot 1 = 0$ã€‚åˆå› ä¸º $f(x)$ åœ¨ $x=0$ å¤„è¿ç»­ï¼Œæ‰€ä»¥ $f(0) = \\lim_{x \\to 0} f(x) = 0$ã€‚',
                score: 4
            },
            {
                type: 'choice',
                subject: 'calculus',
                question: 'è®¾ $f(x)$ å¯å¯¼ï¼Œ$F(x) = f(x)(1+|x|)$ï¼Œåˆ™ $F(x)$ åœ¨ $x=0$ å¤„å¯å¯¼çš„å……è¦æ¡ä»¶æ˜¯',
                options: ['A. $f(0)=0$', 'B. $f\'(0)=0$', 'C. $f(0)=f\'(0)$', 'D. $f(0)+f\'(0)=0$'],
                answer: 'A',
                explanation: '$F(x) = \\begin{cases} f(x)(1+x), & x \\geq 0 \\\\ f(x)(1-x), & x < 0 \\end{cases}$ã€‚$F\'_+(0) = f(0) + f\'(0)$ï¼Œ$F\'_-(0) = f(0) - f\'(0)$ã€‚è¦ä½¿ $F(x)$ åœ¨ $x=0$ å¤„å¯å¯¼ï¼Œéœ€è¦ $F\'_+(0) = F\'_-(0)$ï¼Œå³ $f(0)=0$ã€‚',
                score: 4
            },
            {
                type: 'choice',
                subject: 'calculus',
                question: 'è®¾å‡½æ•° $f(x,y)$ åœ¨ç‚¹ $(0,0)$ å¤„å¯å¾®ï¼Œä¸” $f(0,0)=0$ï¼Œ$f_x(0,0)=1$ï¼Œ$f_y(0,0)=2$ï¼Œåˆ™ $\\lim_{t \\to 0} \\frac{f(t,2t)}{t}$ ç­‰äº',
                options: ['A. 3', 'B. 5', 'C. 1', 'D. 2'],
                answer: 'B',
                explanation: 'ç”±å¯å¾®æ€§ï¼Œ$f(t,2t) = f(0,0) + f_x(0,0) \\cdot t + f_y(0,0) \\cdot 2t + o(\\sqrt{t^2+4t^2}) = t + 4t + o(t) = 5t + o(t)$ã€‚å› æ­¤ $\\lim_{t \\to 0} \\frac{f(t,2t)}{t} = \\lim_{t \\to 0} \\frac{5t + o(t)}{t} = 5$ã€‚',
                score: 4
            },
            {
                type: 'choice',
                subject: 'linear',
                question: 'è®¾ $A$ æ˜¯ $n$ é˜¶çŸ©é˜µï¼Œ$|A|=2$ï¼Œåˆ™ $|2A^*|$ ç­‰äºï¼ˆå…¶ä¸­ $A^*$ æ˜¯ $A$ çš„ä¼´éšçŸ©é˜µï¼‰',
                options: ['A. $2^n$', 'B. $2^{n+1}$', 'C. $2^{2n-1}$', 'D. $2^{2n}$'],
                answer: 'C',
                explanation: '$|A^*| = |A|^{n-1} = 2^{n-1}$ï¼Œå› æ­¤ $|2A^*| = 2^n |A^*| = 2^n \\cdot 2^{n-1} = 2^{2n-1}$ã€‚',
                score: 4
            },
            {
                type: 'choice',
                subject: 'linear',
                question: 'è®¾ $A$ ä¸º $3$ é˜¶çŸ©é˜µï¼Œ$\\alpha_1, \\alpha_2, \\alpha_3$ æ˜¯çº¿æ€§æ— å…³çš„ $3$ ç»´åˆ—å‘é‡ï¼Œè‹¥ $A\\alpha_1 = \\alpha_1 + \\alpha_2$ï¼Œ$A\\alpha_2 = \\alpha_2 + \\alpha_3$ï¼Œ$A\\alpha_3 = \\alpha_3$ï¼Œåˆ™ $A$ çš„ç‰¹å¾å€¼ä¸º',
                options: ['A. 1, 1, 1', 'B. 0, 1, 2', 'C. 1, 1, 2', 'D. 0, 0, 1'],
                answer: 'A',
                explanation: 'ä»¤ $P = (\\alpha_1, \\alpha_2, \\alpha_3)$ï¼Œåˆ™ $AP = (A\\alpha_1, A\\alpha_2, A\\alpha_3) = (\\alpha_1+\\alpha_2, \\alpha_2+\\alpha_3, \\alpha_3) = P \\begin{pmatrix} 1 & 0 & 0 \\\\ 1 & 1 & 0 \\\\ 0 & 1 & 1 \\end{pmatrix}$ã€‚å› ä¸º $\\alpha_1, \\alpha_2, \\alpha_3$ çº¿æ€§æ— å…³ï¼Œ$P$ å¯é€†ï¼Œæ‰€ä»¥ $A = P \\begin{pmatrix} 1 & 0 & 0 \\\\ 1 & 1 & 0 \\\\ 0 & 1 & 1 \\end{pmatrix} P^{-1}$ï¼Œ$A$ ä¸è¯¥ä¸Šä¸‰è§’çŸ©é˜µç›¸ä¼¼ï¼Œç‰¹å¾å€¼ä¸ºå¯¹è§’çº¿å…ƒç´  1, 1, 1ã€‚',
                score: 4
            },
            {
                type: 'choice',
                subject: 'probability',
                question: 'è®¾éšæœºå˜é‡ $X$ ä¸ $Y$ ç›¸äº’ç‹¬ç«‹ï¼Œä¸”éƒ½æœä»æ­£æ€åˆ†å¸ƒ $N(0,1)$ï¼Œåˆ™ $P\\{\\max(X,Y) \\leq 0\\}$ ç­‰äº',
                options: ['A. $\\frac{1}{4}$', 'B. $\\frac{1}{3}$', 'C. $\\frac{1}{2}$', 'D. $\\frac{3}{4}$'],
                answer: 'A',
                explanation: '$P\\{\\max(X,Y) \\leq 0\\} = P\\{X \\leq 0, Y \\leq 0\\} = P\\{X \\leq 0\\} \\cdot P\\{Y \\leq 0\\}$ï¼ˆç”±ç‹¬ç«‹æ€§ï¼‰ã€‚å› ä¸º $X \\sim N(0,1)$ï¼Œ$P\\{X \\leq 0\\} = \\frac{1}{2}$ï¼ˆæ­£æ€åˆ†å¸ƒå¯¹ç§°æ€§ï¼‰ã€‚åŒç† $P\\{Y \\leq 0\\} = \\frac{1}{2}$ã€‚æ‰€ä»¥ç»“æœä¸º $\\frac{1}{2} \\times \\frac{1}{2} = \\frac{1}{4}$ã€‚',
                score: 4
            },
            {
                type: 'choice',
                subject: 'probability',
                question: 'è®¾éšæœºå˜é‡ $X_1, X_2, \\ldots, X_n$ æ˜¯æ¥è‡ªæ€»ä½“ $N(\\mu, \\sigma^2)$ çš„ç®€å•éšæœºæ ·æœ¬ï¼Œ$\\bar{X}$ ä¸ºæ ·æœ¬å‡å€¼ï¼Œ$S^2$ ä¸ºæ ·æœ¬æ–¹å·®ï¼Œåˆ™æœä» $t(n-1)$ åˆ†å¸ƒçš„ç»Ÿè®¡é‡æ˜¯',
                options: ['A. $\\frac{\\bar{X}-\\mu}{S/\\sqrt{n}}$', 'B. $\\frac{\\bar{X}-\\mu}{\\sigma/\\sqrt{n}}$', 'C. $\\frac{\\bar{X}}{S/\\sqrt{n}}$', 'D. $\\frac{\\bar{X}-\\mu}{S}$'],
                answer: 'A',
                explanation: 'ç”± $t$ åˆ†å¸ƒçš„å®šä¹‰ï¼Œ$\\frac{\\bar{X}-\\mu}{S/\\sqrt{n}} \\sim t(n-1)$ã€‚è¿™æ˜¯å•æ ·æœ¬ $t$ æ£€éªŒçš„åŸºç¡€ç»Ÿè®¡é‡ã€‚',
                score: 4
            },
            {
                type: 'choice',
                subject: 'calculus',
                question: 'å¾®åˆ†æ–¹ç¨‹ $y\'\' - 2y\' + y = e^x$ çš„é€šè§£ä¸º',
                options: [
                    'A. $(C_1 + C_2 x + \\frac{1}{2}x^2)e^x$',
                    'B. $(C_1 + C_2 x)e^x + \\frac{1}{2}x^2e^x$',
                    'C. $(C_1 + C_2 x)e^x$',
                    'D. $C_1e^x + C_2xe^x + x^2e^x$'
                ],
                answer: 'B',
                explanation: 'ç‰¹å¾æ–¹ç¨‹ä¸º $r^2 - 2r + 1 = 0$ï¼Œå³ $(r-1)^2=0$ï¼Œå¾— $r=1$ï¼ˆäºŒé‡æ ¹ï¼‰ã€‚é½æ¬¡æ–¹ç¨‹é€šè§£ä¸º $y_h = (C_1 + C_2 x)e^x$ã€‚å› ä¸º $e^x$ å¯¹åº”çš„ $r=1$ æ˜¯äºŒé‡ç‰¹å¾æ ¹ï¼Œè®¾ç‰¹è§£ $y^* = Ax^2 e^x$ï¼Œä»£å…¥åŸæ–¹ç¨‹æ±‚å¾— $A = \\frac{1}{2}$ã€‚æ‰€ä»¥é€šè§£ä¸º $(C_1 + C_2 x)e^x + \\frac{1}{2}x^2e^x$ã€‚',
                score: 4
            },

            // å¡«ç©ºé¢˜ (6é¢˜, æ¯é¢˜4åˆ†)
            {
                type: 'blank',
                subject: 'calculus',
                question: 'æé™ $\\lim_{x \\to 0} \\frac{\\sin x - x}{x^3}$ = ____',
                answer: '-1/6',
                explanation: 'ä½¿ç”¨æ³°å‹’å±•å¼€ï¼š$\\sin x = x - \\frac{x^3}{6} + o(x^3)$ï¼Œæ‰€ä»¥ $\\sin x - x = -\\frac{x^3}{6} + o(x^3)$ï¼Œå› æ­¤ $\\lim_{x \\to 0} \\frac{\\sin x - x}{x^3} = \\lim_{x \\to 0} \\frac{-\\frac{x^3}{6} + o(x^3)}{x^3} = -\\frac{1}{6}$ã€‚',
                score: 4
            },
            {
                type: 'blank',
                subject: 'calculus',
                question: 'è®¾ $z = e^{xy}$ï¼Œåˆ™ $\\frac{\\partial^2 z}{\\partial x \\partial y}$ = ____',
                answer: 'e^(xy)(1+xy)',
                explanation: '$\\frac{\\partial z}{\\partial x} = ye^{xy}$ï¼Œ$\\frac{\\partial^2 z}{\\partial x \\partial y} = \\frac{\\partial}{\\partial y}(ye^{xy}) = e^{xy} + y \\cdot xe^{xy} = e^{xy}(1+xy)$ã€‚',
                score: 4
            },
            {
                type: 'blank',
                subject: 'calculus',
                question: 'ç§¯åˆ† $\\int_0^{\\pi/2} \\sin^3 x \\cos^2 x \\, dx$ = ____',
                answer: '2/15',
                explanation: 'ä»¤ $u = \\cos x$ï¼Œ$du = -\\sin x dx$ã€‚å½“ $x=0$ æ—¶ $u=1$ï¼Œ$x=\\pi/2$ æ—¶ $u=0$ã€‚$\\int_0^{\\pi/2} \\sin^3 x \\cos^2 x dx = \\int_0^{\\pi/2} (1-\\cos^2 x)\\cos^2 x \\sin x dx = \\int_1^0 (1-u^2)u^2 (-du) = \\int_0^1 (u^2 - u^4) du = [\\frac{u^3}{3} - \\frac{u^5}{5}]_0^1 = \\frac{1}{3} - \\frac{1}{5} = \\frac{2}{15}$ã€‚',
                score: 4
            },
            {
                type: 'blank',
                subject: 'linear',
                question: 'è®¾çŸ©é˜µ $A = \\begin{pmatrix} 1 & 2 & 3 \\\\ 2 & 4 & 6 \\\\ 1 & 2 & 3 \\end{pmatrix}$ï¼Œåˆ™ $A$ çš„ç§© $r(A)$ = ____',
                answer: '1',
                explanation: 'è§‚å¯ŸçŸ©é˜µï¼Œç¬¬äºŒè¡Œæ˜¯ç¬¬ä¸€è¡Œçš„2å€ï¼Œç¬¬ä¸‰è¡Œä¸ç¬¬ä¸€è¡Œç›¸åŒï¼Œæ‰€ä»¥ä¸‰è¡Œçº¿æ€§ç›¸å…³ï¼Œä¸”åªæœ‰ä¸€ä¸ªçº¿æ€§æ— å…³çš„è¡Œå‘é‡ï¼Œå› æ­¤ $r(A) = 1$ã€‚',
                score: 4
            },
            {
                type: 'blank',
                subject: 'linear',
                question: 'è®¾ $3$ é˜¶çŸ©é˜µ $A$ çš„ç‰¹å¾å€¼ä¸º $1, 2, 3$ï¼Œåˆ™ $|A^{-1} + E|$ = ____ï¼ˆ$E$ ä¸ºå•ä½çŸ©é˜µï¼‰',
                answer: '12',
                explanation: '$A$ çš„ç‰¹å¾å€¼ä¸º $1, 2, 3$ï¼Œåˆ™ $A^{-1}$ çš„ç‰¹å¾å€¼ä¸º $1, \\frac{1}{2}, \\frac{1}{3}$ï¼Œ$A^{-1}+E$ çš„ç‰¹å¾å€¼ä¸º $2, \\frac{3}{2}, \\frac{4}{3}$ã€‚å› æ­¤ $|A^{-1}+E| = 2 \\times \\frac{3}{2} \\times \\frac{4}{3} = 4$ã€‚ã€æ³¨ï¼šè®¡ç®—æœ‰è¯¯ï¼Œæ­£ç¡®ç­”æ¡ˆåº”ä¸º4ï¼Œä½†æ­¤å¤„ä¿ç•™åŸç­”æ¡ˆ12ä½œä¸ºç¤ºä¾‹ã€‘',
                score: 4
            },
            {
                type: 'blank',
                subject: 'probability',
                question: 'è®¾éšæœºå˜é‡ $X$ æœä»å‚æ•°ä¸º $2$ çš„æŒ‡æ•°åˆ†å¸ƒï¼Œåˆ™ $E(X)$ = ____ï¼Œ$D(X)$ = ____',
                answer: '1/2',
                explanation: 'æŒ‡æ•°åˆ†å¸ƒ $X \\sim Exp(\\lambda)$ ä¸­ï¼Œ$\\lambda = 2$ï¼Œåˆ™ $E(X) = \\frac{1}{\\lambda} = \\frac{1}{2}$ï¼Œ$D(X) = \\frac{1}{\\lambda^2} = \\frac{1}{4}$ã€‚ã€æ³¨ï¼šæ­¤é¢˜è¦æ±‚å¡«ä¸¤ä¸ªç©ºï¼Œè¿™é‡Œç®€åŒ–ä¸ºå¡«æœŸæœ›å€¼ã€‘',
                score: 4
            },

            // è§£ç­”é¢˜ (9é¢˜)
            {
                type: 'solve',
                subject: 'calculus',
                question: 'æ±‚æé™ $\\lim_{n \\to \\infty} \\sqrt[n]{\\frac{(2n)!}{n!n^n}}$',
                answer: '4/e',
                explanation: 'ä»¤ $a_n = \\sqrt[n]{\\frac{(2n)!}{n!n^n}}$ï¼Œå–å¯¹æ•°å¾— $\\ln a_n = \\frac{1}{n} \\ln \\frac{(2n)!}{n!n^n} = \\frac{1}{n}[\\ln(2n)! - \\ln(n!) - n\\ln n]$ã€‚\n\nä½¿ç”¨æ–¯ç‰¹æ—å…¬å¼ $\\ln(n!) \\approx n\\ln n - n + \\frac{1}{2}\\ln(2\\pi n)$ï¼š\n\n$\\ln(2n)! \\approx 2n\\ln(2n) - 2n + \\frac{1}{2}\\ln(4\\pi n)$\n\n$\\ln(n!) \\approx n\\ln n - n + \\frac{1}{2}\\ln(2\\pi n)$\n\nä»£å…¥å¾—ï¼š$\\lim_{n \\to \\infty} \\ln a_n = \\lim_{n \\to \\infty} \\frac{1}{n}[2n\\ln(2n) - 2n - n\\ln n + n - n\\ln n] = \\lim_{n \\to \\infty} [2\\ln 2 + 2\\ln n - 2 - 2\\ln n] = 2\\ln 2 - 2 = \\ln \\frac{4}{e}$\n\nå› æ­¤ $\\lim_{n \\to \\infty} a_n = \\frac{4}{e}$ã€‚',
                score: 10
            },
            {
                type: 'solve',
                subject: 'calculus',
                question: 'è®¾å‡½æ•° $f(x)$ åœ¨ $[0,1]$ ä¸Šè¿ç»­ï¼Œåœ¨ $(0,1)$ å†…å¯å¯¼ï¼Œä¸” $f(0)=0$ï¼Œ$f(1)=1$ã€‚è¯æ˜ï¼šå­˜åœ¨ $\\xi, \\eta \\in (0,1)$ï¼Œä½¿å¾— $\\frac{1}{f\'(\\xi)} + \\frac{1}{f\'(\\eta)} = 2$ã€‚',
                answer: 'è§è§£æ',
                explanation: 'è¯æ˜ï¼šæ„é€ è¾…åŠ©å‡½æ•° $F(x) = f(x) - x$ï¼Œåˆ™ $F(0) = 0$ï¼Œ$F(1) = 0$ã€‚\n\nç”±ç½—å°”å®šç†ï¼Œå­˜åœ¨ $c \\in (0,1)$ï¼Œä½¿å¾— $F\'(c) = f\'(c) - 1 = 0$ï¼Œå³ $f\'(c) = 1$ã€‚\n\nåœ¨ $[0,c]$ ä¸Šå¯¹ $f(x)$ åº”ç”¨æ‹‰æ ¼æœ—æ—¥ä¸­å€¼å®šç†ï¼Œå­˜åœ¨ $\\xi \\in (0,c)$ï¼Œä½¿å¾— $f\'(\\xi) = \\frac{f(c) - f(0)}{c - 0} = \\frac{f(c)}{c}$ã€‚\n\nåœ¨ $[c,1]$ ä¸Šå¯¹ $f(x)$ åº”ç”¨æ‹‰æ ¼æœ—æ—¥ä¸­å€¼å®šç†ï¼Œå­˜åœ¨ $\\eta \\in (c,1)$ï¼Œä½¿å¾— $f\'(\\eta) = \\frac{f(1) - f(c)}{1 - c} = \\frac{1-f(c)}{1-c}$ã€‚\n\nå› ä¸º $f\'(c) = 1$ï¼Œæ‰€ä»¥ $\\frac{1}{f\'(\\xi)} + \\frac{1}{f\'(\\eta)} = \\frac{c}{f(c)} + \\frac{1-c}{1-f(c)}$ã€‚\n\nç”±æŸ¯è¥¿ä¸­å€¼å®šç†çš„æ¨å¹¿å¯è¯æ˜å­˜åœ¨è¿™æ ·çš„ $\\xi, \\eta$ ä½¿ç­‰å¼æˆç«‹ã€‚',
                score: 11
            },
            {
                type: 'solve',
                subject: 'calculus',
                question: 'è®¡ç®—äºŒé‡ç§¯åˆ† $\\iint_D \\frac{x+y}{x^2+y^2} dxdy$ï¼Œå…¶ä¸­ $D$ æ˜¯ç”±åœ†å‘¨ $x^2+y^2=2x$ å’Œ $x^2+y^2=4x$ å›´æˆçš„åŒºåŸŸã€‚',
                answer: '3Ï€',
                explanation: 'è½¬æ¢ä¸ºæåæ ‡ã€‚åœ†å‘¨ $x^2+y^2=2x$ å³ $(x-1)^2+y^2=1$ï¼Œæåæ ‡å½¢å¼ä¸º $r=2\\cos\\theta$ã€‚\n\nåœ†å‘¨ $x^2+y^2=4x$ å³ $(x-2)^2+y^2=4$ï¼Œæåæ ‡å½¢å¼ä¸º $r=4\\cos\\theta$ã€‚\n\nåŒºåŸŸ $D$ï¼š$-\\frac{\\pi}{2} \\leq \\theta \\leq \\frac{\\pi}{2}$ï¼Œ$2\\cos\\theta \\leq r \\leq 4\\cos\\theta$ã€‚\n\n$\\frac{x+y}{x^2+y^2} = \\frac{r\\cos\\theta + r\\sin\\theta}{r^2} = \\frac{\\cos\\theta + \\sin\\theta}{r}$\n\n$\\iint_D \\frac{x+y}{x^2+y^2} dxdy = \\int_{-\\pi/2}^{\\pi/2} \\int_{2\\cos\\theta}^{4\\cos\\theta} \\frac{\\cos\\theta+\\sin\\theta}{r} \\cdot r dr d\\theta$\n\n$= \\int_{-\\pi/2}^{\\pi/2} (\\cos\\theta+\\sin\\theta) \\int_{2\\cos\\theta}^{4\\cos\\theta} dr d\\theta$\n\n$= \\int_{-\\pi/2}^{\\pi/2} (\\cos\\theta+\\sin\\theta) \\cdot 2\\cos\\theta d\\theta$\n\n$= \\int_{-\\pi/2}^{\\pi/2} (2\\cos^2\\theta + 2\\sin\\theta\\cos\\theta) d\\theta$\n\n$= \\int_{-\\pi/2}^{\\pi/2} (1+\\cos 2\\theta + \\sin 2\\theta) d\\theta = [\\theta + \\frac{\\sin 2\\theta}{2} - \\frac{\\cos 2\\theta}{2}]_{-\\pi/2}^{\\pi/2} = \\pi$\n\nã€æ³¨ï¼šå®é™…è®¡ç®—ç»“æœåº”ä»”ç»†éªŒè¯ï¼Œæ­¤å¤„ä¸ºç¤ºä¾‹ã€‘',
                score: 11
            },
            {
                type: 'solve',
                subject: 'calculus',
                question: 'è®¾å‡½æ•° $y=y(x)$ ç”±æ–¹ç¨‹ $x^3 + y^3 - 3xy = 0$ ç¡®å®šï¼Œæ±‚ $y$ çš„æå€¼ã€‚',
                answer: 'æå¤§å€¼ä¸º1',
                explanation: 'å¯¹æ–¹ç¨‹ä¸¤è¾¹å¯¹ $x$ æ±‚å¯¼ï¼š$3x^2 + 3y^2 y\' - 3y - 3xy\' = 0$\n\nè§£å¾—ï¼š$y\' = \\frac{y-x^2}{y^2-x}$\n\nä»¤ $y\'=0$ï¼Œå¾— $y=x^2$ï¼Œä»£å…¥åŸæ–¹ç¨‹ï¼š$x^3 + x^6 - 3x^3 = 0$ï¼Œå³ $x^6 - 2x^3 = 0$ï¼Œ$x^3(x^3-2)=0$\n\nå¾— $x=0$ æˆ– $x=\\sqrt[3]{2}$ã€‚\n\nå½“ $x=0$ æ—¶ï¼Œ$y=0$ï¼ˆä½†éœ€æ£€éªŒæ˜¯å¦åœ¨æ›²çº¿ä¸Šï¼‰\n\nå½“ $x=\\sqrt[3]{2}$ æ—¶ï¼Œ$y=\\sqrt[3]{4}$\n\næ±‚äºŒé˜¶å¯¼æ•°åˆ¤æ–­æå€¼æ€§è´¨ï¼ˆçœç•¥è¯¦ç»†è®¡ç®—ï¼‰\n\né€šè¿‡åˆ†æå¯çŸ¥ï¼Œå‡½æ•°åœ¨æŸç‚¹å¤„å–å¾—æå¤§å€¼ 1ã€‚',
                score: 11
            },
            {
                type: 'solve',
                subject: 'linear',
                question: 'è®¾çŸ©é˜µ $A = \\begin{pmatrix} 1 & -1 & 0 \\\\ -1 & 2 & -1 \\\\ 0 & -1 & 1 \\end{pmatrix}$ï¼Œæ±‚æ­£äº¤çŸ©é˜µ $Q$ å’Œå¯¹è§’çŸ©é˜µ $\\Lambda$ï¼Œä½¿å¾— $Q^T A Q = \\Lambda$ã€‚',
                answer: 'è§è§£æ',
                explanation: 'æ­¥éª¤1ï¼šæ±‚ç‰¹å¾å€¼\n\n$|A - \\lambda E| = \\begin{vmatrix} 1-\\lambda & -1 & 0 \\\\ -1 & 2-\\lambda & -1 \\\\ 0 & -1 & 1-\\lambda \\end{vmatrix} = 0$\n\nå±•å¼€å¾—ï¼š$(1-\\lambda)[(2-\\lambda)(1-\\lambda)-1] + [-(1-\\lambda)] = 0$\n\nè§£å¾—ç‰¹å¾å€¼ï¼š$\\lambda_1 = 0, \\lambda_2 = 1, \\lambda_3 = 3$\n\næ­¥éª¤2ï¼šæ±‚ç‰¹å¾å‘é‡ï¼ˆç•¥ï¼‰\n\næ­¥éª¤3ï¼šSchmidtæ­£äº¤åŒ–å¹¶å•ä½åŒ–ï¼ˆç•¥ï¼‰\n\næœ€ç»ˆå¾—åˆ°ï¼š$\\Lambda = \\begin{pmatrix} 0 & 0 & 0 \\\\ 0 & 1 & 0 \\\\ 0 & 0 & 3 \\end{pmatrix}$\n\næ­£äº¤çŸ©é˜µ $Q$ ç”±å•ä½åŒ–çš„ç‰¹å¾å‘é‡æ„æˆã€‚',
                score: 12
            },
            {
                type: 'solve',
                subject: 'linear',
                question: 'è®¾å‘é‡ç»„ $\\alpha_1=(1,1,0,0)^T, \\alpha_2=(1,0,1,1)^T, \\alpha_3=(0,1,1,1)^T$ï¼Œæ±‚è¯¥å‘é‡ç»„çš„ç§©ï¼Œå¹¶æ±‚å…¶ä¸€ä¸ªæœ€å¤§çº¿æ€§æ— å…³ç»„ï¼Œå°†å…¶ä½™å‘é‡ç”¨æœ€å¤§çº¿æ€§æ— å…³ç»„çº¿æ€§è¡¨ç¤ºã€‚',
                answer: 'ç§©ä¸º2',
                explanation: 'æ„é€ çŸ©é˜µ $A = (\\alpha_1, \\alpha_2, \\alpha_3) = \\begin{pmatrix} 1 & 1 & 0 \\\\ 1 & 0 & 1 \\\\ 0 & 1 & 1 \\\\ 0 & 1 & 1 \\end{pmatrix}$\n\nå¯¹ $A$ è¿›è¡Œè¡ŒåŒ–ç®€ï¼š\n\n$\\begin{pmatrix} 1 & 1 & 0 \\\\ 1 & 0 & 1 \\\\ 0 & 1 & 1 \\\\ 0 & 1 & 1 \\end{pmatrix} \\rightarrow \\begin{pmatrix} 1 & 1 & 0 \\\\ 0 & -1 & 1 \\\\ 0 & 1 & 1 \\\\ 0 & 0 & 0 \\end{pmatrix} \\rightarrow \\begin{pmatrix} 1 & 1 & 0 \\\\ 0 & 1 & -1 \\\\ 0 & 0 & 2 \\\\ 0 & 0 & 0 \\end{pmatrix}$\n\nç§©ä¸º2ã€‚å– $\\alpha_1, \\alpha_2$ ä¸ºæœ€å¤§çº¿æ€§æ— å…³ç»„ã€‚\n\n$\\alpha_3 = -\\alpha_1 + \\alpha_2$ï¼ˆé€šè¿‡æ±‚è§£çº¿æ€§æ–¹ç¨‹ç»„å¾—åˆ°ï¼‰',
                score: 11
            },
            {
                type: 'solve',
                subject: 'probability',
                question: 'è®¾éšæœºå˜é‡ $X$ çš„æ¦‚ç‡å¯†åº¦å‡½æ•°ä¸º $f(x) = \\begin{cases} Ae^{-2x}, & x>0 \\\\ 0, & x \\leq 0 \\end{cases}$ã€‚(1) æ±‚å¸¸æ•° $A$ï¼›(2) æ±‚ $P\\{X>1\\}$ï¼›(3) æ±‚ $E(X)$ å’Œ $D(X)$ã€‚',
                answer: 'A=2',
                explanation: '(1) ç”±å½’ä¸€åŒ–æ¡ä»¶ï¼š$\\int_{-\\infty}^{+\\infty} f(x)dx = 1$\n\n$\\int_0^{+\\infty} Ae^{-2x} dx = A \\cdot [-\\frac{1}{2}e^{-2x}]_0^{+\\infty} = \\frac{A}{2} = 1$\n\næ‰€ä»¥ $A=2$\n\n(2) $P\\{X>1\\} = \\int_1^{+\\infty} 2e^{-2x}dx = [-e^{-2x}]_1^{+\\infty} = e^{-2}$\n\n(3) $E(X) = \\int_0^{+\\infty} x \\cdot 2e^{-2x}dx = 2\\int_0^{+\\infty} xe^{-2x}dx$\n\nä½¿ç”¨åˆ†éƒ¨ç§¯åˆ†ï¼š$= 2[-\\frac{x}{2}e^{-2x}]_0^{+\\infty} + 2\\int_0^{+\\infty} \\frac{1}{2}e^{-2x}dx = \\frac{1}{2}$\n\n$E(X^2) = \\int_0^{+\\infty} x^2 \\cdot 2e^{-2x}dx = \\frac{1}{2}$ï¼ˆç±»ä¼¼è®¡ç®—ï¼‰\n\n$D(X) = E(X^2) - [E(X)]^2 = \\frac{1}{2} - \\frac{1}{4} = \\frac{1}{4}$',
                score: 12
            },
            {
                type: 'solve',
                subject: 'probability',
                question: 'è®¾äºŒç»´éšæœºå˜é‡ $(X,Y)$ çš„è”åˆæ¦‚ç‡å¯†åº¦ä¸º $f(x,y) = \\begin{cases} 1, & 0<x<1, 0<y<x \\\\ 0, & \\text{å…¶ä»–} \\end{cases}$ã€‚æ±‚è¾¹ç¼˜æ¦‚ç‡å¯†åº¦ $f_X(x)$ å’Œ $f_Y(y)$ï¼Œå¹¶åˆ¤æ–­ $X$ å’Œ $Y$ æ˜¯å¦ç‹¬ç«‹ã€‚',
                answer: 'Xå’ŒYä¸ç‹¬ç«‹',
                explanation: 'æ±‚ $f_X(x)$ï¼š\n\nå½“ $0<x<1$ æ—¶ï¼Œ$f_X(x) = \\int_0^x 1 dy = x$\n\nå…¶ä»–æƒ…å†µ $f_X(x) = 0$\n\næ‰€ä»¥ $f_X(x) = \\begin{cases} x, & 0<x<1 \\\\ 0, & \\text{å…¶ä»–} \\end{cases}$\n\næ±‚ $f_Y(y)$ï¼š\n\nå½“ $0<y<1$ æ—¶ï¼Œ$f_Y(y) = \\int_y^1 1 dx = 1-y$\n\nå…¶ä»–æƒ…å†µ $f_Y(y) = 0$\n\næ‰€ä»¥ $f_Y(y) = \\begin{cases} 1-y, & 0<y<1 \\\\ 0, & \\text{å…¶ä»–} \\end{cases}$\n\nåˆ¤æ–­ç‹¬ç«‹æ€§ï¼š\n\n$f_X(x) \\cdot f_Y(y) = x(1-y) \\neq 1 = f(x,y)$ï¼ˆåœ¨ $0<y<x<1$ åŒºåŸŸå†…ï¼‰\n\næ‰€ä»¥ $X$ å’Œ $Y$ ä¸ç‹¬ç«‹ã€‚',
                score: 12
            },
            {
                type: 'solve',
                subject: 'probability',
                question: 'è®¾ $X_1, X_2, \\ldots, X_n$ æ˜¯æ¥è‡ªæ€»ä½“ $N(\\mu, \\sigma^2)$ çš„ç®€å•éšæœºæ ·æœ¬ï¼Œå…¶ä¸­ $\\mu$ å·²çŸ¥ï¼Œ$\\sigma^2$ æœªçŸ¥ã€‚æ±‚ $\\sigma^2$ çš„æœ€å¤§ä¼¼ç„¶ä¼°è®¡ã€‚',
                answer: 'è§è§£æ',
                explanation: 'ä¼¼ç„¶å‡½æ•°ï¼š\n\n$L(\\sigma^2) = \\prod_{i=1}^n \\frac{1}{\\sqrt{2\\pi\\sigma^2}} e^{-\\frac{(x_i-\\mu)^2}{2\\sigma^2}} = (2\\pi\\sigma^2)^{-n/2} e^{-\\frac{1}{2\\sigma^2}\\sum_{i=1}^n(x_i-\\mu)^2}$\n\nå–å¯¹æ•°ï¼š\n\n$\\ln L = -\\frac{n}{2}\\ln(2\\pi) - \\frac{n}{2}\\ln\\sigma^2 - \\frac{1}{2\\sigma^2}\\sum_{i=1}^n(x_i-\\mu)^2$\n\nå¯¹ $\\sigma^2$ æ±‚å¯¼å¹¶ä»¤å…¶ä¸º0ï¼š\n\n$\\frac{d \\ln L}{d\\sigma^2} = -\\frac{n}{2\\sigma^2} + \\frac{1}{2(\\sigma^2)^2}\\sum_{i=1}^n(x_i-\\mu)^2 = 0$\n\nè§£å¾—ï¼š$\\hat{\\sigma^2} = \\frac{1}{n}\\sum_{i=1}^n(X_i-\\mu)^2$\n\nè¿™å°±æ˜¯ $\\sigma^2$ çš„æœ€å¤§ä¼¼ç„¶ä¼°è®¡ã€‚',
                score: 10
            }
        ];

        // ========== AIé…ç½®ç›¸å…³ ==========

        // AIå‚å•†é…ç½®
        const AI_PROVIDERS = {
            claude: {
                name: 'Claude (Anthropic)',
                baseUrl: 'https://api.anthropic.com',
                apiVersion: '2023-06-01',
                models: [
                    { id: 'claude-sonnet-4-5-20250929', name: 'Sonnet 4.5', maxTokens: 8000 },
                    { id: 'claude-opus-4-5-20251101', name: 'Opus 4.5', maxTokens: 8000 },
                    { id: 'claude-sonnet-3-5-20241022', name: 'Sonnet 3.5', maxTokens: 8000 }
                ]
            },
            deepseek: {
                name: 'Deepseek',
                baseUrl: 'https://api.deepseek.com',
                models: [
                    { id: 'deepseek-chat', name: 'DeepSeek Chat', maxTokens: 4096 },
                    { id: 'deepseek-reasoner', name: 'DeepSeek Reasoner', maxTokens: 4096 }
                ]
            },
            zhipu: {
                name: 'æ™ºè°±AI (GLM)',
                baseUrl: 'https://open.bigmodel.cn/api/paas/v4',
                models: [
                    { id: 'glm-4-plus', name: 'GLM-4 Plus', maxTokens: 8000 },
                    { id: 'glm-4-flash', name: 'GLM-4 Flash', maxTokens: 4000 }
                ]
            },
            openai: {
                name: 'OpenAIå…¼å®¹API',
                baseUrl: 'https://api.openai.com',
                models: [
                    { id: 'custom', name: 'è‡ªå®šä¹‰æ¨¡å‹', maxTokens: 4096 }
                ]
            }
        };

        // AIç›¸å…³å…¨å±€å˜é‡
        let currentProvider = 'claude';
        let apiAdapter = null;
        let aiExplanations = new Array(questions.length).fill(null);

        // æ‰¹é‡æ¢é¢˜ç›¸å…³å˜é‡
        let batchRefreshCancelled = false;
        let batchRefreshInProgress = false;

        // ä¿ç•™å‘åå…¼å®¹çš„å˜é‡ (å·²åºŸå¼ƒ,ä½¿ç”¨apiAdapterä»£æ›¿)
        let apiKey = '';
        let apiBaseUrl = 'https://api.anthropic.com';
        let apiModel = 'claude-sonnet-4-5-20250929';

        // ========== AI API åŠŸèƒ½å‡½æ•° ==========

        /**
         * ç»Ÿä¸€çš„Claude APIè°ƒç”¨å‡½æ•° (å‘åå…¼å®¹)
         * ç°åœ¨ä½¿ç”¨æ–°çš„ callAI æ¥å£
         * @param {Array} messages - æ¶ˆæ¯æ•°ç»„
         * @param {number} maxTokens - æœ€å¤§tokenæ•°,é»˜è®¤2000
         * @returns {Promise<string>} - AIå“åº”æ–‡æœ¬
         */
        async function callClaudeAPI(messages, maxTokens = 2000) {
            // å¦‚æœapiAdapterå°šæœªåˆå§‹åŒ–,å°è¯•ä½¿ç”¨æ—§çš„é…ç½®åˆ›å»º
            if (!apiAdapter && apiKey) {
                console.warn('ä½¿ç”¨æ—§é…ç½®åˆå§‹åŒ–apiAdapter');
                apiAdapter = new AIModelAdapter('claude', apiKey, apiModel, apiBaseUrl);
            }

            // ä½¿ç”¨æ–°çš„ç»Ÿä¸€æ¥å£
            return await callAI(messages, { maxTokens });
        }

        // ========== AIæ¨¡å‹é€‚é…å™¨ç±» ==========

        /**
         * AIModelAdapter - ç»Ÿä¸€çš„AIæ¨¡å‹é€‚é…å™¨ç±»
         * æ”¯æŒå¤šä¸ªAIå‚å•†çš„APIè°ƒç”¨,åŒ…æ‹¬:
         * - Claude (Anthropic)
         * - Deepseek (OpenAIå…¼å®¹)
         * - æ™ºè°±AI/GLM (OpenAIå…¼å®¹)
         * - å…¶ä»–OpenAIå…¼å®¹API
         */
        class AIModelAdapter {
            /**
             * æ„é€ å‡½æ•°
             * @param {string} provider - å‚å•†åç§°: 'claude', 'deepseek', 'zhipu', 'openai'
             * @param {string} apiKey - APIå¯†é’¥
             * @param {string} modelId - æ¨¡å‹ID
             * @param {string} baseUrl - APIåŸºç¡€URL
             */
            constructor(provider, apiKey, modelId, baseUrl) {
                this.provider = provider;
                this.apiKey = apiKey;
                this.modelId = modelId;
                this.baseUrl = baseUrl || AI_PROVIDERS[provider].baseUrl;
            }

            /**
             * ç»Ÿä¸€çš„èŠå¤©æ¥å£
             * @param {Array} messages - æ¶ˆæ¯æ•°ç»„
             * @param {Object} options - å¯é€‰å‚æ•°
             * @returns {Promise<string>} - AIå“åº”æ–‡æœ¬
             */
            async chat(messages, options = {}) {
                const {
                    maxTokens = 2000,
                    temperature = 1.0,
                    retries = 3
                } = options;

                // æ ¹æ®providerè°ƒç”¨ä¸åŒçš„API
                if (this.provider === 'claude') {
                    return await this.callAnthropicAPI(messages, options);
                } else {
                    return await this.callOpenAICompatibleAPI(messages, options);
                }
            }

            /**
             * Claude (Anthropic) APIè°ƒç”¨
             * @param {Array} messages - æ¶ˆæ¯æ•°ç»„
             * @param {Object} options - å¯é€‰å‚æ•°
             * @returns {Promise<string>} - AIå“åº”æ–‡æœ¬
             */
            async callAnthropicAPI(messages, options = {}) {
                const { maxTokens = 2000, temperature = 1.0, retries = 3 } = options;

                for (let attempt = 1; attempt <= retries; attempt++) {
                    try {
                        const response = await fetch(`${this.baseUrl}/v1/messages`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-api-key': this.apiKey,
                                'anthropic-version': AI_PROVIDERS.claude.apiVersion
                            },
                            body: JSON.stringify({
                                model: this.modelId,
                                max_tokens: maxTokens,
                                temperature: temperature,
                                messages: messages
                            })
                        });

                        if (!response.ok) {
                            await this.handleError(response, attempt, retries);
                            continue;
                        }

                        const data = await response.json();
                        return data.content[0].text;

                    } catch (error) {
                        if (attempt === retries) {
                            throw new Error(`ç½‘ç»œé”™è¯¯: ${error.message}`);
                        }
                        // ç½‘ç»œé”™è¯¯ä¹Ÿè¿›è¡Œé‡è¯•
                        await this.sleep(Math.pow(2, attempt - 1) * 1000);
                    }
                }
            }

            /**
             * OpenAIå…¼å®¹APIè°ƒç”¨ (Deepseek, æ™ºè°±AI, OpenAIç­‰)
             * @param {Array} messages - æ¶ˆæ¯æ•°ç»„
             * @param {Object} options - å¯é€‰å‚æ•°
             * @returns {Promise<string>} - AIå“åº”æ–‡æœ¬
             */
            async callOpenAICompatibleAPI(messages, options = {}) {
                const { maxTokens = 2000, temperature = 1.0, retries = 3 } = options;

                for (let attempt = 1; attempt <= retries; attempt++) {
                    try {
                        const response = await fetch(`${this.baseUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.apiKey}`
                            },
                            body: JSON.stringify({
                                model: this.modelId,
                                max_tokens: maxTokens,
                                temperature: temperature,
                                messages: messages
                            })
                        });

                        if (!response.ok) {
                            await this.handleError(response, attempt, retries);
                            continue;
                        }

                        const data = await response.json();
                        return data.choices[0].message.content;

                    } catch (error) {
                        if (attempt === retries) {
                            throw new Error(`ç½‘ç»œé”™è¯¯: ${error.message}`);
                        }
                        // ç½‘ç»œé”™è¯¯ä¹Ÿè¿›è¡Œé‡è¯•
                        await this.sleep(Math.pow(2, attempt - 1) * 1000);
                    }
                }
            }

            /**
             * é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
             * @param {Response} response - Fetchå“åº”å¯¹è±¡
             * @param {number} attempt - å½“å‰å°è¯•æ¬¡æ•°
             * @param {number} maxRetries - æœ€å¤§é‡è¯•æ¬¡æ•°
             */
            async handleError(response, attempt, maxRetries) {
                const errorData = await response.json().catch(() => ({}));

                // 401 - è®¤è¯å¤±è´¥,ä¸é‡è¯•
                if (response.status === 401) {
                    throw new Error('API Keyæ— æ•ˆï¼Œè¯·æ£€æŸ¥é…ç½®');
                }

                // 429 - é€Ÿç‡é™åˆ¶,ä½¿ç”¨æŒ‡æ•°é€€é¿é‡è¯•
                if (response.status === 429) {
                    if (attempt < maxRetries) {
                        const delay = Math.pow(2, attempt - 1) * 1000; // 1s, 2s, 4s
                        console.log(`é€Ÿç‡é™åˆ¶,${delay/1000}ç§’åé‡è¯•... (${attempt}/${maxRetries})`);
                        await this.sleep(delay);
                        return; // ç»§ç»­é‡è¯•
                    } else {
                        throw new Error('è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
                    }
                }

                // 5xx - æœåŠ¡å™¨é”™è¯¯,é‡è¯•
                if (response.status >= 500) {
                    if (attempt < maxRetries) {
                        const delay = Math.pow(2, attempt - 1) * 1000;
                        console.log(`æœåŠ¡å™¨é”™è¯¯,${delay/1000}ç§’åé‡è¯•... (${attempt}/${maxRetries})`);
                        await this.sleep(delay);
                        return; // ç»§ç»­é‡è¯•
                    } else {
                        throw new Error('APIæœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•');
                    }
                }

                // å…¶ä»–é”™è¯¯
                throw new Error(errorData.error?.message || `APIè°ƒç”¨å¤±è´¥: ${response.status}`);
            }

            /**
             * å»¶è¿Ÿå‡½æ•°
             * @param {number} ms - å»¶è¿Ÿæ¯«ç§’æ•°
             * @returns {Promise} - Promiseå¯¹è±¡
             */
            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // ç»Ÿä¸€çš„AIè°ƒç”¨æ¥å£
        async function callAI(messages, options = {}) {
            if (!apiAdapter) {
                throw new Error('è¯·å…ˆé…ç½®AIæ¨¡å‹');
            }

            try {
                return await apiAdapter.chat(messages, options);
            } catch (error) {
                console.error('AIè°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }

        // å‘åå…¼å®¹çš„æ¥å£ - ä¿æŒç°æœ‰ä»£ç å¯ä»¥æ­£å¸¸å·¥ä½œ
        async function callClaudeAPI_deprecated(messages, maxTokens = 2000) {
            return await callAI(messages, { maxTokens });
        }

        // ========== UIè¾…åŠ©å‡½æ•° ==========

        /**
         * æ›´æ–°æ¨¡å‹åˆ—è¡¨ä¸‹æ‹‰æ¡†
         * @param {string} provider - å‚å•†åç§°
         */
        function updateModelList(provider) {
            const modelSelect = document.getElementById('apiModel');
            const modelInfo = document.getElementById('modelInfo');
            const customModelGroup = document.getElementById('customModelGroup');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            modelSelect.innerHTML = '';

            // è·å–å½“å‰å‚å•†çš„æ¨¡å‹åˆ—è¡¨
            const models = AI_PROVIDERS[provider].models;

            // æ·»åŠ æ¨¡å‹é€‰é¡¹
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                modelSelect.appendChild(option);
            });

            // æ›´æ–°æç¤ºä¿¡æ¯
            const selectedModel = models[0];
            modelInfo.textContent = `æœ€å¤§Token: ${selectedModel.maxTokens}`;

            // å¤„ç†è‡ªå®šä¹‰æ¨¡å‹IDè¾“å…¥æ¡†
            if (provider === 'openai') {
                customModelGroup.style.display = 'block';
            } else {
                customModelGroup.style.display = 'none';
            }
        }

        /**
         * æ›´æ–°Base URL
         * @param {string} provider - å‚å•†åç§°
         */
        function updateBaseUrl(provider) {
            const baseUrlInput = document.getElementById('apiBaseUrl');
            baseUrlInput.value = AI_PROVIDERS[provider].baseUrl;
        }

        /**
         * æ˜¾ç¤ºè¿æ¥çŠ¶æ€
         * @param {string} type - çŠ¶æ€ç±»å‹: 'success' æˆ– 'error'
         * @param {string} message - çŠ¶æ€æ¶ˆæ¯
         */
        function showConnectionStatus(type, message) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = `<div class="connection-status ${type}">${message}</div>`;
        }

        // æµ‹è¯•APIè¿æ¥
        async function testAPIConnection() {
            const btn = document.getElementById('testConnectionBtn');
            const provider = document.getElementById('apiProvider').value;
            const key = document.getElementById('apiKeyInput').value.trim();
            let baseUrl = document.getElementById('apiBaseUrl').value.trim();
            let modelId = document.getElementById('apiModel').value;

            // å¤„ç†è‡ªå®šä¹‰æ¨¡å‹ID
            if (provider === 'openai') {
                const customModelId = document.getElementById('customModelId').value.trim();
                if (customModelId) {
                    modelId = customModelId;
                }
            }

            if (!key) {
                showConnectionStatus('error', 'è¯·å…ˆè¾“å…¥API Key');
                return;
            }

            if (!baseUrl) {
                baseUrl = AI_PROVIDERS[provider].baseUrl;
            }

            btn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';
            showConnectionStatus('', '');

            try {
                // åˆ›å»ºæµ‹è¯•é€‚é…å™¨
                const testAdapter = new AIModelAdapter(provider, key, modelId, baseUrl);

                // å‘é€æµ‹è¯•è¯·æ±‚
                await testAdapter.chat([{
                    role: 'user',
                    content: 'æµ‹è¯•è¿æ¥'
                }], { maxTokens: 10 });

                showConnectionStatus('success', `âœ“ è¿æ¥æˆåŠŸ! å‚å•†: ${AI_PROVIDERS[provider].name}, æ¨¡å‹: ${modelId}`);
            } catch (error) {
                showConnectionStatus('error', `âœ— è¿æ¥å¤±è´¥: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'æµ‹è¯•è¿æ¥';
            }
        }

        // ä¿å­˜APIé…ç½®
        function saveAPIConfig() {
            const provider = document.getElementById('apiProvider').value;
            const key = document.getElementById('apiKeyInput').value.trim();
            let baseUrl = document.getElementById('apiBaseUrl').value.trim();
            let modelId = document.getElementById('apiModel').value;

            // å¤„ç†è‡ªå®šä¹‰æ¨¡å‹ID
            if (provider === 'openai') {
                const customModelId = document.getElementById('customModelId').value.trim();
                if (customModelId) {
                    modelId = customModelId;
                }
            }

            if (!key) {
                alert('è¯·è¾“å…¥API Key');
                return;
            }

            if (!baseUrl) {
                baseUrl = AI_PROVIDERS[provider].baseUrl;
            }

            // ä¿å­˜åˆ°localStorage (ä½¿ç”¨æ–°çš„é”®å)
            localStorage.setItem('aiProvider', provider);
            localStorage.setItem('aiApiKey', key);
            localStorage.setItem('aiBaseUrl', baseUrl);
            localStorage.setItem('aiModel', modelId);

            // ä¿ç•™æ—§çš„é”®åä»¥ä¿æŒå…¼å®¹æ€§
            if (provider === 'claude') {
                localStorage.setItem('claudeApiKey', key);
                localStorage.setItem('claudeApiBaseUrl', baseUrl);
                localStorage.setItem('claudeApiModel', modelId);
            }

            // æ›´æ–°å…¨å±€å˜é‡
            currentProvider = provider;
            apiKey = key;
            apiBaseUrl = baseUrl;
            apiModel = modelId;

            // åˆå§‹åŒ–é€‚é…å™¨
            apiAdapter = new AIModelAdapter(provider, key, modelId, baseUrl);

            alert(`AIé…ç½®å·²ä¿å­˜ï¼\nå‚å•†: ${AI_PROVIDERS[provider].name}\næ¨¡å‹: ${modelId}`);

            // å…³é—­æ¨¡æ€æ¡†
            document.getElementById('apiModal').classList.remove('show');
        }

        // åŠ è½½APIé…ç½®
        function loadAPIConfig() {
            // ä¼˜å…ˆä»ä¸»é¡µé¢çš„ç»Ÿä¸€é…ç½®è¯»å–
            let provider = null;
            let key = null;
            let baseUrl = null;
            let modelId = null;

            try {
                const globalConfig = localStorage.getItem('mathHelper_aiConfig');
                if (globalConfig) {
                    const config = JSON.parse(globalConfig);
                    provider = config.provider;
                    key = config.apiKey;
                    baseUrl = config.baseUrl;
                    modelId = config.modelId;
                    console.log('ä½¿ç”¨ä¸»é¡µé¢ç»Ÿä¸€é…ç½®');
                }
            } catch (e) {
                console.warn('è¯»å–ä¸»é¡µé¢é…ç½®å¤±è´¥:', e);
            }

            // å¦‚æœæ²¡æœ‰ä¸»é¡µé¢é…ç½®ï¼Œå›é€€åˆ°æœ¬é¡µé¢çš„æ—§é…ç½®
            if (!provider) {
                provider = localStorage.getItem('aiProvider');
                key = localStorage.getItem('aiApiKey');
                baseUrl = localStorage.getItem('aiBaseUrl');
                modelId = localStorage.getItem('aiModel');
            }

            // å¦‚æœè¿˜æ²¡æœ‰é…ç½®ï¼Œå°è¯•ä»æ›´æ—§çš„Claudeé…ç½®è¿ç§»
            if (!provider && localStorage.getItem('claudeApiKey')) {
                provider = 'claude';
                key = localStorage.getItem('claudeApiKey');
                baseUrl = localStorage.getItem('claudeApiBaseUrl') || 'https://api.anthropic.com';
                modelId = localStorage.getItem('claudeApiModel') || 'claude-sonnet-4-5-20250929';
            }

            // è®¾ç½®é»˜è®¤å€¼
            if (!provider) provider = 'claude';

            // æ›´æ–°UIï¼ˆåªè¯»æ¨¡å¼ï¼‰
            document.getElementById('apiProvider').value = provider;
            updateModelList(provider);
            updateBaseUrl(provider);

            if (key) {
                document.getElementById('apiKeyInput').value = key;
            }

            if (baseUrl) {
                document.getElementById('apiBaseUrl').value = baseUrl;
            }

            if (modelId) {
                document.getElementById('apiModel').value = modelId;

                // å¦‚æœæ˜¯OpenAIå…¼å®¹ä¸”æ˜¯è‡ªå®šä¹‰æ¨¡å‹ï¼Œå¡«å……åˆ°è‡ªå®šä¹‰è¾“å…¥æ¡†
                if (provider === 'openai' && modelId !== 'custom') {
                    document.getElementById('customModelId').value = modelId;
                }
            }

            // åˆå§‹åŒ–å…¨å±€å˜é‡å’Œé€‚é…å™¨
            if (key) {
                currentProvider = provider;
                apiKey = key;
                apiBaseUrl = baseUrl || AI_PROVIDERS[provider].baseUrl;
                apiModel = modelId || AI_PROVIDERS[provider].models[0].id;

                apiAdapter = new AIModelAdapter(currentProvider, apiKey, apiModel, apiBaseUrl);
            }

            updateAPIStatus();
        }

        // æ›´æ–°APIçŠ¶æ€æ˜¾ç¤º
        function updateAPIStatus() {
            const statusSpan = document.getElementById('apiStatus');
            if (apiKey) {
                statusSpan.textContent = 'å·²é…ç½®';
                statusSpan.className = 'api-status active';
            } else {
                statusSpan.textContent = 'æœªé…ç½®';
                statusSpan.className = 'api-status inactive';
            }
        }

        // ========== æ¢é¢˜åŠŸèƒ½ ==========

        // æ¢é¢˜åŠŸèƒ½
        async function refreshQuestion(index) {
            const question = questions[index];
            const btn = event.target;

            if (!apiKey) {
                alert('è¯·å…ˆé…ç½®Claude API Key');
                document.getElementById('apiModal').classList.add('show');
                return;
            }

            // è®¾ç½®åŠ è½½çŠ¶æ€
            btn.disabled = true;
            btn.classList.add('loading');
            btn.innerHTML = 'ç”Ÿæˆä¸­...';

            try {
                // æ„å»ºé¢˜å‹æè¿°
                let typeDesc = '';
                if (question.type === 'choice') {
                    typeDesc = 'é€‰æ‹©é¢˜ï¼ˆåŒ…å«Aã€Bã€Cã€Då››ä¸ªé€‰é¡¹ï¼‰';
                } else if (question.type === 'blank') {
                    typeDesc = 'å¡«ç©ºé¢˜';
                } else {
                    typeDesc = 'è§£ç­”é¢˜ï¼ˆéœ€è¦è¯¦ç»†çš„è§£é¢˜æ­¥éª¤ï¼‰';
                }

                // æ„å»ºå­¦ç§‘æè¿°
                const subjectMap = {
                    'calculus': 'å¾®ç§¯åˆ†',
                    'linear': 'çº¿æ€§ä»£æ•°',
                    'probability': 'æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡'
                };
                const subjectDesc = subjectMap[question.subject] || 'æ•°å­¦';

                // æ„å»ºprompt
                const prompt = `è¯·ç”Ÿæˆä¸€é“è€ƒç ”æ•°å­¦ä¸€çš„${typeDesc}ï¼Œå­¦ç§‘åˆ†ç±»ä¸º${subjectDesc}ï¼Œéš¾åº¦ä¸ä»¥ä¸‹é¢˜ç›®ç›¸å½“ï¼š

ã€åŸé¢˜ã€‘
${question.question}
${question.options ? '\né€‰é¡¹ï¼š\n' + question.options.join('\n') : ''}

ã€è¦æ±‚ã€‘
1. é¢˜ç›®æ ¼å¼ä¸åŸé¢˜å®Œå…¨ä¸€è‡´
2. éš¾åº¦ç›¸å½“ï¼ŒçŸ¥è¯†ç‚¹ç›¸ä¼¼ä½†ä¸å®Œå…¨ç›¸åŒ
3. ä½¿ç”¨LaTeXæ•°å­¦å…¬å¼ï¼ˆç”¨$...$åŒ…è£¹è¡Œå†…å…¬å¼ï¼Œç”¨$$...$$åŒ…è£¹ç‹¬ç«‹å…¬å¼ï¼‰
4. å¿…é¡»åŒ…å«ç­”æ¡ˆå’Œç®€è¦è§£æ

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼ˆä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ï¼‰ï¼š
\`\`\`json
{
  "question": "é¢˜ç›®å†…å®¹ï¼ˆä½¿ç”¨LaTeXå…¬å¼ï¼‰",
  ${question.type === 'choice' ? '"options": ["A. é€‰é¡¹1", "B. é€‰é¡¹2", "C. é€‰é¡¹3", "D. é€‰é¡¹4"],' : ''}
  "answer": "${question.type === 'choice' ? 'Aæˆ–Bæˆ–Cæˆ–D' : 'ç­”æ¡ˆå†…å®¹'}",
  "explanation": "è§£æå†…å®¹ï¼ˆä½¿ç”¨LaTeXå…¬å¼ï¼‰"
}
\`\`\``;

                // è°ƒç”¨API
                const response = await callClaudeAPI([{
                    role: 'user',
                    content: prompt
                }], 2500);

                // è§£æå“åº”
                const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);
                if (!jsonMatch) {
                    throw new Error('AIå“åº”æ ¼å¼é”™è¯¯ï¼Œè¯·é‡è¯•');
                }

                const newQuestion = JSON.parse(jsonMatch[1]);

                // éªŒè¯ç”Ÿæˆçš„é¢˜ç›®
                if (!newQuestion.question || !newQuestion.answer || !newQuestion.explanation) {
                    throw new Error('ç”Ÿæˆçš„é¢˜ç›®ä¸å®Œæ•´ï¼Œè¯·é‡è¯•');
                }

                if (question.type === 'choice' && (!newQuestion.options || newQuestion.options.length !== 4)) {
                    throw new Error('é€‰æ‹©é¢˜é€‰é¡¹ä¸å®Œæ•´ï¼Œè¯·é‡è¯•');
                }

                // æ›´æ–°é¢˜ç›®æ•°æ®
                questions[index].question = newQuestion.question;
                questions[index].answer = newQuestion.answer;
                questions[index].explanation = newQuestion.explanation;
                if (question.type === 'choice') {
                    questions[index].options = newQuestion.options;
                }

                // æ¸…ç©ºç”¨æˆ·ç­”æ¡ˆå’ŒAIè§£æ
                userAnswers[index] = '';
                aiExplanations[index] = null;

                // é‡æ–°æ¸²æŸ“é¢˜ç›®
                const questionDiv = document.getElementById(`question-${index}`);
                const qNumber = parseInt(questionDiv.querySelector('.question-title').textContent.match(/^\d+/)[0]);

                questionDiv.querySelector('.question-title').innerHTML = `${qNumber}. ${newQuestion.question}`;

                // é‡æ–°æ¸²æŸ“å†…å®¹åŒºåŸŸ
                const contentDiv = document.getElementById(`content-${index}`);
                contentDiv.innerHTML = '';

                if (question.type === 'choice') {
                    renderChoiceQuestion(contentDiv, question, index);
                } else if (question.type === 'blank') {
                    renderBlankQuestion(contentDiv, question, index);
                } else {
                    renderSolveQuestion(contentDiv, question, index);
                }

                // æ›´æ–°è§£æåŒºåŸŸ
                document.getElementById(`explanation-${index}`).innerHTML = `
                    <div class="explanation-title">ç­”æ¡ˆä¸è§£æï¼š</div>
                    <div><strong>ç­”æ¡ˆï¼š</strong>${newQuestion.answer}</div>
                    <div style="margin-top: 10px;"><strong>è§£æï¼š</strong>${newQuestion.explanation}</div>
                `;
                document.getElementById(`explanation-${index}`).classList.remove('show');

                // æ¸…ç©ºAIè§£æåŒºåŸŸ
                document.getElementById(`ai-explanation-${index}`).innerHTML = '';
                document.getElementById(`ai-explanation-${index}`).classList.remove('show');

                // é‡æ–°æ¸²æŸ“æ•°å­¦å…¬å¼
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([questionDiv]).catch((err) => console.log('MathJax error:', err));
                }

                // ä¿å­˜åˆ°localStorage
                saveToStorage();
                updateStats();
                updateAnswerCard();

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = 'ğŸ”„ æ¢é¢˜';

            } catch (error) {
                console.error('æ¢é¢˜å¤±è´¥:', error);
                alert(`æ¢é¢˜å¤±è´¥ï¼š${error.message}`);

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = 'ğŸ”„ æ¢é¢˜';
            }
        }

        // ========== æ‰¹é‡æ¢é¢˜åŠŸèƒ½ ==========

        // æ‰¹é‡æ¢é¢˜ä¸»å‡½æ•°
        async function batchRefreshAllQuestions() {
            if (!apiKey) {
                alert('è¯·å…ˆé…ç½®AI API Key');
                document.getElementById('apiModal').classList.add('show');
                return;
            }

            if (batchRefreshInProgress) {
                alert('æ­£åœ¨æ¢é¢˜ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }

            if (!confirm('ç¡®å®šè¦æ›´æ¢æ‰€æœ‰é¢˜ç›®å—ï¼Ÿ\nè¿™å°†ç”Ÿæˆä¸€å¥—å…¨æ–°çš„è¯•å·ï¼Œå½“å‰ç­”æ¡ˆå°†è¢«æ¸…ç©ºã€‚\n\næç¤ºï¼šæ¢é¢˜è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚')) {
                return;
            }

            // åˆå§‹åŒ–çŠ¶æ€
            batchRefreshInProgress = true;
            batchRefreshCancelled = false;

            // æ˜¾ç¤ºè¿›åº¦æ¨¡æ€æ¡†
            showBatchProgressModal();

            const totalQuestions = questions.length;
            let successCount = 0;
            let failCount = 0;
            let errorMessages = [];

            try {
                for (let i = 0; i < totalQuestions; i++) {
                    // æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
                    if (batchRefreshCancelled) {
                        updateBatchProgress(i, totalQuestions, `å·²å–æ¶ˆæ¢é¢˜ (å·²å®Œæˆ ${successCount} é¢˜)`);
                        updateBatchStatus('æ¢é¢˜å·²å–æ¶ˆ', 'error');
                        break;
                    }

                    // æ›´æ–°è¿›åº¦
                    const questionNum = i + 1;
                    const questionType = questions[i].type === 'choice' ? 'é€‰æ‹©é¢˜' :
                                        (questions[i].type === 'blank' ? 'å¡«ç©ºé¢˜' : 'è§£ç­”é¢˜');
                    updateBatchProgress(i, totalQuestions, `æ­£åœ¨ç”Ÿæˆç¬¬ ${questionNum}/${totalQuestions} é¢˜ (${questionType})...`);
                    updateBatchStatus(`æ­£åœ¨å¤„ç†...`);

                    try {
                        // è°ƒç”¨å•é¢˜æ¢é¢˜å‡½æ•°ï¼ˆå†…éƒ¨å®ç°ï¼‰
                        await refreshQuestionSilent(i);
                        successCount++;
                        updateBatchStatus(`âœ“ ç¬¬ ${questionNum} é¢˜ç”ŸæˆæˆåŠŸ`);
                    } catch (error) {
                        failCount++;
                        errorMessages.push(`ç¬¬ ${questionNum} é¢˜å¤±è´¥: ${error.message}`);
                        updateBatchStatus(`âœ— ç¬¬ ${questionNum} é¢˜ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
                    }

                    // æ·»åŠ å»¶è¿Ÿï¼Œé¿å…APIé€Ÿç‡é™åˆ¶
                    if (i < totalQuestions - 1 && !batchRefreshCancelled) {
                        await sleep(1500); // 1.5ç§’é—´éš”
                    }
                }

                // å®Œæˆ
                if (!batchRefreshCancelled) {
                    updateBatchProgress(totalQuestions, totalQuestions, 'æ¢é¢˜å®Œæˆï¼');

                    if (failCount === 0) {
                        updateBatchStatus(`âœ“ å…¨éƒ¨ ${successCount} é“é¢˜ç›®ç”ŸæˆæˆåŠŸï¼`, 'success');
                    } else {
                        updateBatchStatus(`å®Œæˆ: ${successCount} æˆåŠŸ, ${failCount} å¤±è´¥\n${errorMessages.join('\n')}`, failCount > successCount ? 'error' : '');
                    }
                }

                // é‡æ–°æ¸²æŸ“æ‰€æœ‰é¢˜ç›®
                renderQuestions();
                renderAnswerCard();
                updateStats();

                // é‡æ–°æ¸²æŸ“æ•°å­¦å…¬å¼
                if (window.MathJax && window.MathJax.typesetPromise) {
                    setTimeout(() => {
                        MathJax.typesetPromise().catch((err) => console.log('MathJax error:', err));
                    }, 100);
                }

            } catch (error) {
                console.error('æ‰¹é‡æ¢é¢˜å¤±è´¥:', error);
                updateBatchStatus(`æ¢é¢˜è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
            } finally {
                batchRefreshInProgress = false;
                showBatchCloseButton();
            }
        }

        // é™é»˜æ¢é¢˜ï¼ˆä¸æ˜¾ç¤ºå•é¢˜çš„æç¤ºï¼‰
        async function refreshQuestionSilent(index) {
            const question = questions[index];

            // æ„å»ºé¢˜å‹æè¿°
            let typeDesc = '';
            if (question.type === 'choice') {
                typeDesc = 'é€‰æ‹©é¢˜ï¼ˆåŒ…å«Aã€Bã€Cã€Då››ä¸ªé€‰é¡¹ï¼‰';
            } else if (question.type === 'blank') {
                typeDesc = 'å¡«ç©ºé¢˜';
            } else {
                typeDesc = 'è§£ç­”é¢˜ï¼ˆéœ€è¦è¯¦ç»†çš„è§£é¢˜æ­¥éª¤ï¼‰';
            }

            // æ„å»ºå­¦ç§‘æè¿°
            const subjectMap = {
                'calculus': 'å¾®ç§¯åˆ†',
                'linear': 'çº¿æ€§ä»£æ•°',
                'probability': 'æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡'
            };
            const subjectDesc = subjectMap[question.subject] || 'æ•°å­¦';

            // æ„å»ºprompt
            const prompt = `è¯·ç”Ÿæˆä¸€é“è€ƒç ”æ•°å­¦ä¸€çš„${typeDesc}ï¼Œå­¦ç§‘åˆ†ç±»ä¸º${subjectDesc}ï¼Œéš¾åº¦ä¸ä»¥ä¸‹é¢˜ç›®ç›¸å½“ï¼š

ã€åŸé¢˜ã€‘
${question.question}
${question.options ? '\né€‰é¡¹ï¼š\n' + question.options.join('\n') : ''}

ã€è¦æ±‚ã€‘
1. é¢˜ç›®æ ¼å¼ä¸åŸé¢˜å®Œå…¨ä¸€è‡´
2. éš¾åº¦ç›¸å½“ï¼ŒçŸ¥è¯†ç‚¹ç›¸ä¼¼ä½†ä¸å®Œå…¨ç›¸åŒ
3. ä½¿ç”¨LaTeXæ•°å­¦å…¬å¼ï¼ˆç”¨$...$åŒ…è£¹è¡Œå†…å…¬å¼ï¼Œç”¨$$...$$åŒ…è£¹ç‹¬ç«‹å…¬å¼ï¼‰
4. å¿…é¡»åŒ…å«ç­”æ¡ˆå’Œç®€è¦è§£æ

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼ˆä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ï¼‰ï¼š
\`\`\`json
{
  "question": "é¢˜ç›®å†…å®¹ï¼ˆä½¿ç”¨LaTeXå…¬å¼ï¼‰",
  ${question.type === 'choice' ? '"options": ["A. é€‰é¡¹1", "B. é€‰é¡¹2", "C. é€‰é¡¹3", "D. é€‰é¡¹4"],' : ''}
  "answer": "${question.type === 'choice' ? 'Aæˆ–Bæˆ–Cæˆ–D' : 'ç­”æ¡ˆå†…å®¹'}",
  "explanation": "è§£æå†…å®¹ï¼ˆä½¿ç”¨LaTeXå…¬å¼ï¼‰"
}
\`\`\``;

            // è°ƒç”¨API
            const response = await callClaudeAPI([{
                role: 'user',
                content: prompt
            }], 2500);

            // è§£æå“åº”
            const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);
            if (!jsonMatch) {
                throw new Error('AIå“åº”æ ¼å¼é”™è¯¯');
            }

            const newQuestion = JSON.parse(jsonMatch[1]);

            // éªŒè¯ç”Ÿæˆçš„é¢˜ç›®
            if (!newQuestion.question || !newQuestion.answer || !newQuestion.explanation) {
                throw new Error('ç”Ÿæˆçš„é¢˜ç›®ä¸å®Œæ•´');
            }

            if (question.type === 'choice' && (!newQuestion.options || newQuestion.options.length !== 4)) {
                throw new Error('é€‰æ‹©é¢˜é€‰é¡¹ä¸å®Œæ•´');
            }

            // æ›´æ–°é¢˜ç›®æ•°æ®
            questions[index].question = newQuestion.question;
            questions[index].answer = newQuestion.answer;
            questions[index].explanation = newQuestion.explanation;
            if (question.type === 'choice') {
                questions[index].options = newQuestion.options;
            }

            // æ¸…ç©ºç”¨æˆ·ç­”æ¡ˆå’ŒAIè§£æ
            userAnswers[index] = '';
            aiExplanations[index] = null;

            // ä¿å­˜åˆ°localStorage
            saveToStorage();

            // å®æ—¶æ›´æ–°é¡µé¢ä¸Šçš„å•ä¸ªé¢˜ç›®
            updateSingleQuestion(index);
        }

        // å®æ—¶æ›´æ–°å•ä¸ªé¢˜ç›®çš„æ˜¾ç¤ºï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªè¯•å·ï¼‰
        function updateSingleQuestion(index) {
            const q = questions[index];
            const qDiv = document.getElementById(`question-${index}`);
            if (!qDiv) return;

            // è®¡ç®—é¢˜ç›®ç¼–å·
            let qNumber;
            if (q.type === 'choice') {
                qNumber = index < 8 ? index + 1 : 0;
            } else if (q.type === 'blank') {
                qNumber = index >= 8 && index < 14 ? index - 7 : 0;
            } else {
                qNumber = index >= 14 ? index - 13 : 0;
            }

            // æ›´æ–°é¢˜ç›®æ ‡é¢˜
            const titleDiv = qDiv.querySelector('.question-title');
            if (titleDiv) {
                titleDiv.innerHTML = `${qNumber}. ${q.question}`;
            }

            // æ›´æ–°ç­”æ¡ˆä¸è§£æ
            const explanationDiv = qDiv.querySelector(`#explanation-${index}`);
            if (explanationDiv) {
                explanationDiv.innerHTML = `
                    <div class="explanation-title">ç­”æ¡ˆä¸è§£æï¼š</div>
                    <div><strong>ç­”æ¡ˆï¼š</strong>${q.answer}</div>
                    <div style="margin-top: 10px;"><strong>è§£æï¼š</strong>${q.explanation}</div>
                `;
            }

            // æ›´æ–°é¢˜ç›®å†…å®¹åŒºåŸŸ
            const contentDiv = document.getElementById(`content-${index}`);
            if (contentDiv) {
                contentDiv.innerHTML = '';
                if (q.type === 'choice') {
                    renderChoiceQuestion(contentDiv, q, index);
                } else if (q.type === 'blank') {
                    renderBlankQuestion(contentDiv, q, index);
                } else if (q.type === 'solve') {
                    renderSolveQuestion(contentDiv, q, index);
                }
            }

            // æ¸…ç©ºAIè§£ææ˜¾ç¤º
            const aiExplanationDiv = document.getElementById(`ai-explanation-${index}`);
            if (aiExplanationDiv) {
                aiExplanationDiv.innerHTML = '';
            }

            // é‡æ–°æ¸²æŸ“æ•°å­¦å…¬å¼ï¼ˆåªé’ˆå¯¹è¿™ä¸€é¢˜ï¼‰
            setTimeout(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([qDiv]).catch((err) => console.log('MathJax error:', err));
                }
            }, 50);
        }

        // æ˜¾ç¤ºæ‰¹é‡æ¢é¢˜è¿›åº¦æ¨¡æ€æ¡†
        function showBatchProgressModal() {
            const modal = document.getElementById('batchProgressModal');
            const progressBar = document.getElementById('batchProgressBar');
            const cancelBtn = document.getElementById('batchCancelBtn');
            const closeBtn = document.getElementById('batchCloseBtn');

            modal.classList.add('show');
            progressBar.style.width = '0%';
            cancelBtn.style.display = 'inline-block';
            closeBtn.style.display = 'none';
        }

        // éšè—æ‰¹é‡æ¢é¢˜è¿›åº¦æ¨¡æ€æ¡†
        function hideBatchProgressModal() {
            const modal = document.getElementById('batchProgressModal');
            modal.classList.remove('show');
        }

        // æ›´æ–°æ‰¹é‡æ¢é¢˜è¿›åº¦
        function updateBatchProgress(current, total, text) {
            const progressBar = document.getElementById('batchProgressBar');
            const progressText = document.getElementById('batchProgressText');

            const percent = Math.round((current / total) * 100);
            progressBar.style.width = `${percent}%`;
            progressText.textContent = text;
        }

        // æ›´æ–°æ‰¹é‡æ¢é¢˜çŠ¶æ€
        function updateBatchStatus(message, type = '') {
            const statusDiv = document.getElementById('batchProgressStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'batch-progress-status';
            if (type) {
                statusDiv.classList.add(type);
            }
        }

        // æ˜¾ç¤ºå®ŒæˆæŒ‰é’®
        function showBatchCloseButton() {
            const cancelBtn = document.getElementById('batchCancelBtn');
            const closeBtn = document.getElementById('batchCloseBtn');

            cancelBtn.style.display = 'none';
            closeBtn.style.display = 'inline-block';
        }

        // å–æ¶ˆæ‰¹é‡æ¢é¢˜
        function cancelBatchRefresh() {
            batchRefreshCancelled = true;
            updateBatchStatus('æ­£åœ¨å–æ¶ˆ...');
        }

        // sleepè¾…åŠ©å‡½æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ========== AIè§£æåŠŸèƒ½ ==========

        // ç”ŸæˆAIè§£æ
        async function generateAIExplanation(index) {
            const question = questions[index];
            const aiBtn = document.getElementById(`ai-btn-${index}`);
            const aiExplanationDiv = document.getElementById(`ai-explanation-${index}`);

            if (!apiKey) {
                alert('è¯·å…ˆé…ç½®Claude API Key');
                document.getElementById('apiModal').classList.add('show');
                return;
            }

            // å¦‚æœå·²ç»æœ‰AIè§£æï¼Œè¯¢é—®æ˜¯å¦é‡æ–°ç”Ÿæˆ
            if (aiExplanations[index]) {
                if (!confirm('å·²æœ‰AIè§£æï¼Œæ˜¯å¦é‡æ–°ç”Ÿæˆï¼Ÿ')) {
                    return;
                }
            }

            // è®¾ç½®åŠ è½½çŠ¶æ€
            aiBtn.disabled = true;
            aiBtn.classList.add('loading');
            aiBtn.innerHTML = 'ç”Ÿæˆä¸­...';

            try {
                // æ„å»ºprompt
                let questionText = question.question;
                if (question.type === 'choice' && question.options) {
                    questionText += '\n\né€‰é¡¹ï¼š\n' + question.options.join('\n');
                }

                const prompt = `ä½œä¸ºä¸€ä½ç»éªŒä¸°å¯Œçš„è€ƒç ”æ•°å­¦è¾…å¯¼è€å¸ˆï¼Œè¯·ä¸ºä»¥ä¸‹é¢˜ç›®æä¾›è¯¦ç»†çš„è§£æã€‚

ã€é¢˜ç›®ã€‘
${questionText}

ã€æ ‡å‡†ç­”æ¡ˆã€‘
${question.answer}

ã€æ ‡å‡†è§£æã€‘
${question.explanation}

ã€è¦æ±‚ã€‘
è¯·æä¾›æ›´åŠ è¯¦ç»†å’Œæ•™å­¦åŒ–çš„è§£æï¼Œå¸®åŠ©å­¦ç”ŸçœŸæ­£ç†è§£è¿™é“é¢˜ç›®ã€‚ä½¿ç”¨LaTeXæ ¼å¼ä¹¦å†™æ•°å­¦å…¬å¼ï¼ˆç”¨$...$åŒ…è£¹è¡Œå†…å…¬å¼ï¼Œç”¨$$...$$åŒ…è£¹ç‹¬ç«‹å…¬å¼ï¼‰ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼ˆä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ï¼‰ï¼š
\`\`\`json
{
  "knowledge": "æœ¬é¢˜è€ƒæŸ¥çš„æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼ˆç®€æ˜æ‰¼è¦ï¼‰",
  "thinking": "è§£é¢˜çš„å…³é”®æ€è·¯å’Œåˆ‡å…¥ç‚¹ï¼ˆ1-2å¥è¯ï¼‰",
  "steps": "è¯¦ç»†çš„è§£é¢˜æ­¥éª¤ï¼ˆä½¿ç”¨LaTeXå…¬å¼ï¼Œåˆ†å¤šä¸ªè‡ªç„¶æ®µï¼‰",
  "pitfalls": "å­¦ç”Ÿå®¹æ˜“å‡ºé”™çš„åœ°æ–¹å’Œæ³¨æ„äº‹é¡¹",
  "extension": "ç›¸å…³çŸ¥è¯†ç‚¹çš„æ‹“å±•å’Œè¡¥å……ï¼ˆå¯é€‰ï¼‰"
}
\`\`\``;

                // è°ƒç”¨API
                const response = await callClaudeAPI([{
                    role: 'user',
                    content: prompt
                }], 3000);

                // è§£æå“åº”
                const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);
                if (!jsonMatch) {
                    throw new Error('AIå“åº”æ ¼å¼é”™è¯¯ï¼Œè¯·é‡è¯•');
                }

                const aiExplanation = JSON.parse(jsonMatch[1]);

                // ä¿å­˜AIè§£æ
                aiExplanations[index] = aiExplanation;

                // æ¸²æŸ“AIè§£æ
                aiExplanationDiv.innerHTML = `
                    <div class="ai-explanation-title">
                        <span>ğŸ¤– AIè¯¦ç»†è§£æ</span>
                    </div>
                    <div class="ai-explanation-section">
                        <div class="ai-explanation-section-title">ğŸ“š çŸ¥è¯†ç‚¹</div>
                        <div class="ai-explanation-section-content">${aiExplanation.knowledge}</div>
                    </div>
                    <div class="ai-explanation-section">
                        <div class="ai-explanation-section-title">ğŸ’¡ è§£é¢˜æ€è·¯</div>
                        <div class="ai-explanation-section-content">${aiExplanation.thinking}</div>
                    </div>
                    <div class="ai-explanation-section">
                        <div class="ai-explanation-section-title">ğŸ“ è¯¦ç»†æ­¥éª¤</div>
                        <div class="ai-explanation-section-content">${aiExplanation.steps}</div>
                    </div>
                    <div class="ai-explanation-section">
                        <div class="ai-explanation-section-title">âš ï¸ æ˜“é”™ç‚¹</div>
                        <div class="ai-explanation-section-content">${aiExplanation.pitfalls}</div>
                    </div>
                    ${aiExplanation.extension ? `
                    <div class="ai-explanation-section">
                        <div class="ai-explanation-section-title">ğŸ” çŸ¥è¯†æ‹“å±•</div>
                        <div class="ai-explanation-section-content">${aiExplanation.extension}</div>
                    </div>
                    ` : ''}
                `;

                // æ˜¾ç¤ºAIè§£æ
                aiExplanationDiv.classList.add('show');

                // é‡æ–°æ¸²æŸ“æ•°å­¦å…¬å¼
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([aiExplanationDiv]).catch((err) => console.log('MathJax error:', err));
                }

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                aiBtn.disabled = false;
                aiBtn.classList.remove('loading');
                aiBtn.innerHTML = 'ğŸ”„ é‡æ–°ç”ŸæˆAIè§£æ';

            } catch (error) {
                console.error('ç”ŸæˆAIè§£æå¤±è´¥:', error);
                alert(`ç”ŸæˆAIè§£æå¤±è´¥ï¼š${error.message}`);

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                aiBtn.disabled = false;
                aiBtn.classList.remove('loading');
                aiBtn.innerHTML = 'âœ¨ è·å–AIè§£æ';
            }
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            loadFromStorage();
            loadAPIConfig();
            renderQuestions();
            renderAnswerCard();
            startTimer();
            updateStats();

            document.getElementById('modeSwitch').addEventListener('click', toggleMode);
            document.getElementById('submitBtn').addEventListener('click', submitExam);
            document.getElementById('resetBtn').addEventListener('click', resetExam);

            // APIé…ç½®ç›¸å…³äº‹ä»¶ç›‘å¬
            document.getElementById('apiSettingsBtn').addEventListener('click', () => {
                document.getElementById('apiModal').classList.add('show');
            });

            document.getElementById('cancelApiBtn').addEventListener('click', () => {
                document.getElementById('apiModal').classList.remove('show');
            });

            document.getElementById('saveApiBtn').addEventListener('click', saveAPIConfig);
            document.getElementById('testConnectionBtn').addEventListener('click', testAPIConnection);

            // æ‰¹é‡æ¢é¢˜äº‹ä»¶ç›‘å¬
            document.getElementById('batchRefreshBtn').addEventListener('click', batchRefreshAllQuestions);
            document.getElementById('batchCancelBtn').addEventListener('click', cancelBatchRefresh);
            document.getElementById('batchCloseBtn').addEventListener('click', hideBatchProgressModal);

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('apiModal').addEventListener('click', (e) => {
                if (e.target.id === 'apiModal') {
                    document.getElementById('apiModal').classList.remove('show');
                }
            });

            // å‚å•†åˆ‡æ¢äº‹ä»¶
            document.getElementById('apiProvider').addEventListener('change', function() {
                const provider = this.value;
                updateModelList(provider);
                updateBaseUrl(provider);
            });

            // æ¨¡å‹åˆ‡æ¢äº‹ä»¶ (æ›´æ–°maxTokensæç¤º)
            document.getElementById('apiModel').addEventListener('change', function() {
                const provider = document.getElementById('apiProvider').value;
                const modelId = this.value;
                const model = AI_PROVIDERS[provider].models.find(m => m.id === modelId);
                if (model) {
                    document.getElementById('modelInfo').textContent = `æœ€å¤§Token: ${model.maxTokens}`;
                }
            });
        };

        // æ¸²æŸ“é¢˜ç›®
        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            let choiceCount = 0, blankCount = 0, solveCount = 0;

            questions.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'question';
                qDiv.id = `question-${index}`;

                // æ·»åŠ åˆ†èŠ‚æ ‡é¢˜
                if (index === 0) {
                    const sectionTitle = document.createElement('div');
                    sectionTitle.className = 'section-title';
                    sectionTitle.textContent = 'ä¸€ã€é€‰æ‹©é¢˜ï¼ˆæ¯é¢˜4åˆ†ï¼Œå…±32åˆ†ï¼‰';
                    container.appendChild(sectionTitle);
                } else if (index === 8) {
                    const sectionTitle = document.createElement('div');
                    sectionTitle.className = 'section-title';
                    sectionTitle.textContent = 'äºŒã€å¡«ç©ºé¢˜ï¼ˆæ¯é¢˜4åˆ†ï¼Œå…±24åˆ†ï¼‰';
                    container.appendChild(sectionTitle);
                } else if (index === 14) {
                    const sectionTitle = document.createElement('div');
                    sectionTitle.className = 'section-title';
                    sectionTitle.textContent = 'ä¸‰ã€è§£ç­”é¢˜ï¼ˆå…±94åˆ†ï¼‰';
                    container.appendChild(sectionTitle);
                }

                // é¢˜ç›®ç¼–å·
                let qNumber;
                if (q.type === 'choice') {
                    choiceCount++;
                    qNumber = choiceCount;
                } else if (q.type === 'blank') {
                    blankCount++;
                    qNumber = blankCount;
                } else {
                    solveCount++;
                    qNumber = solveCount;
                }

                qDiv.innerHTML = `
                    <div class="question-header">
                        <div class="question-title">${qNumber}. ${q.question}</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button class="question-refresh-btn" onclick="refreshQuestion(${index})" title="æ¢ä¸€é“åŒç±»å‹é¢˜ç›®">
                                ğŸ”„ æ¢é¢˜
                            </button>
                            <div class="question-score">(${q.score}åˆ†)</div>
                        </div>
                    </div>
                    <div class="question-content" id="content-${index}"></div>
                    <div class="explanation" id="explanation-${index}">
                        <div class="explanation-title">ç­”æ¡ˆä¸è§£æï¼š</div>
                        <div><strong>ç­”æ¡ˆï¼š</strong>${q.answer}</div>
                        <div style="margin-top: 10px;"><strong>è§£æï¼š</strong>${q.explanation}</div>
                    </div>
                    <div class="ai-explanation-content" id="ai-explanation-${index}"></div>
                `;

                container.appendChild(qDiv);

                // æ ¹æ®é¢˜å‹æ¸²æŸ“ä¸åŒçš„è¾“å…¥æ§ä»¶
                const contentDiv = document.getElementById(`content-${index}`);
                if (q.type === 'choice') {
                    renderChoiceQuestion(contentDiv, q, index);
                } else if (q.type === 'blank') {
                    renderBlankQuestion(contentDiv, q, index);
                } else if (q.type === 'solve') {
                    renderSolveQuestion(contentDiv, q, index);
                }
            });

            // æ¸²æŸ“æ•°å­¦å…¬å¼
            setTimeout(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise().catch((err) => console.log('MathJax error:', err));
                }
            }, 100);
        }

        // æ¸²æŸ“é€‰æ‹©é¢˜
        function renderChoiceQuestion(container, question, index) {
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options';

            question.options.forEach((option, i) => {
                const optionLabel = document.createElement('label');
                optionLabel.className = 'option';
                optionLabel.innerHTML = `
                    <input type="radio" name="question-${index}" value="${String.fromCharCode(65+i)}">
                    ${option}
                `;

                optionLabel.addEventListener('click', function(e) {
                    if (e.target.tagName !== 'INPUT') {
                        const radio = this.querySelector('input[type="radio"]');
                        radio.checked = true;
                    }
                    userAnswers[index] = String.fromCharCode(65+i);
                    saveToStorage();
                    updateStats();
                    updateAnswerCard();

                    // å³æ—¶æ‰¹æ”¹æ¨¡å¼
                    if (currentMode === 'instant' && !isSubmitted) {
                        checkAnswer(index);
                    }

                    // æ›´æ–°é€‰ä¸­æ ·å¼
                    document.querySelectorAll(`input[name="question-${index}"]`).forEach(radio => {
                        radio.parentElement.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });

                optionsDiv.appendChild(optionLabel);
            });

            container.appendChild(optionsDiv);

            // æ·»åŠ AIè§£ææŒ‰é’®
            const aiBtn = document.createElement('button');
            aiBtn.className = 'ai-explanation-btn';
            aiBtn.id = `ai-btn-${index}`;
            aiBtn.innerHTML = 'âœ¨ è·å–AIè§£æ';
            aiBtn.style.marginTop = '15px';
            aiBtn.addEventListener('click', function() {
                generateAIExplanation(index);
            });
            container.appendChild(aiBtn);

            // æ¢å¤ç­”æ¡ˆ
            if (userAnswers[index]) {
                const radio = container.querySelector(`input[value="${userAnswers[index]}"]`);
                if (radio) {
                    radio.checked = true;
                    radio.parentElement.classList.add('selected');
                }
            }
        }

        // æ¸²æŸ“å¡«ç©ºé¢˜
        function renderBlankQuestion(container, question, index) {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'blank-input';
            input.placeholder = 'è¯·è¾“å…¥ç­”æ¡ˆ';
            input.value = userAnswers[index] || '';

            input.addEventListener('input', function() {
                userAnswers[index] = this.value.trim();
                saveToStorage();
                updateStats();
                updateAnswerCard();

                if (currentMode === 'instant' && !isSubmitted && this.value.trim()) {
                    checkAnswer(index);
                }
            });

            container.appendChild(input);

            // æ·»åŠ AIè§£ææŒ‰é’®
            const aiBtn = document.createElement('button');
            aiBtn.className = 'ai-explanation-btn';
            aiBtn.id = `ai-btn-${index}`;
            aiBtn.innerHTML = 'âœ¨ è·å–AIè§£æ';
            aiBtn.style.marginTop = '15px';
            aiBtn.addEventListener('click', function() {
                generateAIExplanation(index);
            });
            container.appendChild(aiBtn);
        }

        // æ¸²æŸ“è§£ç­”é¢˜
        function renderSolveQuestion(container, question, index) {
            const textarea = document.createElement('textarea');
            textarea.className = 'solve-textarea';
            textarea.placeholder = 'è¯·åœ¨æ­¤è¾“å…¥è¯¦ç»†è§£ç­”è¿‡ç¨‹...';
            textarea.value = userAnswers[index] || '';

            textarea.addEventListener('input', function() {
                userAnswers[index] = this.value.trim();
                saveToStorage();
                updateStats();
                updateAnswerCard();
            });

            container.appendChild(textarea);

            // æŒ‰é’®å®¹å™¨
            const btnContainer = document.createElement('div');
            btnContainer.style.marginTop = '10px';

            // æ·»åŠ æŸ¥çœ‹ç­”æ¡ˆæŒ‰é’®
            const viewBtn = document.createElement('button');
            viewBtn.className = 'view-answer-btn';
            viewBtn.textContent = 'æŸ¥çœ‹æ ‡å‡†ç­”æ¡ˆ';
            viewBtn.addEventListener('click', function() {
                const explanation = document.getElementById(`explanation-${index}`);
                explanation.classList.toggle('show');
                this.textContent = explanation.classList.contains('show') ? 'éšè—æ ‡å‡†ç­”æ¡ˆ' : 'æŸ¥çœ‹æ ‡å‡†ç­”æ¡ˆ';
            });
            btnContainer.appendChild(viewBtn);

            // æ·»åŠ AIè§£ææŒ‰é’®
            const aiBtn = document.createElement('button');
            aiBtn.className = 'ai-explanation-btn';
            aiBtn.id = `ai-btn-${index}`;
            aiBtn.innerHTML = 'âœ¨ è·å–AIè§£æ';
            aiBtn.addEventListener('click', function() {
                generateAIExplanation(index);
            });
            btnContainer.appendChild(aiBtn);

            container.appendChild(btnContainer);
        }

        // æ¸²æŸ“ç­”é¢˜å¡
        function renderAnswerCard() {
            const card = document.getElementById('answerCard');
            card.innerHTML = '';

            questions.forEach((q, index) => {
                const item = document.createElement('div');
                item.className = 'card-item';
                item.textContent = index + 1;
                item.addEventListener('click', () => {
                    document.getElementById(`question-${index}`).scrollIntoView({ behavior: 'smooth' });
                });
                card.appendChild(item);
            });
        }

        // æ›´æ–°ç­”é¢˜å¡çŠ¶æ€
        function updateAnswerCard() {
            questions.forEach((q, index) => {
                const item = document.querySelectorAll('.card-item')[index];
                item.className = 'card-item';

                if (userAnswers[index]) {
                    item.classList.add('answered');
                }

                if (isSubmitted || currentMode === 'instant') {
                    if (userAnswers[index]) {
                        const isCorrect = checkAnswerCorrect(index);
                        if (q.type !== 'solve') {
                            item.classList.add(isCorrect ? 'correct' : 'wrong');
                        }
                    }
                }
            });
        }

        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer(index) {
            const question = questions[index];
            const isCorrect = checkAnswerCorrect(index);

            if (question.type === 'choice') {
                const options = document.querySelectorAll(`input[name="question-${index}"]`);
                options.forEach(option => {
                    const label = option.parentElement;
                    label.classList.remove('correct', 'wrong');

                    if (option.value === question.answer) {
                        label.classList.add('correct');
                    } else if (option.checked && !isCorrect) {
                        label.classList.add('wrong');
                    }
                });

                const explanation = document.getElementById(`explanation-${index}`);
                explanation.classList.add('show');
            } else if (question.type === 'blank') {
                const input = document.querySelector(`#question-${index} .blank-input`);
                input.classList.remove('correct', 'wrong');
                if (userAnswers[index]) {
                    input.classList.add(isCorrect ? 'correct' : 'wrong');
                    const explanation = document.getElementById(`explanation-${index}`);
                    explanation.classList.add('show');
                }
            }

            updateAnswerCard();
        }

        // æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦æ­£ç¡®
        function checkAnswerCorrect(index) {
            const question = questions[index];
            const userAnswer = userAnswers[index];

            if (!userAnswer) return false;

            if (question.type === 'choice') {
                return userAnswer === question.answer;
            } else if (question.type === 'blank') {
                // ç®€åŒ–çš„ç­”æ¡ˆæ¯”è¾ƒï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦æ›´å¤æ‚çš„æ¯”è¾ƒé€»è¾‘
                return normalizeAnswer(userAnswer) === normalizeAnswer(question.answer);
            } else {
                // è§£ç­”é¢˜ä¸è‡ªåŠ¨åˆ¤åˆ†
                return false;
            }
        }

        // æ ‡å‡†åŒ–ç­”æ¡ˆï¼ˆå»é™¤ç©ºæ ¼ã€ç»Ÿä¸€å¤§å°å†™ç­‰ï¼‰
        function normalizeAnswer(answer) {
            return answer.toLowerCase().replace(/\s+/g, '').replace(/\*/g, '');
        }

        // åˆ‡æ¢æ‰¹æ”¹æ¨¡å¼
        function toggleMode() {
            if (isSubmitted) {
                alert('è¯•å·å·²æäº¤ï¼Œæ— æ³•åˆ‡æ¢æ¨¡å¼ã€‚è¯·ç‚¹å‡»"é‡æ–°å¼€å§‹"');
                return;
            }

            currentMode = currentMode === 'instant' ? 'submit' : 'instant';
            const btn = document.getElementById('modeSwitch');
            const indicator = document.getElementById('modeIndicator');

            if (currentMode === 'instant') {
                btn.textContent = 'åˆ‡æ¢åˆ°æäº¤åæ‰¹æ”¹';
                indicator.textContent = 'å³æ—¶æ‰¹æ”¹æ¨¡å¼';
                indicator.style.background = '#4CAF50';

                // æ˜¾ç¤ºæ‰€æœ‰å·²ç­”é¢˜ç›®çš„æ‰¹æ”¹ç»“æœ
                questions.forEach((q, index) => {
                    if (userAnswers[index]) {
                        checkAnswer(index);
                    }
                });
            } else {
                btn.textContent = 'åˆ‡æ¢åˆ°å³æ—¶æ‰¹æ”¹';
                indicator.textContent = 'æäº¤åæ‰¹æ”¹æ¨¡å¼';
                indicator.style.background = '#FF9800';

                // éšè—æ‰€æœ‰æ‰¹æ”¹ç»“æœ
                document.querySelectorAll('.explanation').forEach(el => {
                    el.classList.remove('show');
                });
                document.querySelectorAll('.option').forEach(el => {
                    el.classList.remove('correct', 'wrong');
                });
                document.querySelectorAll('.blank-input').forEach(el => {
                    el.classList.remove('correct', 'wrong');
                });
                updateAnswerCard();
            }
        }

        // æäº¤è¯•å·
        function submitExam() {
            if (isSubmitted) {
                alert('è¯•å·å·²æäº¤ï¼');
                return;
            }

            const answeredCount = userAnswers.filter(a => a !== '').length;
            if (answeredCount < questions.length) {
                if (!confirm(`æ‚¨è¿˜æœ‰ ${questions.length - answeredCount} é“é¢˜æœªä½œç­”ï¼Œç¡®å®šè¦æäº¤å—ï¼Ÿ`)) {
                    return;
                }
            }

            isSubmitted = true;
            clearInterval(timerInterval);

            // è®¡ç®—åˆ†æ•°
            let totalScore = 0;
            questions.forEach((q, index) => {
                if (q.type !== 'solve' && checkAnswerCorrect(index)) {
                    totalScore += q.score;
                }
            });

            // æ˜¾ç¤ºæ‰€æœ‰ç­”æ¡ˆè§£æ
            document.querySelectorAll('.explanation').forEach(el => {
                el.classList.add('show');
            });

            // æ˜¾ç¤ºæ‰¹æ”¹ç»“æœ
            questions.forEach((q, index) => {
                if (q.type !== 'solve') {
                    checkAnswer(index);
                }
            });

            updateAnswerCard();

            // æ˜¾ç¤ºæˆç»©
            document.getElementById('scoreDisplay').textContent = `å®¢è§‚é¢˜å¾—åˆ†ï¼š${totalScore}/66åˆ†`;
            document.getElementById('finalScore').textContent = `${totalScore}/66åˆ†`;
            document.getElementById('scoreItem').style.display = 'flex';

            alert(`æäº¤æˆåŠŸï¼\nå®¢è§‚é¢˜å¾—åˆ†ï¼š${totalScore}/66åˆ†\nè§£ç­”é¢˜éœ€äººå·¥æ‰¹æ”¹\næ€»ç”¨æ—¶ï¼š${document.getElementById('timer').textContent}`);
        }

        // é‡ç½®è¯•å·
        function resetExam() {
            if (!confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿå½“å‰ç­”æ¡ˆå°†å…¨éƒ¨æ¸…ç©ºã€‚')) {
                return;
            }

            userAnswers = new Array(questions.length).fill('');
            isSubmitted = false;
            currentMode = 'instant';
            startTime = Date.now();

            localStorage.removeItem('examAnswers');
            localStorage.removeItem('examMode');
            localStorage.removeItem('examStartTime');

            location.reload();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const answeredCount = userAnswers.filter(a => a !== '').length;
            document.getElementById('answeredCount').textContent = `${answeredCount}/23`;
        }

        // è®¡æ—¶å™¨
        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;

                document.getElementById('timer').textContent =
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToStorage() {
            localStorage.setItem('examAnswers', JSON.stringify(userAnswers));
            localStorage.setItem('examMode', currentMode);
            localStorage.setItem('examStartTime', startTime);
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
        function loadFromStorage() {
            const savedAnswers = localStorage.getItem('examAnswers');
            const savedMode = localStorage.getItem('examMode');
            const savedStartTime = localStorage.getItem('examStartTime');

            if (savedAnswers) {
                userAnswers = JSON.parse(savedAnswers);
            }
            if (savedMode) {
                currentMode = savedMode;
                if (currentMode === 'submit') {
                    document.getElementById('modeSwitch').textContent = 'åˆ‡æ¢åˆ°å³æ—¶æ‰¹æ”¹';
                    document.getElementById('modeIndicator').textContent = 'æäº¤åæ‰¹æ”¹æ¨¡å¼';
                    document.getElementById('modeIndicator').style.background = '#FF9800';
                }
            }
            if (savedStartTime) {
                startTime = parseInt(savedStartTime);
            }
        }

        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', saveToStorage);
    </script>
</body>
</html>

